{% extends 'mediciones/base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}

<!-- FUENTES PREMIUM -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">

<!-- STYLES CONSOLIDATED AT BOTTOM -->

<div class="premium-page-container">
    <div class="d-flex h-100 gap-4">
        <!-- TECH SIDEBAR (SELECTION / NAVIGATION) -->
        <div class="stitch-sidebar" style="width: 380px; flex-shrink: 0;">
            <div class="mb-5 px-2">
                <a href="{% url 'index' %}" class="text-decoration-none small opacity-50 hover-opacity-100 transition-all font-monospace" style="color: var(--stitch-primary);">
                    <i class="ri-arrow-left-up-line"></i> SISTEMA / PANEL
                </a>
                <h1 class="stitch-title mt-2" style="font-size: 1.8rem;">CONTROL TÉCNICO</h1>
                <p class="small opacity-40" style="margin-top: -5px; letter-spacing: 0.1em;">VERIFICACIÓN DE PIEZAS</p>
            </div>

            <!-- OP SEARCH MODULE -->
            <div class="stitch-module p-4 mb-4" style="overflow: visible;">
                <label class="stitch-label" style="display: block; margin-top: 5px;">SEÑAL: BUSCAR OP</label>
                <div class="position-relative mt-2">
                    <input type="text" id="input_op" class="stitch-input" value="{{ query_op|default:'' }}" 
                           placeholder="ESCANEAR OP AQUÍ..." onchange="updateSelection()" 
                           style="font-size: 1rem; font-weight: 700; padding-right: 45px;">
                    <i class="ri-radar-line position-absolute" style="right: 15px; top: 50%; transform: translateY(-50%); color: var(--stitch-primary); font-size: 1.2rem;"></i>
                </div>
                <input type="hidden" id="input_proyecto" value="{% if query_proy %}{{ query_proy }}{% elif planilla %}{{ planilla.proyecto }}{% endif %}">
                <input type="hidden" id="select_proceso" value="{% if query_proc %}{{ query_proc }}{% elif planilla %}{{ planilla.proceso_id }}{% endif %}">
            </div>

            {% if planilla %}
            <!-- PLAN DETAILS MODULE -->
            <div class="stitch-module p-4 mb-4 animate__animated animate__fadeInLeft">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <label class="stitch-label" style="margin: 0;">ESPECIFICACIONES</label>
                    {% if user.is_superuser or user.profile.role == 'CALIDAD' %}
                    <button onclick="eliminarTodaLaOP()" class="btn-stitch-outline p-0" style="width: 32px; height: 32px; border-radius: 6px;" title="LIMPIAR OP">
                        <i class="ri-delete-bin-7-line"></i>
                    </button>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <div class="opacity-50 fw-bold text-uppercase" style="font-size: 0.75rem;">FLUJO PROYECTO</div>
                    <div class="fw-bold mt-1" style="font-size: 1.15rem; color: var(--stitch-primary);">
                        {% if planilla.num_op %}{{ planilla.num_op }} <span class="opacity-30">/</span> {% endif %}{{ planilla.proyecto }}
                    </div>
                </div>
                <div class="mb-0">
                    <div class="opacity-50 fw-bold text-uppercase" style="font-size: 0.75rem;">EMPRESA CLIENTE</div>
                    <div class="fw-bold mt-1" style="font-size: 1.05rem; color: var(--stitch-text);">{{ planilla.cliente.nombre|default:"N/A" }}</div>
                </div>
            </div>

            <!-- UNIT NAVIGATION MODULE -->
            <div class="stitch-module p-4 mb-4 animate__animated animate__fadeInLeft">
                <label class="stitch-label">SELECTOR DE PIEZA</label>
                <div class="d-flex gap-2 align-items-center mb-3">
                    <input type="number" id="input_pieza" class="stitch-input text-center flex-grow-1" value="{{ pieza_actual }}" 
                           onkeydown="if(event.key==='Enter') updatePiece()" min="1" 
                           style="font-size: 1.6rem; font-weight: 800; color: var(--stitch-primary); background: rgba(225, 29, 72, 0.05); border-color: var(--stitch-primary); height: 50px;">
                    {% if user.is_superuser or user.profile.role == 'CALIDAD' %}
                    <button onclick="deletePiece('{{ pieza_actual }}')" class="btn-stitch-outline" style="width: 44px; height: 44px; padding: 0; color: var(--stitch-danger); border-color: rgba(244, 63, 94, 0.3);">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                    {% endif %}
                </div>

                <div class="d-flex flex-wrap gap-2 mb-3">
                    <a href="?proy={{ query_proy }}&op={{ query_op }}&proc={{ query_proc }}&pieza={{ first_p }}" 
                       class="btn-stitch-outline d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; padding: 0;">
                       <i class="ri-skip-back-line"></i>
                    </a>
                    <a href="?proy={{ query_proy }}&op={{ query_op }}&proc={{ query_proc }}&pieza={{ prev_p }}" 
                       class="btn-stitch-outline d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; padding: 0;">
                       <i class="ri-arrow-left-s-line"></i>
                    </a>
                    
                    {% for p_num in piezas_navegacion %}
                    <a href="?proy={{ query_proy }}&op={{ query_op }}&proc={{ query_proc }}&pieza={{ p_num }}" 
                       class="btn-stitch-outline d-flex align-items-center justify-content-center {% if p_num == pieza_actual %}bg-primary border-primary text-white{% endif %}" style="width: 36px; height: 36px; padding: 0; font-weight: 800; font-size: 0.85rem;">
                        {{ p_num }}
                    </a>
                    {% endfor %}

                    <a href="?proy={{ query_proy }}&op={{ query_op }}&proc={{ query_proc }}&pieza={{ next_p }}" 
                       class="btn-stitch-outline d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; padding: 0;">
                       <i class="ri-arrow-right-s-line"></i>
                    </a>
                    <a href="?proy={{ query_proy }}&op={{ query_op }}&proc={{ query_proc }}&pieza={{ last_p }}" 
                       class="btn-stitch-outline d-flex align-items-center justify-content-center" style="width: 36px; height: 36px; padding: 0;">
                       <i class="ri-skip-forward-line"></i>
                    </a>
                </div>

                <button onclick="addNewPiece()" class="btn-stitch-primary mt-1" style="font-size: 0.95rem; padding: 0.8rem;">
                    <i class="ri-add-line"></i> NUEVO NUMERO DE PIEZA
                </button>
            </div>

            <!-- BUFFER NOTES MODULE -->
            <div class="stitch-module p-3 mb-2">
                <label class="stitch-label mb-1">REGISTROS / NOTAS</label>
                <textarea id="texto_observaciones" class="stitch-input" rows="2" 
                           placeholder="INGRESAR NOTAS AQUÍ..."
                           style="font-size: 0.85rem; height: 60px; resize: none; width: 100%; padding: 0.5rem 0.8rem;"
                           onblur="saveObservations()">{{ planilla.observaciones|default:'' }}</textarea>
                <div id="obs_status" style="font-size: 0.6rem; color: var(--stitch-primary); margin-top: 4px; text-align: right; font-family: 'Fira Code'; opacity: 0.7;"></div>
            </div>
            {% endif %}
        </div>

        <!-- MAIN DATA HUB -->
        <div class="flex-grow-1 d-flex flex-column" style="min-width: 0;">
            {% if planilla %}
            <form method="post" id="measurementForm" class="h-100 d-flex flex-column">
                {% csrf_token %}
                
                <!-- HUB HEADER -->
                <div class="d-flex justify-content-between align-items-center mb-5">
                    <div class="d-flex align-items-center gap-4">
                        <div class="stitch-module d-flex align-items-center justify-content-center" style="width: 64px; height: 64px; border-radius: 12px;">
                            <i class="ri-focus-3-line" style="font-size: 2rem; color: var(--stitch-primary);"></i>
                        </div>
                        <div>
                            <h2 class="stitch-title mb-0" style="font-size: 2.25rem;">Centro de Análisis</h2>
                            <div class="opacity-50 small fw-bold mt-1" style="font-family: 'Fira Code'; letter-spacing: 0.05em;">
                                PIEZA {{ pieza_actual }} 
                                <span class="mx-2">|</span> 
                                {% if planilla.num_op %}OP {{ planilla.num_op }}<span class="mx-2">|</span>{% endif %}
                                {{ planilla.articulo.nombre|upper|default:"SIN ARTICULO" }}
                                <span class="mx-2">|</span> 
                                {{ planilla.elemento.nombre|upper|default:"SIN ELEMENTO" }} 
                                <span class="mx-2">-</span> 
                                {{ planilla.proceso.nombre|upper|default:"SIN PROCESO" }}
                            </div>
                        </div>
                    </div>

                    <div class="stitch-module p-3 d-flex align-items-center gap-3">
                        <label class="stitch-label mb-0" style="margin-left: 10px;">DENSIDAD:</label>
                        <select id="pageSizeSelector" class="stitch-input" style="width: 140px; font-size: 0.8rem; height: 40px;" onchange="changePageSize(this.value)">
                            <option value="7">7_NODOS</option>
                            <option value="12">12_NODOS</option>
                            <option value="24">24_PIEZAS / PÁG</option>
                            <option value="all">FLUJO_COMPLETO</option>
                        </select>
                    </div>
                </div>

                <!-- PRECISION TILES STREAM -->
                <div class="stitch-grid" id="measurementGrid">
                    {% for row in rows %}
                    <div class="stitch-tile animate__animated animate__fadeInUp" style="animation-delay: {{ forloop.counter0|add:1 }}0ms;" data-id="{{ row.tolerancia.id }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="stitch-label" style="font-size: 0.6rem; opacity: 0.6; margin-bottom: 2px;">CONTROL</div>
                                <div class="stitch-title" style="font-size: 1.1rem; letter-spacing: 0;">{{ row.tolerancia.control.nombre }}</div>
                                <div class="mt-2">
                                    <a href="{% url 'estadisticas_control' row.tolerancia.id %}" target="_blank" class="text-decoration-none d-flex align-items-center gap-1" style="font-size: 0.65rem; color: var(--stitch-primary); opacity: 0.8; font-weight: 700;">
                                        <i class="ri-bar-chart-2-line"></i> VER ESTADÍSTICAS
                                    </a>
                                </div>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="small fw-bold {% if row.status == 'OK' %}text-success{% elif row.status == 'NOK' %}text-danger{% else %}opacity-25{% endif %}">
                                    {% if row.status == 'OK' %}
                                        <i class="ri-checkbox-circle-fill" style="font-size: 1.2rem;"></i>
                                    {% elif row.status == 'NOK' %}
                                        <i class="ri-close-circle-fill" style="font-size: 1.2rem;"></i>
                                    {% else %}
                                        <i class="ri-subtract-line" style="font-size: 1.2rem;"></i>
                                    {% endif %}
                                </span>
                                <div class="status-flux-dot {% if row.status == 'OK' %}ok{% elif row.status == 'NOK' %}nok{% else %}pending{% endif %}"></div>
                            </div>
                        </div>

                        <div class="d-flex gap-3 align-items-center">
                            <div class="flex-grow-1">
                                <label class="stitch-label text-center">INGRESO VALOR</label>
                                {% if row.tolerancia.control.pnp %}
                                    <select name="valorpnp_{{ row.tolerancia.id }}" class="stitch-input text-center fw-bold" style="height: 52px; font-size: 1.1rem;" onchange="checkStatus(this, 'pnp')">
                                        <option value="" {% if not row.valor %}selected{% endif %}>-</option>
                                        <option value="OK" {% if row.valor == 'OK' %}selected{% endif %}>PASA</option>
                                        <option value="NOK" {% if row.valor == 'NOK' %}selected{% endif %}>FALLA</option>
                                    </select>
                                {% else %}
                                    <input type="number" step="0.001" name="valor_{{ row.tolerancia.id }}" 
                                           value="{% if row.valor is not None %}{{ row.valor|floatformat:3 }}{% endif %}" 
                                           class="stitch-val-input" placeholder="0.000"
                                           onchange="checkStatus(this, 'real')"
                                           data-min="{{ row.tolerancia.minimo|default:'' }}"
                                           data-max="{{ row.tolerancia.maximo|default:'' }}">
                                {% endif %}
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-auto pt-3 border-top" style="border-color: #f1f5f9;">
                            <div class="text-center">
                                <div class="stitch-label" style="font-size: 0.55rem;">MÍN</div>
                                <div class="fw-bold" style="font-size: 0.9rem;">{{ row.tolerancia.minimo|default:"0.000" }}</div>
                            </div>
                            <div class="text-center">
                                <div class="stitch-label" style="font-size: 0.55rem; color: var(--stitch-secondary);">NOMINAL</div>
                                <div class="fw-bold" style="font-size: 0.9rem; color: var(--stitch-secondary);">{{ row.tolerancia.nominal|default:"0.000" }}</div>
                            </div>
                            <div class="text-center">
                                <div class="stitch-label" style="font-size: 0.55rem;">MÁX</div>
                                <div class="fw-bold" style="font-size: 0.9rem;">{{ row.tolerancia.maximo|default:"0.000" }}</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="pagination-footer d-flex justify-content-between align-items-center mt-auto py-3 border-top" id="tablePagination" style="border-color: var(--stitch-border) !important;">
                        <div class="pagination-info opacity-50 fw-bold" style="font-size: 0.75rem; font-family: 'Fira Code';">
                            MOSTRANDO <span id="pag-start" style="color: var(--stitch-primary);">0</span> - <span id="pag-end" style="color: var(--stitch-primary);">0</span> DE <span id="pag-total">0</span> PARÁMETROS
                        </div>
                        <div class="pagination-controls d-flex gap-2">
                            <button type="button" class="btn-stitch-outline" onclick="prevPage()" id="prevBtn" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; padding: 0;">
                                <i class="ri-arrow-left-s-line"></i>
                            </button>
                            <div id="pageNumbers" class="d-flex gap-2 mx-1"></div>
                            <button type="button" class="btn-stitch-outline" onclick="nextPage()" id="nextBtn" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; padding: 0;">
                                <i class="ri-arrow-right-s-line"></i>
                            </button>
                        </div>
                    </div>
                </form>
                {% else %}
                <div class="text-center" style="padding: 10rem 2rem; background: #ffffff; border-radius: 20px; border: 1px dashed var(--stitch-border);">
                    <i class="ri-radar-line animate__animated animate__pulse animate__infinite" style="font-size: 4rem; color: var(--stitch-primary); opacity: 0.3;"></i>
                    <p class="mt-4 text-muted fw-bold" style="letter-spacing: 0.1em;">ESPERANDO SEÑAL: SELECCIONAR PROYECTO Y PROCESO</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- FUENTES INDUSTRIALES (CYBER-TECH) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Fira+Sans:wght@300;400;600;800&family=Outfit:wght@800&display=swap" rel="stylesheet">

<style>
    /* 
       DESIGN SYSTEM: CYBER-INDUSTRIAL PRECISION
       Inspiration: @ui-ux-pro-max + @stitch-ui-design
    */
    :root {
        --stitch-bg: #fffbfb;
        --stitch-surface: #ffffff;
        --stitch-card: #ffffff;
        --stitch-primary: #e11d48;
        --stitch-secondary: #fb7185;
        --stitch-border: rgba(225, 29, 72, 0.08);
        --stitch-text: #1e1b1b;
        --stitch-muted: #7f7171;
        --stitch-success: #10b981;
        --stitch-danger: #e11d48;
        --stitch-glass: rgba(255, 255, 255, 0.7);
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--stitch-bg) !important;
        color: var(--stitch-text);
        overflow-x: hidden;
    }

    .content-wrapper {
        max-width: none !important;
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
    }

    .premium-page-container {
        padding: 1.5rem 2.5rem;
        background: var(--stitch-bg);
        background-image: 
            radial-gradient(circle at 0% 0%, rgba(225, 29, 72, 0.02) 0%, transparent 50%),
            radial-gradient(circle at 100% 100%, rgba(251, 113, 133, 0.02) 0%, transparent 50%);
        height: 100vh;
        overflow: hidden;
    }

    /* STITCH MODULES */
    .stitch-module {
        background: var(--stitch-glass);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--stitch-border);
        border-radius: 24px;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 40px -10px rgba(225, 29, 72, 0.05);
        padding: 1.2rem 1.5rem !important;
    }

    .stitch-module:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 50px -12px rgba(225, 29, 72, 0.1);
        border-color: rgba(225, 29, 72, 0.2);
    }

    /* TYPOGRAPHY */
    /* TYPOGRAPHY */
    .stitch-title {
        font-family: 'Outfit', sans-serif;
        font-weight: 800;
        background: linear-gradient(135deg, var(--stitch-text) 30%, var(--stitch-primary));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -0.02em;
    }

    .stitch-label {
        font-size: 0.65rem;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--stitch-primary);
        margin-bottom: 0.5rem;
        display: block;
        opacity: 0.8;
    }

    /* INPUTS */
    .stitch-input {
        background: #fdf5f5;
        border: 1px solid var(--stitch-border);
        color: var(--stitch-text);
        padding: 0.85rem 1.25rem;
        border-radius: 12px;
        width: 100%;
        transition: all 0.3s;
    }

    .stitch-input:focus {
        background: #ffffff;
        border-color: var(--stitch-primary);
        box-shadow: 0 0 0 4px rgba(225, 29, 72, 0.1);
        outline: none;
    }

    /* TILES GRID (BENTO LAYER) */
    .stitch-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 1.5rem;
        padding: 0.5rem;
        overflow-y: auto;
        height: calc(100vh - 200px);
    }

    .stitch-tile {
        background: #ffffff;
        border: 1px solid #f9ecec;
        border-radius: 20px;
        padding: 1.5rem 2rem;
        transition: all 0.3s;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        box-shadow: 0 2px 4px rgba(225, 29, 72, 0.02);
    }

    .stitch-tile:hover {
        background: #fffafa;
        border-color: var(--stitch-secondary);
        transform: scale(1.005);
        box-shadow: 0 15px 30px -10px rgba(225, 29, 72, 0.1);
    }

    .stitch-val-input {
        background: #fdf5f5;
        border: 2px solid transparent;
        color: var(--stitch-primary);
        text-align: center;
        font-family: 'Fira Code', monospace;
        font-size: 1.5rem;
        font-weight: 800;
        width: 100%;
        height: 52px;
        border-radius: 12px;
        transition: all 0.3s;
    }

    .stitch-val-input:focus {
        background: #ffffff;
        border-color: var(--stitch-primary);
        box-shadow: 0 0 0 4px rgba(225, 29, 72, 0.1);
        outline: none;
    }

    /* STATUS LIGHTS */
    .status-flux-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    .status-flux-dot.ok { background: var(--stitch-success); }
    .status-flux-dot.nok { background: var(--stitch-danger); }
    .status-flux-dot.pending { background: #e5e1e1; }

    /* ACTION BUTTONS */
    .btn-stitch-primary {
        background: var(--stitch-primary);
        color: white;
        border: none;
        padding: 1rem;
        border-radius: 14px;
        font-weight: 700;
        text-transform: uppercase;
        width: 100%;
        box-shadow: 0 8px 20px -5px rgba(225, 29, 72, 0.3);
        transition: all 0.3s;
    }

    .btn-stitch-primary:hover {
        background: #be123c;
        transform: translateY(-2px);
        box-shadow: 0 12px 25px -5px rgba(225, 29, 72, 0.4);
    }

    .btn-stitch-outline {
        background: #ffffff;
        color: var(--stitch-text);
        border: 1px solid var(--stitch-border);
        padding: 0.85rem;
        border-radius: 14px;
        font-weight: 600;
        width: 100%;
        transition: all 0.3s;
    }

    .btn-stitch-outline:hover {
        background: #fffafa;
        border-color: var(--stitch-primary);
        color: var(--stitch-primary);
    }

    /* PIECE BUTTONS */
    .btn-stitch-piece {
        padding: 0.5rem 1rem;
        background: #ffffff;
        border: 1px solid var(--stitch-border);
        border-radius: 10px;
        color: #7f7171;
        text-decoration: none;
        transition: all 0.3s;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .btn-stitch-piece.active {
        background: var(--stitch-primary);
        color: white;
        border-color: var(--stitch-primary);
        box-shadow: 0 4px 12px rgba(225, 29, 72, 0.2);
    }

    /* SIDEBAR */
    .stitch-sidebar {
        width: 320px;
        height: 100vh;
        overflow-y: auto;
        padding-right: 1.5rem;
        border-right: 1px solid var(--stitch-border);
    }

    /* Hide scrollbar */
    .stitch-sidebar::-webkit-scrollbar { display: none; }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // --- PAGINATION LOGIC ---
    let currentPage = 1;
    let pageSize = localStorage.getItem('tablePageSize') || 7;
    let allRows = [];

    function initPagination() {
        const grid = document.getElementById('measurementGrid');
        if (!grid) return;
        
        allRows = Array.from(grid.querySelectorAll('.stitch-tile'));
        const selector = document.getElementById('pageSizeSelector');
        if (selector) selector.value = pageSize;
        
        updateTableDisplay();
    }

    function changePageSize(size) {
        pageSize = size;
        localStorage.setItem('tablePageSize', size);
        currentPage = 1;
        updateTableDisplay();
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            updateTableDisplay();
        }
    }

    function nextPage() {
        const totalPages = pageSize === 'all' ? 1 : Math.ceil(allRows.length / parseInt(pageSize));
        if (currentPage < totalPages) {
            currentPage++;
            updateTableDisplay();
        }
    }

    function goToPage(page) {
        currentPage = page;
        updateTableDisplay();
    }

    function updateTableDisplay() {
        if (allRows.length === 0) return;

        const paginator = document.getElementById('tablePagination');
        const count = parseInt(pageSize);
        const totalRows = allRows.length;

        if (pageSize === 'all' || totalRows <= count) {
            allRows.forEach(row => row.style.setProperty('display', '', 'important'));
            if (paginator) paginator.style.setProperty('display', 'none', 'important');
            return;
        }

        if (paginator) paginator.style.setProperty('display', 'flex', 'important');
        
        const totalPages = Math.ceil(totalRows / count);
        if (currentPage > totalPages) currentPage = totalPages;

        const start = (currentPage - 1) * count;
        const end = Math.min(start + count, totalRows);

        allRows.forEach((row, idx) => {
            if (idx >= start && idx < end) {
                row.style.setProperty('display', '', 'important');
            } else {
                row.style.setProperty('display', 'none', 'important');
            }
        });

        // Update Info
        document.getElementById('pag-start').innerText = start + 1;
        document.getElementById('pag-end').innerText = end;
        document.getElementById('pag-total').innerText = totalRows;

        // Update Controls
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('prevBtn').style.opacity = currentPage === 1 ? '0.5' : '1';
        document.getElementById('nextBtn').disabled = currentPage === totalPages;
        document.getElementById('nextBtn').style.opacity = currentPage === totalPages ? '0.5' : '1';

        // Update Page Numbers
        const numbersDiv = document.getElementById('pageNumbers');
        numbersDiv.innerHTML = '';
        
        // Show max 5 page buttons
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);

        for (let i = startPage; i <= endPage; i++) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = `page-num-btn ${i === currentPage ? 'active' : ''}`;
            btn.innerText = i;
            btn.onclick = () => goToPage(i);
            numbersDiv.appendChild(btn);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        initPagination();
    });

    // List of existing pieces (truly measured) for validation
    const PIEZAS_EXISTENTES = JSON.parse('{{ piezas_medidas|safe|default:"[]" }}');

    function updateSelection() {
        // const proy = document.getElementById('input_proyecto').value;
        const op = document.getElementById('input_op').value;
        window.location.href = `?op=${encodeURIComponent(op)}`;
    }

    function updateProcess() {
        const proy = document.getElementById('input_proyecto').value;
        const op = document.getElementById('input_op').value;
        const proc = document.getElementById('select_proceso').value;
        window.location.href = `?proy=${encodeURIComponent(proy)}&op=${encodeURIComponent(op)}&proc=${proc}`;
    }

    function updatePiece() {
        const proy = document.getElementById('input_proyecto').value;
        const op = document.getElementById('input_op').value;
        let proc = document.getElementById('select_proceso').value;
        if (proc === 'None' || proc === 'null') proc = '';
        
        const inputPieza = document.getElementById('input_pieza');
        const pieza = parseInt(inputPieza.value);
        
        if (!pieza || pieza < 1) return;

        // Function helper to navigate with autofocus
        const navigateToPiece = (p) => {
            window.location.href = `?proy=${encodeURIComponent(proy)}&op=${encodeURIComponent(op)}&proc=${proc}&pieza=${p}&autofocus=1`;
        };

        if (PIEZAS_EXISTENTES.includes(pieza)) {
            navigateToPiece(pieza);
        } else {
            Swal.fire({
                html: `
                    <div class="swal-icon-circle">
                        <i class="ri-add-line"></i>
                    </div>
                    <div class="premium-swal-title">Nueva Medición</div>
                    <div class="premium-swal-html">
                        La pieza <strong>#${pieza}</strong> no tiene registros.<br>
                        ¿Desea iniciar una nueva medición?
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '<i class="ri-check-line"></i> Iniciar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#3b82f6',
                customClass: {
                    popup: 'premium-swal-popup',
                    confirmButton: 'premium-swal-confirm',
                    cancelButton: 'premium-swal-cancel'
                },
                buttonsStyling: true,
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    navigateToPiece(pieza);
                } else {
                    inputPieza.value = "{{ pieza_actual }}";
                }
            });
        }
    }

    function addNewPiece() {
        Swal.fire({
            html: `
                <div class="swal-icon-circle">
                    <i class="ri-add-circle-line"></i>
                </div>
                <div class="premium-swal-title">Nueva Pieza</div>
                <div class="premium-swal-html">Ingrese el número de la pieza que desea comenzar a medir.</div>
            `,
            input: 'number',
            inputAttributes: { min: 1, step: 1 },
            showCancelButton: true,
            confirmButtonText: '<i class="ri-check-line"></i> Ir a medición',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#3b82f6',
            customClass: {
                popup: 'premium-swal-popup',
                confirmButton: 'premium-swal-confirm',
                cancelButton: 'premium-swal-cancel',
                input: 'form-control input-clean'
            },
            preConfirm: (value) => {
                if (!value || value < 1) {
                    Swal.showValidationMessage('Por favor ingrese un número válido');
                }
                return value;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const newPiece = result.value;
                const proy = document.getElementById('input_proyecto').value;
                const op = document.getElementById('input_op').value;
                let proc = document.getElementById('select_proceso').value;
                if (proc === 'None' || proc === 'null') proc = '';
                window.location.href = `?proy=${encodeURIComponent(proy)}&op=${encodeURIComponent(op)}&proc=${proc}&pieza=${newPiece}`;
            }
        });
    }

    function deletePiece(pieza) {
        Swal.fire({
            html: `
                <div class="swal-icon-circle danger">
                    <i class="ri-delete-bin-line"></i>
                </div>
                <div class="premium-swal-title">¿Borrar pieza?</div>
                <div class="premium-swal-html">
                    Se eliminarán todos los valores de la pieza <strong>#${pieza}</strong>.<br>
                    Esta acción no se puede deshacer.
                </div>
            `,
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            confirmButtonText: '<i class="ri-delete-bin-line"></i> Sí, borrar',
            cancelButtonText: 'Cancelar',
            customClass: {
                popup: 'premium-swal-popup',
                confirmButton: 'premium-swal-confirm',
                cancelButton: 'premium-swal-cancel'
            },
            buttonsStyling: true,
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                const proy = document.getElementById('input_proyecto').value;
                const op = document.getElementById('input_op').value;
                let proc = document.getElementById('select_proceso').value;
                if (proc === 'None' || proc === 'null') proc = '';

                fetch("{% url 'eliminar_pieza_ajax' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({
                        proyecto: proy,
                        op: op,
                        proceso_id: proc,
                        pieza: pieza
                    })
                }).then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        // If the deleted piece is the current one, navigate to the PREVIOUS piece
                        const isCurrent = (pieza == "{{ pieza_actual }}");
                        if (isCurrent) {
                            const prev = "{{ prev_p }}";
                            const first = "{{ first_p }}";
                            const target = (prev && prev !== "None") ? prev : (first && first !== "None" ? first : "1");
                            window.location.href = `?proy=${encodeURIComponent(proy)}&op=${encodeURIComponent(op)}&proc=${proc}&pieza=${target}`;
                        } else {
                            window.location.reload();
                        }
                    } else {
                        Swal.fire('Error', data.message || 'No se pudo eliminar la pieza.', 'error');
                    }
                });
            }
        });
    }

    function checkStatus(el, type) {
        const tile = el.closest('.stitch-tile');
        const statusDot = tile.querySelector('.status-flux-dot');
        const statusText = tile.querySelector('.status-flux-text');
        
        if (type === 'pnp') {
            const val = el.value;
            if (val === 'OK') {
                statusDot.className = 'status-flux-dot ok';
                statusText.textContent = 'SYNC_OK';
                statusText.className = 'status-flux-text small fw-bold text-success';
            } else if (val === 'NOK') {
                statusDot.className = 'status-flux-dot nok';
                statusText.textContent = 'ERR_OUT';
                statusText.className = 'status-flux-text small fw-bold text-danger';
            } else {
                statusDot.className = 'status-flux-dot pending';
                statusText.textContent = 'IDLE';
                statusText.className = 'status-flux-text small fw-bold opacity-25';
            }
        } else {
            const val = parseFloat(el.value);
            const min = parseFloat(el.dataset.min);
            const max = parseFloat(el.dataset.max);
            
            if (isNaN(val)) {
                statusDot.className = 'status-flux-dot pending';
                statusText.textContent = 'IDLE';
                statusText.className = 'status-flux-text small fw-bold opacity-25';
            } else if (val >= min && val <= max) {
                statusDot.className = 'status-flux-dot ok';
                statusText.textContent = 'SYNC_OK';
                statusText.className = 'status-flux-text small fw-bold text-success';
            } else {
                statusDot.className = 'status-flux-dot nok';
                statusText.textContent = 'ERR_OUT';
                statusText.className = 'status-flux-text small fw-bold text-danger';
            }
            
            let minLimit = -Infinity;
            let maxLimit = Infinity;

            // The following logic for minLimit/maxLimit is currently unused due to the direct min/max check above.
            // If this complex logic is intended to be used, the above if/else if/else block needs to be adjusted.
            if (nominal !== null && !isNaN(nominal)) {
                // Hybrid Logic matching Backend
                // Min Logic
                if (minVal !== null && !isNaN(minVal)) {
                    // Check if Deviation (small relative to nominal) or Absolute (large)
                    if (Math.abs(minVal) < (Math.abs(nominal) / 2.0)) {
                        minLimit = nominal - Math.abs(minVal);
                    } else {
                        minLimit = minVal;
                    }
                }
                // Max Logic
                if (maxVal !== null && !isNaN(maxVal)) {
                    if (Math.abs(maxVal) < (Math.abs(nominal) / 2.0)) {
                        maxLimit = nominal + Math.abs(maxVal);
                    } else {
                        maxLimit = maxVal;
                    }
                }
            } else {
                 // No nominal -> Strictly Absolute Limits
                 if (minVal !== null && !isNaN(minVal)) minLimit = minVal;
                 if (maxVal !== null && !isNaN(maxVal)) maxLimit = maxVal;
            }
            
            let ok = true;
            if (val < minLimit || val > maxLimit) {
                ok = false;
            }
            
            if (ok) {
                statusTarget.classList.add('ok');
            } else {
                statusTarget.classList.add('nok');
            }
        }
    }

    // Format value to 2 decimals (handling comma)
    function formatValue(el) {
        if (!el.value) return;
        // Handle comma for clean parsing
        let valStr = el.value.toString().replace(',', '.');
        let val = parseFloat(valStr);
        
        if (isNaN(val)) return;
        
        // Standardize display to 3 decimals (dot separator)
        el.value = val.toFixed(3);
    }

    // Auto-save function
    async function saveMeasurement(el) {
        if (!el.name) return;
        const idParts = el.name.split('_');
        if (idParts.length < 2) return;
        
        const tolId = idParts[1];
        const val = el.value;
        const pieza = "{{ pieza_actual }}";

        console.log(`[SAVE] Sending to server: tolId=${tolId}, pieza=${pieza}, valor="${val}"`);

        try {
            const response = await fetch("{% url 'guardar_medicion_ajax' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    tolerancia_id: tolId,
                    pieza: pieza,
                    valor: val
                })
            });
            const result = await response.json();
            console.log(`[SAVE] Server response:`, result);
            
            if (result.status === 'success') {
                // Flash success
                el.style.borderColor = '#22c55e';
                el.style.backgroundColor = '#f0fdf4';
                
                // Update with Server Value (Source of Truth)
                if (result.saved_value !== null && result.saved_value !== undefined) {
                    console.log(`[SAVE] Updating field from ${el.value} to ${result.saved_value}`);
                    // Only update if element is still active or valid? 
                    // Yes, update strictly to match DB.
                    if (el.tagName === 'INPUT' && el.type !== 'hidden') {
                        el.value = parseFloat(result.saved_value).toFixed(3);
                    }
                    // For PNP select, value is already correct or handled
                }
                
                setTimeout(() => {
                    el.style.borderColor = '';
                    el.style.backgroundColor = '';
                }, 500);
            } else {
                 console.error("[SAVE] Server Error:", result);
                 el.style.borderColor = '#ef4444';
            }
        } catch (error) {
            console.error("[SAVE] Network Error:", error);
            el.style.borderColor = '#ef4444';
        }
    }

    // Auto-focus next input and SAVE on Enter
    document.querySelectorAll('.measurement-input, .pnp-select').forEach((input, idx, list) => {
        // Handle ENTER key
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                
                // SAVE
                saveMeasurement(input);
                // formatValue moved to async success callback

                // FOCUS NEXT
                const next = list[idx + 1];
                if (next) {
                    next.focus();
                } else {
                    // Last input -> Focus "PIEZA #" for new cycle
                    const piezaInput = document.getElementById('input_pieza');
                    if (piezaInput) {
                        piezaInput.focus();
                        piezaInput.select();
                    }
                }
            }
        });

        // Also save numeric inputs on blur (tabbing out)
        if (input.classList.contains('measurement-input')) {
            input.addEventListener('blur', () => {
                formatValue(input);
                saveMeasurement(input);
            });
        }

        // Save select inputs on change
        if (input.classList.contains('pnp-select')) {
            input.addEventListener('change', () => {
                saveMeasurement(input);
            });
        }
    });

    async function quickAdd(model, selectId) {
        const { value: name } = await Swal.fire({
            html: `
                <div class="swal-icon-circle">
                    <i class="ri-${model === 'maquina' ? 'settings-3-line' : 'tools-line'}"></i>
                </div>
                <div class="premium-swal-title">Agregar ${model.charAt(0).toUpperCase() + model.slice(1)}</div>
                <div class="premium-swal-html">Ingrese el nombre del nuevo maestro para darlo de alta en el sistema.</div>
            `,
            input: 'text',
            inputPlaceholder: 'Escriba el nombre aquí...',
            showCancelButton: true,
            confirmButtonColor: '#3b82f6',
            confirmButtonText: '<i class="ri-save-line"></i> Guardar',
            cancelButtonText: 'Cancelar',
            customClass: {
                popup: 'premium-swal-popup',
                confirmButton: 'premium-swal-confirm',
                cancelButton: 'premium-swal-cancel',
                input: 'form-control input-clean'
            },
            inputValidator: (value) => { if (!value) return 'El nombre es requerido'; }
        });

        if (name) {
            const formData = new FormData();
            formData.append('nombre', name);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            try {
                const response = await fetch(`/api/create/${model}/`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.status === 'success') {
                    const selects = selectId ? [document.getElementById(selectId)] : document.querySelectorAll(`select[id*="${model}"], select[name*="${model}"]`);
                    selects.forEach(sel => {
                        if (sel) {
                            const opt = new Option(result.nombre, result.id);
                            sel.add(opt);
                            sel.value = result.id;
                            sel.dispatchEvent(new Event('change')); // Trigger auto-save if applicable
                        }
                    });
                    Swal.fire({
                        html: `
                            <div class="swal-icon-circle">
                                <i class="ri-checkbox-circle-line"></i>
                            </div>
                            <div class="premium-swal-title">¡Guardado!</div>
                            <div class="premium-swal-html">El nuevo registro se ha creado correctamente.</div>
                        `,
                        confirmButtonText: 'Aceptar',
                        confirmButtonColor: '#3b82f6',
                        customClass: {
                            popup: 'premium-swal-popup',
                            confirmButton: 'premium-swal-confirm'
                        }
                    });
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: result.message || 'No se pudo guardar el registro',
                        icon: 'error'
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire('Error', 'Hubo un problema de conexión', 'error');
            }
        }
    }
</script>

<!-- Global SPC Tooltip Container -->
<div id="global-spc-tooltip" class="spc-tooltip-content" style="position: fixed; display: none; z-index: 9999; margin: 0; transform: none;"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tooltip = document.getElementById('global-spc-tooltip');
        let hideTimeout;

        document.querySelectorAll('.spc-alert-trigger').forEach(trigger => {
            trigger.addEventListener('mouseenter', function(e) {
                clearTimeout(hideTimeout);
                const contentDiv = this.querySelector('.spc-tooltip-content');
                if (!contentDiv) return;
                
                tooltip.innerHTML = contentDiv.innerHTML;
                tooltip.style.display = 'block';
                tooltip.style.opacity = '1';
                tooltip.style.visibility = 'visible';
                
                // Calculate position
                const rect = this.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();
                
                // Position: Center horizontally on icon, Above icon
                let top = rect.top - tooltipRect.height - 12; // 12px gap
                let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                
                // Shift left adjustments (as requested)
                left -= 60; // Bias towards left as requested

                // Boundary checks
                if (top < 10) top = rect.bottom + 10; // Flip to bottom if too close to top
                if (left < 10) left = 10;
                if (left + tooltipRect.width > window.innerWidth - 10) left = window.innerWidth - tooltipRect.width - 10;

                tooltip.style.top = `${top}px`;
                tooltip.style.left = `${left}px`;
            });

            trigger.addEventListener('mouseleave', function() {
                hideTimeout = setTimeout(() => {
                    tooltip.style.opacity = '0';
                    setTimeout(() => { 
                        if (tooltip.style.opacity === '0') tooltip.style.display = 'none'; 
                    }, 200);
                }, 100);
            });
        });
    });
</script>

<script>
    async function saveInstrumentSelection(el, tolId) {
        const instrId = el.value;
        console.log(`[TRACE] Saving Instrument: ${instrId} for Tolerance ${tolId}`);
        
        try {
            const response = await fetch("{% url 'guardar_instrumento_ajax' %}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
                body: JSON.stringify({ tolerancia_id: tolId, instrumento_id: instrId })
            });
            const result = await response.json();
            if (result.status === 'success') {
                el.style.borderColor = '#22c55e';
                el.style.backgroundColor = '#f0fdf4';
                setTimeout(() => { 
                    el.style.borderColor = ''; 
                    el.style.backgroundColor = '';
                }, 1000);
            }
        } catch (e) { console.error(e); }
    }
    // Check for autofocus param on load
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('autofocus')) {
            const firstInput = document.querySelector('.measurement-input, .pnp-select');
            if (firstInput) {
                firstInput.focus();
                if (firstInput.select) firstInput.select();
            }
        }
    });
    {% if planilla %}
    function eliminarTodaLaOP() {
        Swal.fire({
            title: '¿ESTÁS SEGURO?',
            html: `Se borrarán <b>TODOS</b> los datos de esta OP (Controles, Tolerancias y Mediciones).<br><br>Esta acción no se puede deshacer.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#64748b',
            confirmButtonText: '<i class="ri-delete-bin-line"></i> SÍ, BORRAR TODO',
            cancelButtonText: 'CANCELAR',
            customClass: {
                popup: 'premium-swal-popup',
                title: 'premium-swal-title',
                htmlContainer: 'premium-swal-html',
                confirmButton: 'premium-swal-confirm btn-danger',
                cancelButton: 'premium-swal-cancel'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Borrando...',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });

                fetch('{% url "eliminar_planilla_completa_ajax" planilla.id %}', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                }).then(r => r.json()).then(data => {
                    if (data.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'OP ELIMINADA',
                            text: 'Se han borrado todos los registros de la OP con éxito.',
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => {
                            window.location.href = "{% url 'asignar_op' %}";
                        });
                    } else {
                        Swal.fire('Error', data.message || 'No se pudo eliminar la OP', 'error');
                    }
                }).catch(e => {
                    Swal.fire('Error de conexión', 'Inténtelo de nuevo', 'error');
                });
            }
        });
    }
    {% endif %}
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
{% endblock %}
