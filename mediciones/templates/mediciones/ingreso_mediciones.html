{% extends 'mediciones/index.html' %}
{% load static %}

{% block title %}Ingreso de Mediciones{% endblock %}

{% block content %}

<!-- FUENTES INDUSTRIALES DE ALTA PRECISIN -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Fira+Sans:wght@300;400;600;800&family=Outfit:wght@800&display=swap" rel="stylesheet">

<style>
    :root {
        --stitch-bg: #fffbfb;
        --stitch-surface: #ffffff;
        --stitch-primary: #e11d48; /* Ruby Red */
        --stitch-secondary: #fb7185; /* Rose */
        --stitch-border: rgba(225, 29, 72, 0.08);
        --stitch-text: #1e1b1b;
        --stitch-muted: #7f7171;
        --stitch-success: #10b981;
        --stitch-danger: #e11d48;
        --stitch-glass: rgba(255, 255, 255, 0.7);
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--stitch-bg);
        background-image: 
            radial-gradient(circle at 0% 0%, rgba(225, 29, 72, 0.02) 0%, transparent 50%),
            radial-gradient(circle at 100% 100%, rgba(251, 113, 133, 0.02) 0%, transparent 50%);
        color: var(--stitch-text);
        min-height: 100vh;
    }

    .content-wrapper {
        max-width: 1400px !important;
        margin: 0 auto !important;
        padding: 3rem !important;
    }

    /* STITCH MODULES (RUBY BENTO) */
    .stitch-module {
        background: var(--stitch-glass);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--stitch-border);
        border-radius: 24px;
        box-shadow: 0 10px 40px -10px rgba(225, 29, 72, 0.05);
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        position: relative;
    }

    .stitch-module:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 50px -12px rgba(225, 29, 72, 0.1);
        border-color: rgba(225, 29, 72, 0.2);
    }

    /* TYPOGRAPHY: CRIMSON PRECISION */
    .stitch-title {
        font-family: 'Outfit', sans-serif;
        font-weight: 800;
        letter-spacing: -0.02em;
        background: linear-gradient(135deg, var(--stitch-text) 30%, var(--stitch-primary));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .stitch-label {
        font-size: 0.65rem;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--stitch-primary);
        margin-bottom: 0.5rem;
        opacity: 0.8;
    }

    /* STACKED BENTO GRID */
    .stitch-tile {
        display: grid;
        grid-template-columns: 1fr 100px 140px 100px 180px;
        gap: 1.5rem;
        align-items: center;
        background: #ffffff;
        padding: 1.5rem 2.5rem;
        border-radius: 20px;
        border: 1px solid #f9ecec;
        margin-bottom: 1.25rem;
        transition: all 0.3s;
        box-shadow: 0 2px 4px rgba(225, 29, 72, 0.02);
    }

    .stitch-tile:last-child {
        border-bottom: none;
    }

    .stitch-tile:hover {
        background: #fffafa;
        border-color: var(--stitch-secondary);
        transform: scale(1.005);
    }

    .stitch-val-input {
        background: #fdf5f5;
        border: 2px solid transparent;
        color: var(--stitch-primary);
        text-align: center;
        font-family: 'Fira Code', monospace;
        font-size: 1.4rem;
        font-weight: 800;
        border-radius: 12px;
        width: 100%;
        height: 52px;
        transition: all 0.3s;
    }

    .stitch-val-input:focus {
        background: #ffffff;
        border-color: var(--stitch-primary);
        box-shadow: 0 0 0 4px rgba(225, 29, 72, 0.1);
        outline: none;
    }

    /* STATUS FLUX */
    .status-flux {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        position: relative;
    }

    .status-flux.ok { background: var(--stitch-success); box-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
    .status-flux.nok { background: var(--stitch-danger); box-shadow: 0 0 10px rgba(225, 29, 72, 0.3); }
    .status-flux.pending { background: #e5e1e1; }

    /* ACTION BUTTONS */
    .btn-stitch-primary {
        background: var(--stitch-primary);
        color: white;
        border: none;
        padding: 1rem;
        border-radius: 10px;
        font-weight: 700;
        text-transform: uppercase;
        width: 100%;
        box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4);
        transition: all 0.3s;
    }

    .btn-stitch-primary:hover {
        background: #4f46e5;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
    }

    .btn-stitch-outline {
        background: transparent;
        border: 1px solid var(--stitch-border);
        color: var(--stitch-text);
        padding: 1rem;
        border-radius: 10px;
        font-weight: 600;
        width: 100%;
        transition: all 0.3s;
    }

    .btn-stitch-outline:hover {
        background: rgba(99, 102, 241, 0.1);
        border-color: var(--stitch-primary);
    }

    .stitch-layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 2rem;
    }

    @media (max-width: 1200px) {
        .cyber-layout-grid { grid-template-columns: 1fr; }
    }
</style>

<div class="animate__animated animate__fadeIn">
    <form method="post">
        {% csrf_token %}
        
        <div class="d-flex align-items-center justify-content-between mb-5 mt-2">
            <div>
                <a href="javascript:history.back()" class="text-decoration-none text-muted fw-bold small opacity-50 hover-opacity-100 transition-all">
                    <i class="ri-arrow-left-up-line"></i> SISTEMA / VOLVER AL PANEL
                </a>
                <h1 class="stitch-title mt-2" style="font-size: 2.75rem;">Control de Calidad v3.0</h1>
            </div>
            <div class="stitch-module d-flex align-items-center gap-4" style="padding: 1rem 2rem;">
                <div>
                    <span class="stitch-label" style="margin: 0;">IDENTIFICADOR PIEZA</span>
                    <div class="fw-bold mt-1" style="font-size: 1.5rem; color: var(--stitch-primary);">#{{ pieza_actual|stringformat:"04d" }}</div>
                </div>
                <div class="d-flex gap-2">
                    <a href="?pieza={{ prev_pieza }}" class="btn-stitch-outline p-0 {% if not prev_pieza %}disabled opacity-25{% endif %}" style="width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;">
                        <i class="ri-arrow-left-s-line"></i>
                    </a>
                    <a href="?pieza={{ next_pieza }}" class="btn-stitch-outline p-0" style="width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;">
                        <i class="ri-arrow-right-s-line"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="stitch-layout">
            <!-- SIDEBAR MODULE -->
            <div class="sidebar-flux">
                <div class="stitch-module mb-4 p-4">
                    <div class="mb-4">
                        <label class="stitch-label">Empresa Cliente</label>
                        <div class="fw-bold" style="color: var(--stitch-primary); font-size: 1.1rem;">{{ planilla.cliente.nombre }}</div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="stitch-label">Proyecto / Pieza</label>
                        <div class="fw-bold text-white">{{ planilla.proyecto }}</div>
                        <div class="text-muted small">OP: {{ planilla.num_op }}</div>
                    </div>

                    <div class="mb-4">
                        <label class="stitch-label">Proceso Activo</label>
                        <select name="proceso" class="stitch-input" required>
                            <option value="">-- SELECCIONAR PROCESO --</option>
                            {% for p in procesos %}
                                <option value="{{ p.id }}" {% if p.id == planilla.proceso.id %}selected{% endif %}>{{ p.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-2">
                        <label class="stitch-label">Pieza Actual</label>
                        <input type="number" name="pieza" value="{{ pieza_actual }}" class="stitch-input text-center" style="font-size: 1.25rem; font-weight: 700;">
                    </div>
                </div>

                <div class="stitch-module p-4">
                    <button type="submit" name="guardar_siguiente" class="btn-stitch-primary mb-3">
                        <i class="ri-rocket-2-line"></i>
                        GUARDAR Y SIGUIENTE
                    </button>
                    <button type="submit" name="guardar" class="btn-stitch-outline">
                        <i class="ri-save-line"></i>
                        GUARDAR PROVISIONAL
                    </button>
                </div>
            </div>

            <!-- MAIN GRID MODULE -->
            <div class="main-flux">
                <div class="stitch-module p-4">
                    <div class="d-flex align-items-center justify-content-between mb-4 border-bottom pb-4" style="border-color: rgba(255,255,255,0.05);">
                        <h3 class="stitch-title" style="font-size: 1.4rem;">
                            <i class="ri-bubble-chart-line"></i> GRILLA DE ANÁLISIS / CONTROLES ACTIVOS
                        </h3>
                        <div class="text-muted small fw-bold">
                            CONTROLES: <span style="color: var(--stitch-primary);">{{ rows|length }}</span>
                        </div>
                    </div>

                    {% if rows %}
                        <div class="stitch-grid-container">
                            {% for row in rows %}
                            <div class="stitch-tile animate__animated animate__fadeInUp" style="animation-delay: {{ forloop.counter0|add:1 }}0ms;">
                                <div>
                                    <div class="stitch-label" style="font-size: 0.55rem; opacity: 0.8; margin-bottom: 2px;">CONTROL</div>
                                    <div class="fw-bold text-white mb-1 text-truncate" style="max-width: 250px;" title="{{ row.tolerancia.control.nombre }}">
                                        {{ row.tolerancia.control.nombre }}
                                    </div>
                                    <div class="d-flex align-items-center gap-2 mt-1">
                                        <a href="{% url 'estadisticas_control' row.tolerancia.id %}" target="_blank" class="text-decoration-none d-flex align-items-center gap-1" style="font-size: 0.65rem; color: var(--stitch-primary); opacity: 0.8; font-weight: 700;">
                                            <i class="ri-bar-chart-2-line"></i> VER ESTADÍSTICAS
                                        </a>
                                    </div>
                                </div>

                                <div class="text-center px-3">
                                    <label class="stitch-label mb-1">MIN</label>
                                    <div class="text-white fw-bold">{% if not row.tolerancia.control.pnp %}{{ row.tolerancia.minimo|default:"0.000" }}{% else %}N/A{% endif %}</div>
                                </div>

                                <div class="text-center">
                                    <label class="stitch-label mb-1" style="color: var(--stitch-primary);">INGRESO VALOR</label>
                                    {% if row.tolerancia.control.pnp %}
                                        <select name="valorpnp_{{ row.tolerancia.id }}" class="stitch-input text-center fw-bold" style="height: 48px;">
                                            <option value="" {% if not row.valor %}selected{% endif %}>-</option>
                                            <option value="OK" {% if row.valor == 'OK' %}selected{% endif %}>PASA</option>
                                            <option value="NOK" {% if row.valor == 'NOK' %}selected{% endif %}>FALLA</option>
                                        </select>
                                    {% else %}
                                        <input type="number" step="0.001" name="valor_{{ row.tolerancia.id }}" 
                                               value="{% if row.valor is not None %}{{ row.valor|floatformat:3 }}{% endif %}" 
                                               class="stitch-val-input" 
                                               placeholder="0.000">
                                    {% endif %}
                                </div>

                                <div class="text-center px-3">
                                    <label class="stitch-label mb-1">MAX</label>
                                    <div class="text-white fw-bold">{% if not row.tolerancia.control.pnp %}{{ row.tolerancia.maximo|default:"0.000" }}{% else %}N/A{% endif %}</div>
                                </div>

                                <div class="text-end">
                                    <label class="stitch-label mb-2 d-block">ESTADO</label>
                                    <div class="d-flex align-items-center justify-content-end gap-3">
                                        <span class="small fw-bold {% if row.status == 'OK' %}text-success{% elif row.status == 'NOK' %}text-danger{% else %}text-muted{% endif %}">
                                            {% if row.status == 'OK' %}
                                                <i class="ri-checkbox-circle-fill" style="font-size: 1.2rem;"></i>
                                            {% elif row.status == 'NOK' %}
                                                <i class="ri-close-circle-fill" style="font-size: 1.2rem;"></i>
                                            {% else %}
                                                <i class="ri-subtract-line" style="font-size: 1.2rem;"></i>
                                            {% endif %}
                                        </span>
                                        <div class="status-flux {% if row.status == 'OK' %}ok{% elif row.status == 'NOK' %}nok{% else %}pending{% endif %}"></div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5" style="border: 1px solid #f9ecec; border-radius: 24px; background: #ffffff; box-shadow: 0 10px 30px rgba(225, 29, 72, 0.03);">
                            <i class="ri-radar-line animate__animated animate__pulse animate__infinite" style="font-size: 5rem; color: var(--stitch-primary); opacity: 0.15;"></i>
                            <p class="mt-4 text-muted fw-bold" style="letter-spacing: 0.05em; color: #7f7171 !important;">ESPERANDO DATOS: SIN FLUJO DE SEÑAL</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}


