{% extends 'mediciones/base.html' %}

{% block title %}Estructuras de Medición{% endblock %}

{% block content %}
<style>
    :root {
        --stitch-primary: #e11d48;     /* Rose 600 */
        --stitch-secondary: #fda4af;   /* Rose 300 */
        --stitch-bg: #fdf2f8;          /* Rose 50 */
        --stitch-text: #1e293b;        /* Slate 800 */
        --stitch-glass: rgba(255, 255, 255, 0.9);
        --stitch-border: rgba(225, 29, 72, 0.15);
        --stitch-shadow: 0 10px 40px -10px rgba(225, 29, 72, 0.08);
    }
    
    body { 
        background-color: var(--stitch-bg) !important;
        font-family: 'Inter', sans-serif; 
    }

    .btn-stitch-primary {
        background: linear-gradient(135deg, var(--stitch-primary), #be123c);
        color: white;
        border: none;
        border-radius: 14px;
        padding: 0.85rem 1.75rem;
        font-weight: 800;
        font-family: 'Outfit', sans-serif;
        letter-spacing: 0.05em;
        transition: all 0.3s;
        box-shadow: 0 10px 20px -5px rgba(225, 29, 72, 0.4);
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .btn-stitch-primary:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 15px 30px -5px rgba(225, 29, 72, 0.5);
        color: white;
    }

    .stitch-module {
        background: var(--stitch-glass);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--stitch-border);
        border-radius: 20px;
        box-shadow: var(--stitch-shadow);
        overflow: hidden;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table thead th {
        background: rgba(225, 29, 72, 0.03);
        color: var(--stitch-primary);
        font-family: 'Outfit', sans-serif;
        font-weight: 800;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.05em;
        padding: 1rem 1.25rem;
        border-bottom: 2px solid var(--stitch-border);
    }
    
    .data-table tbody tr {
        transition: background 0.2s;
        border-bottom: 1px dashed var(--stitch-border);
    }
    
    .data-table tbody tr:hover {
        background: rgba(225, 29, 72, 0.02) !important;
    }

    .btn-action-edit {
        background: rgba(225, 29, 72, 0.05) !important; 
        color: var(--stitch-primary) !important; 
        width: 38px; height: 38px; border-radius: 12px; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; border: 1px solid var(--stitch-border) !important;
        transition: all 0.2s;
    }
    .btn-action-edit:hover {
        background: rgba(225, 29, 72, 0.1) !important;
        color: #be123c !important;
        transform: translateY(-2px);
        border-color: rgba(225, 29, 72, 0.3) !important;
    }

    .btn-action-delete {
        background: rgba(239, 68, 68, 0.1) !important; 
        color: #ef4444 !important; 
        width: 38px; height: 38px; border: 1px solid rgba(239, 68, 68, 0.2) !important; border-radius: 12px; display: inline-flex; align-items: center; justify-content: center;
        transition: all 0.2s;
    }
    .btn-action-delete:hover {
        background: rgba(239, 68, 68, 0.2) !important;
        color: #b91c1c !important;
        transform: translateY(-2px);
    }

    .swal2-popup .swal2-icon.no-border {
        border: none !important;
        background: transparent !important;
        box-shadow: none !important;
    }
</style>

<div class="container-fluid py-4 animate__animated animate__fadeIn" style="max-width: 1400px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 style="font-family: 'Outfit', sans-serif; font-weight: 800; font-size: 1.8rem; letter-spacing: -0.025em; color: var(--stitch-text); margin: 0;">ESTRUCTURAS DE MEDICIÓN</h1>
            <p style="color: #64748b; font-weight: 500; font-size: 0.95rem; margin: 0;">Configura las plantillas para OPs y Proyectos referenciados a Clientes.</p>
        </div>
        <a href="{% url 'configurar_estructura' %}" class="btn-stitch-primary">
            <i class="ri-add-line" style="font-size: 1.2rem;"></i> NUEVA ESTRUCTURA
        </a>
    </div>

    <div class="stitch-module">
        <div class="card-body p-0">
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>OP / PROYECTO</th>
                            <th>CLIENTE</th>
                            <th>ARTÍCULO</th>
                            <th class="text-end">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for e in estructuras %}
                        <tr>
                            <td style="padding: 1.25rem;">
                                <div style="font-weight: 800; color: var(--stitch-text); font-size: 1.05rem;">
                                    {% if e.num_op %}{{ e.num_op }} / {% endif %}{{ e.proyecto }}
                                </div>
                            </td>
                            <td>
                                <span style="color: #64748b; font-weight: 600;">{{ e.cliente.nombre|default:"-" }}</span>
                            </td>
                            <td>
                                <span class="badge" style="background: rgba(225, 29, 72, 0.1); color: var(--stitch-primary); border: 1px solid rgba(225, 29, 72, 0.2); padding: 0.4rem 0.8rem; border-radius: 8px; font-weight: 700;">
                                    {{ e.articulo.nombre|default:"Sin Artículo" }}
                                </span>
                            </td>
                            <td class="text-end" style="padding-right: 1.25rem;">
                                <div class="d-flex gap-2 justify-content-end">
                                    <a href="{% url 'configurar_estructura' %}?op={{ e.num_op|default:'' }}&proy={{ e.proyecto|default:'' }}" 
                                       class="btn-action-edit" 
                                       title="Editar Estructura">
                                        <i class="ri-edit-line" style="font-size: 1.1rem;"></i>
                                    </a>
                                    <button type="button" 
                                            onclick="deleteStructure('{{ e.proyecto }}', '{{ e.num_op }}')"
                                            class="btn-action-delete"
                                            title="Eliminar Estructura">
                                        <i class="ri-delete-bin-line" style="font-size: 1.1rem;"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" style="padding: 4rem 1rem; text-align: center; color: #94a3b8;">
                                <i class="ri-layout-grid-fill" style="font-size: 3rem; margin-bottom: 1rem; display: block; opacity: 0.2; color: var(--stitch-primary);"></i>
                                <div style="font-weight: 600; font-size: 1.1rem;">AÚN NO SE HAN DEFINIDO ESTRUCTURAS</div>
                                <div style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.8;">Crea tu primera estructura utilizando el botón superior.</div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function deleteStructure(proyecto, numOp) {
        Swal.fire({
            title: '¿Eliminar Estructura?',
            text: `Se eliminarán todos los controles asociados a ${proyecto} (OP: ${numOp}). Esta acción no se puede deshacer.`,
            iconHtml: '<div style="width: 80px; height: 80px; background-color: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;"><svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>',
            showCancelButton: true,
            confirmButtonText: 'Eliminar',
            cancelButtonText: 'Cancelar',
            buttonsStyling: false,
            customClass: {
                popup: 'premium-swal',
                title: 'premium-title',
                htmlContainer: 'premium-text',
                actions: 'premium-actions',
                confirmButton: 'swal2-confirm premium-confirm-btn premium-confirm-btn-danger',
                cancelButton: 'swal2-cancel premium-cancel-btn',
                icon: 'no-border'
            },
            reverseButtons: false
        }).then((result) => {
            if (result.isConfirmed) {
                // Show loading with consistent style
                Swal.fire({
                    title: 'Eliminando...',
                    html: 'Por favor espere',
                    didOpen: () => Swal.showLoading(),
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    customClass: {
                        popup: 'premium-swal'
                    }
                });

                fetch("{% url 'eliminar_estructura' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ proyecto: proyecto, num_op: numOp })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        Swal.fire({
                            title: '¡Eliminado!',
                            text: data.message,
                            iconHtml: '<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;"><svg width="80" height="80" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" stroke="#dcfce7" stroke-width="4" fill="white"/><path d="M50 50 L 50 50" stroke="#22c55e" stroke-width="4" stroke-linecap="round"/><path d="M35 50 L 45 60 L 65 40" stroke="#4ade80" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/></svg></div>',
                            confirmButtonText: 'Aceptar',
                            buttonsStyling: false,
                            customClass: {
                                popup: 'premium-swal',
                                title: 'premium-title',
                                htmlContainer: 'premium-text',
                                confirmButton: 'swal2-confirm premium-confirm-btn premium-confirm-btn-primary',
                                icon: 'no-border'
                            }
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: data.message,
                            icon: 'error',
                            confirmButtonText: 'Aceptar',
                            buttonsStyling: false,
                            customClass: {
                                popup: 'premium-swal',
                                title: 'premium-title',
                                htmlContainer: 'premium-text',
                                confirmButton: 'swal2-confirm premium-confirm-btn premium-confirm-btn-danger'
                            }
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        title: 'Error',
                        text: 'Ocurrió un error al procesar la solicitud.',
                        icon: 'error',
                        confirmButtonText: 'Cerrar',
                        buttonsStyling: false,
                        customClass: {
                            popup: 'premium-swal',
                            title: 'premium-title',
                            htmlContainer: 'premium-text',
                            confirmButton: 'swal2-confirm premium-confirm-btn premium-confirm-btn-danger'
                        }
                    });
                });
            }
        });
    }
</script>
{% endblock %}
