{% extends 'mediciones/base.html' %}
{% load static %}

{% block title %}Dashboard de Metrología Premium{% endblock %}

{% block content %}
<div class="premium-dashboard-container animate__animated animate__fadeIn">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="premium-title">Gestión de Metrología</h1>
            <p class="premium-subtitle">Control centralizado de instrumentos, calibraciones y vigencias.</p>
        </div>
        <div class="d-flex gap-3">
            <a href="{% url 'lista_instrumentos' %}" class="btn-premium-secondary">
                <i class="ri-settings-3-line"></i> Inventario Completo
            </a>
            <a href="{% url 'crear_instrumento' %}" class="btn-premium-primary">
                <i class="ri-add-line"></i> Nuevo Instrumento
            </a>
        </div>
    </div>

    <!-- Quick Stats Grid -->
    <div class="row g-4 mb-5">
        <div class="col-xl-3 col-md-6">
            <div class="stat-card blue">
                <div class="stat-icon"><i class="ri-tools-line"></i></div>
                <div class="stat-info">
                    <span class="label">EQUIPOS ABBAMAT</span>
                    <span class="value">{{ propios_count }}</span>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card purple">
                <div class="stat-icon"><i class="ri-user-star-line"></i></div>
                <div class="stat-info">
                    <span class="label">EQUIPOS DE CLIENTES</span>
                    <span class="value">{{ clientes_count }}</span>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card yellow">
                <div class="stat-icon"><i class="ri-error-warning-line"></i></div>
                <div class="stat-info">
                    <span class="label">VENCIDOS / ALERTA</span>
                    <span class="value {% if vencidos_count > 0 %}text-danger{% endif %}">
                        {{ vencidos_count }} <small style="font-size: 0.5em; vertical-align: middle;">(+{{ alerta_count }})</small>
                    </span>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-card red">
                <div class="stat-icon"><i class="ri-delete-bin-line"></i></div>
                <div class="stat-info">
                    <span class="label">OBSOLETOS / BAJA</span>
                    <span class="value" style="color: #94a3b8;">{{ obsoletos_count }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <!-- Chart Section -->
        <div class="col-lg-4">
            <div class="premium-card h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="card-title-premium">Estado Vigencia</h3>
                </div>
                <div style="height: 250px; position: relative;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="premium-card h-100">
                <h3 class="card-title-premium mb-4">Distribución por Tipo de Equipo</h3>
                <div style="height: 250px;">
                    <canvas id="typeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- main List Table -->
    <div class="premium-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="card-title-premium">Cronograma de Próximas Calibraciones</h3>
                <p class="text-muted small m-0">Mostrando los próximos vencimientos ordenados cronológicamente.</p>
            </div>
            <div class="search-box-premium">
                <i class="ri-search-line"></i>
                <input type="text" id="tableSearch" placeholder="Buscar instrumento...">
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table premium-list-table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Instrumento</th>
                        <th>Propiedad</th>
                        <th>Vencimiento</th>
                        <th>Estado</th>
                        <th>Última Cal.</th>
                        <th class="text-center">Certificado</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody id="instrumentTableBody">
                    {% for inst in prox_calibraciones %}
                    <tr class="item-row">
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="inst-icon-small" style="width: 32px; height: 32px; font-size: 1rem;">
                                    <i class="ri-tools-fill"></i>
                                </div>
                                <div>
                                    <div class="fw-bold text-dark">{{ inst.nombre }}</div>
                                    <div class="text-xxs text-muted">{{ inst.codigo|default:"S/N" }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if inst.es_propio %}
                                <span class="badge bg-primary-soft text-primary" style="font-size: 0.65rem;">ABBAMAT</span>
                            {% else %}
                                <span class="badge bg-purple-soft text-purple" style="font-size: 0.65rem;" title="Dueño: {{ inst.cliente.nombre }}">CLIENTE</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="fw-bold {% if inst.is_calibracion_vencida %}text-danger{% elif inst.is_en_alerta %}text-warning{% endif %}">
                                {{ inst.proxima_calibracion|date:"d/m/Y"|default:"-" }}
                            </div>
                        </td>
                        <td>
                            {% if inst.is_calibracion_vencida %}
                                <div class="status-pill red">VENCIDO</div>
                            {% elif inst.is_en_alerta %}
                                <div class="status-pill yellow">EN ALERTA</div>
                            {% else %}
                                <div class="status-pill green">VIGENTE</div>
                            {% endif %}
                        </td>
                        <td class="small text-muted">{{ inst.ultima_calibracion|date:"d/m/Y"|default:"-" }}</td>
                        <td class="text-center">
                            {% if inst.certificado_nro %}
                                <div class="cert-badge" title="N° {{ inst.certificado_nro }}">
                                    <i class="ri-file-shield-2-line"></i>
                                </div>
                            {% else %}
                                <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <div class="d-flex gap-2 justify-content-end">
                                <a href="{% url 'detalle_instrumento' inst.pk %}" class="btn-icon gray" title="Ver Historial">
                                    <i class="ri-history-line"></i>
                                </a>
                                <button onclick="openCalibrationModal('{{ inst.id }}', '{{ inst.nombre }}')" class="btn-icon blue" title="Registrar Calibración">
                                    <i class="ri-shield-check-line"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="empty-state">
                                <i class="ri-inbox-line"></i>
                                <p>No hay instrumentos próximos a vencer.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% include 'mediciones/components/modal_calibracion.html' %}

<style>
    :root {
        --premium-blue: #3b82f6;
        --premium-green: #10b981;
        --premium-yellow: #f59e0b;
        --premium-red: #ef4444;
        --premium-purple: #8b5cf6;
        --premium-bg: #f8fafc;
        --premium-card-bg: #ffffff;
        --premium-text: #1e293b;
        --premium-subtitle: #64748b;
    }

    .bg-primary-soft { background: rgba(59, 130, 246, 0.1); }
    .bg-purple-soft { background: rgba(139, 92, 246, 0.1); }
    .text-purple { color: var(--premium-purple); }

    .stat-card.purple .stat-icon { background: #f5f3ff; color: #8b5cf6; }

    /* Los estilos anteriores se mantienen en index.css */
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Status Chart
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Operativos', 'En Alerta', 'Vencidos', 'Bloqueados', 'Obsoletos'],
                datasets: [{
                    data: [{{ ok_count }}, {{ alerta_count }}, {{ vencidos_count }}, {{ bloqueados_count }}, {{ obsoletos_count }}],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#64748b', '#cbd5e1'],
                    borderWidth: 0,
                    cutout: '75%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, font: { weight: 'bold', size: 11 } } }
                }
            }
        });

        // Type Chart
        const typeCtx = document.getElementById('typeChart').getContext('2d');
        const labelsTypes = [{% for tipo, count in tipos_count.items %}'{{ tipo }}',{% endfor %}];
        const dataTypes = [{% for tipo, count in tipos_count.items %}{{ count }},{% endfor %}];
        
        new Chart(typeCtx, {
            type: 'bar',
            data: {
                labels: labelsTypes,
                datasets: [{
                    label: 'Cantidad',
                    data: dataTypes,
                    backgroundColor: '#3b82f6',
                    borderRadius: 8,
                    barThickness: 30
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { stepSize: 1 } },
                    x: { grid: { display: false } }
                }
            }
        });

        // Search Filter
        document.getElementById('tableSearch').addEventListener('keyup', function() {
            let value = this.value.toLowerCase();
            let rows = document.querySelectorAll('#instrumentTableBody tr.item-row');
            rows.forEach(row => {
                let text = row.innerText.toLowerCase();
                row.style.display = text.includes(value) ? '' : 'none';
            });
        });
    });
</script>
{% endblock %}
