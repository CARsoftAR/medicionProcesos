{% extends 'mediciones/index.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="premium-page-container" style="padding: 1rem 2rem; background: var(--bg-body, #0b0f1a); height: 100vh; overflow: hidden; display: flex; flex-direction: column;">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-3">
            <div>
                <h1 id="controlTitleHeader" style="font-size: 1.5rem; font-weight: 800; color: var(--text-primary, #fff); margin: 0; letter-spacing: -0.025em;">
                    SEGUIMIENTO DE PARÁMETROS: {{ tolerancia.control.nombre }}
                </h1>
                <p id="controlSubHeader" style="color: var(--text-secondary, #94a3b8); font-size: 0.95rem; margin: 0; font-weight: 500;">
                    Proyecto: {{ tolerancia.planilla.proyecto }} | OP: {{ tolerancia.planilla.num_op }} | Proceso: {{ tolerancia.planilla.proceso.nombre }} | Cliente: {{ tolerancia.planilla.cliente.nombre }}
                </p>
            </div>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <button id="topReportBtn" onclick="showDiagnosticReport()" class="btn btn-danger animate__animated animate__pulse animate__infinite d-flex align-items-center gap-2 px-3 shadow-danger" style="{% if not stats.alerts %}display: none !important;{% endif %} border-radius: 12px; font-weight: 800; font-size: 0.8rem; height: 42px; border: none; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); letter-spacing: 0.02em;">
                <i class="ri-pulse-line"></i> DIAGNÓSTICO SPC
            </button>
            
            <button onclick="toggleFullScreen()" class="btn shadow-sm d-flex align-items-center justify-content-center" style="width: 42px; height: 42px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: var(--bg-card, #161c2d);" title="Pantalla Completa">
                <i class="ri-fullscreen-line" id="fsIcon" style="font-size: 1.2rem; color: var(--text-secondary, #94a3b8);"></i>
            </button>

            <a id="btnVolver" href="{% url 'nueva_medicion_op' %}?proy={{ tolerancia.planilla.proyecto }}&op={{ tolerancia.planilla.num_op }}&proc={{ tolerancia.planilla.proceso.id }}" class="btn" style="background-color: #ef4444; color: white; padding: 0.6rem 1.5rem; border-radius: 12px; font-size: 0.9rem; font-weight: 700; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);">
                <i class="ri-arrow-left-line"></i> Volver
            </a>
        </div>
    </div>

    <!-- Stats & Charts Flex Container -->
    <div class="d-flex gap-4 mb-4 flex-column flex-md-row" style="flex: 1; min-height: 0;">
        
        <!-- Left Column: Stats & Controls -->
        <div style="flex: 0 0 320px; min-width: 320px; display: flex; flex-direction: column; gap: 0.75rem; height: 100%; overflow-y: auto; padding-right: 4px;" class="custom-scrollbar">
            
            <!-- Stats Table (Top) -->
            <div class="config-card" style="flex-shrink: 0; background: var(--bg-card, #161c2d); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; overflow: hidden;">
                <div class="config-card-header" style="background: rgba(59, 130, 246, 0.15); color: #60a5fa; padding: 0.85rem 1rem; border-bottom: 1px solid rgba(59, 130, 246, 0.2); display: flex; align-items: center; gap: 0.5rem;">
                    <i class="ri-settings-5-line" style="font-size: 1.1rem;"></i>
                    <span style="font-weight: 800; letter-spacing: 0.05em;">ESTADÍSTICOS X-R</span>
                </div>
                <div class="config-card-body p-0">
                    <table class="table table-sm mb-0 stats-table-dark">
                        <tr><td>Media (X̄)</td><td class="text-end fw-bold" id="stat-mean">{{ stats.mean|floatformat:3 }}</td></tr>
                        <tr><td>L.I.C.</td><td class="text-end fw-bold" id="stat-lic">{{ stats.lic|floatformat:3 }}</td></tr>
                        <tr><td>L.S.C.</td><td class="text-end fw-bold" id="stat-lsc">{{ stats.lsc|floatformat:3 }}</td></tr>
                        <tr><td>Rango (R)</td><td class="text-end fw-bold" id="stat-range">{{ stats.range|floatformat:3 }}</td></tr>
                        <tr><td>Lote (n)</td><td class="text-end fw-bold" id="stat-n">{{ stats.n }}</td></tr>
                        <tr><td>Desv. Est. (σ)</td><td class="text-end fw-bold" id="stat-stdev">{{ stats.stdev|floatformat:3 }}</td></tr>
                        <tr class="table-highlight"><td>L.S.E. (TOL+)</td><td class="text-end fw-bold text-danger" id="stat-usl">{{ stats.usl|floatformat:3|default:"N/A" }}</td></tr>
                        <tr class="table-highlight"><td>L.I.E. (TOL-)</td><td class="text-end fw-bold text-danger" id="stat-lsl">{{ stats.lsl|floatformat:3|default:"N/A" }}</td></tr>
                        <tr>
                            <td>Índice CP</td>
                            <td class="text-end">
                                <div class="d-flex justify-content-end align-items-center gap-2" id="stat-cp-container">
                                    <span class="fw-bold" id="stat-cp">{{ stats.cp|default:"N/D" }}</span>
                                    {% if stats.cp_info and stats.cp %}
                                    <span class="badge {{ stats.cp_info.class }}" style="font-size: 0.7rem;">{{ stats.cp_info.text }}</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Índice CPK</td>
                            <td class="text-end">
                                <div class="d-flex justify-content-end align-items-center gap-2" id="stat-cpk-container">
                                    <span class="fw-bold" id="stat-cpk">{{ stats.cpk|default:"N/D" }}</span>
                                    {% if stats.cpk_info and stats.cpk %}
                                    <span class="badge {{ stats.cpk_info.class }}" style="font-size: 0.7rem;">{{ stats.cpk_info.text }}</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Controls List (Bottom - Scrollable) -->
            <div class="config-card" style="flex: 1; min-height: 0; display: flex; flex-direction: column; overflow: hidden; border-top: 3px solid #6366f1; background: var(--bg-card, #161c2d); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                 <div class="config-card-header" style="background: rgba(99, 102, 241, 0.15); color: #a5b4fc; border-bottom: 1px solid rgba(99, 102, 241, 0.2); padding: 0.75rem 1rem;">
                     <div class="d-flex align-items-center gap-2">
                        <i class="ri-list-check"></i>
                        <span style="font-weight: 800; font-size: 0.8rem; letter-spacing: 0.05em;">CONTROLES</span>
                     </div>
                </div>
                <div class="config-card-body p-0" style="flex: 1; overflow-y: auto;">
                    <div class="list-group list-group-flush">
                        {% regroup controles_hermanos by planilla.elemento.nombre as element_list %}
                        {% for element in element_list %}
                            {% for sibling in element.list %}
                            {% if sibling.control.pnp %}
                            <div class="list-group-item d-flex align-items-center justify-content-between px-3 py-2"
                                 style="font-size: 0.85rem; background: transparent; color: #4b5563; opacity: 0.6; cursor: not-allowed; border: none;">
                                <span class="text-truncate d-flex align-items-center gap-2" style="flex: 1;">
                                    {{ sibling.control.nombre }}
                                    <span class="badge rounded-pill" style="font-size: 0.6rem; font-weight: 500; background: rgba(255,255,255,0.05); color: #4b5563;">PnP</span>
                                </span>
                            </div>
                            {% else %}
                            <a href="{% url 'estadisticas_control' sibling.id %}" 
                               onclick="loadControlData(event, {{ sibling.id }}, this)"
                               data-id="{{ sibling.id }}"
                               class="list-group-item list-group-item-action d-flex align-items-center justify-content-between px-3 py-2 control-list-item"
                               style="font-size: 0.85rem; transition: all 0.2s; border: none; border-left: 3px solid transparent; background: transparent; {% if sibling.id == tolerancia.id %}background-color: rgba(59, 130, 246, 0.15) !important; color: #60a5fa !important; font-weight: 600; border-left-color: #3b82f6 !important;{% else %}color: var(--text-secondary, #94a3b8);{% endif %}">
                                <span class="text-truncate d-flex align-items-center gap-2" style="flex: 1;">
                                    {{ sibling.control.nombre }}
                                </span>
                                {% if sibling.id == tolerancia.id %}
                                <i class="ri-arrow-right-s-line"></i>
                                {% endif %}
                            </a>
                            {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Charts Gallery (Fills Remaining Space) -->
        <div style="flex: 1; min-width: 0;">
            <!-- Main Large Viewer -->
            <div class="card border-0 shadow-sm mb-4 animate__animated animate__fadeIn" style="border-radius: 16px;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0" id="mainChartTitle" style="font-size: 1.1rem; color: #1e293b; text-transform: uppercase; letter-spacing: 0.05em;">
                            Gráfico de Medidas
                        </h5>
                        <div class="badge bg-light text-dark border">Vista Detallada</div>
                    </div>
                    
                    <div style="position: relative; height: 42vh; width: 100%;" id="chartContainer">
                        <canvas id="mainChartCanvas"></canvas>
                    </div>
                </div>
            </div>

            <!-- Thumbnails Selector (Flex Fit) -->
            <div class="d-flex gap-2 w-100">
                <div style="flex: 1; min-width: 0;">
                    <div class="card border-0 shadow-sm h-100 chart-thumb active" onclick="switchChart('trend', 'Gráfico de Medidas', this)" style="cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                        <div class="card-body p-2 text-center">
                            <h6 class="text-xxs fw-bold mb-2 text-truncate">MEDIDAS</h6>
                            <div style="height: 60px; width: 100%;"><canvas id="thumbTrend"></canvas></div>
                        </div>
                    </div>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div class="card border-0 shadow-sm h-100 chart-thumb" onclick="switchChart('range', 'Gráfico de Amplitud (R)', this)" style="cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                        <div class="card-body p-2 text-center">
                            <h6 class="text-xxs fw-bold mb-2 text-truncate">RANGOS</h6>
                            <div style="height: 60px; width: 100%;"><canvas id="thumbRange"></canvas></div>
                        </div>
                    </div>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div class="card border-0 shadow-sm h-100 chart-thumb" onclick="switchChart('freq', 'Distribución de Frecuencias', this)" style="cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                        <div class="card-body p-2 text-center">
                            <h6 class="text-xxs fw-bold mb-2 text-truncate">HISTOGRAMA</h6>
                            <div style="height: 60px; width: 100%;"><canvas id="thumbFreq"></canvas></div>
                        </div>
                    </div>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div class="card border-0 shadow-sm h-100 chart-thumb" onclick="switchChart('gauss', 'Campana de Gauss (Capabilidad)', this)" style="cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                        <div class="card-body p-2 text-center">
                            <h6 class="text-xxs fw-bold mb-2 text-truncate">CAPABILIDAD</h6>
                            <div style="height: 60px; width: 100%;"><canvas id="thumbGauss"></canvas></div>
                        </div>
                    </div>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div class="card border-0 shadow-sm h-100 chart-thumb" onclick="switchChart('pie', 'Estatus de Lote', this)" style="cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                        <div class="card-body p-2 text-center">
                            <h6 class="text-xxs fw-bold mb-2 text-truncate">ESTATUS</h6>
                            <div style="height: 60px; width: 100%;"><canvas id="thumbPie"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Smart Alerts Panel (REUBICADO AL FONDO) -->
            <div id="alertsPanel" class="config-card mt-3 animate__animated animate__fadeInUp" style="border-top: 3px solid {% if stats.alerts %}#ef4444{% else %}#10b981{% endif %}; background: var(--bg-card, #161c2d); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px;">
                <div class="config-card-header" style="background: rgba(255,255,255,0.03); color: var(--text-primary, #fff); border-bottom: 1px solid rgba(255,255,255,0.05); padding: 0.6rem 1rem;">
                    <div class="d-flex align-items-center justify-content-between w-100">
                        <div class="d-flex align-items-center gap-2">
                            <i class="ri-radar-line {% if stats.alerts %}text-danger animate__animated animate__pulse animate__infinite{% else %}text-success{% endif %}" style="font-size: 1.1rem;"></i>
                            <span style="font-weight: 800; font-size: 0.85rem; letter-spacing: 0.05em; color: var(--text-primary, #fff);">ALERTAS INTELIGENTES DEL PROCESO</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            {% if stats.alerts %}
                            <button onclick="showDiagnosticReport()" class="btn btn-sm btn-danger d-flex align-items-center gap-1 shadow-danger" style="font-weight: 700; border-radius: 8px; font-size: 0.7rem; padding: 0.4rem 0.8rem;">
                                <i class="ri-article-line"></i> GENERAR INFORME DETALLADO
                            </button>
                            <span class="badge" style="font-size: 0.7rem; font-weight: 700; background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3);">{{ stats.alerts|length }} ANOMALÍAS DETECTADAS</span>
                            {% else %}
                            <i class="ri-checkbox-circle-fill text-success"></i>
                            <span class="badge" style="font-size: 0.7rem; font-weight: 700; background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3);">PROCESO ESTABLE</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="config-card-body p-2" style="background: {% if stats.alerts %}rgba(239, 68, 68, 0.05){% else %}rgba(16, 185, 129, 0.03){% endif %};">
                    {% if stats.alerts %}
                        <div class="row g-2">
                            {% for alert in stats.alerts %}
                            <div class="col-md-4">
                                <div class="d-flex gap-2 p-2 rounded border-start border-3 border-{{ alert.type }}" style="background: var(--bg-card, #161c2d); box-shadow: 0 1px 3px rgba(0,0,0,0.2); height: 100%;">
                                    <i class="{{ alert.icon }} text-{{ alert.type }}" style="font-size: 1.2rem; margin-top: 2px;"></i>
                                    <div>
                                        <div class="fw-bold" style="font-size: 0.75rem; color: var(--text-primary, #fff);">{{ alert.title }}</div>
                                        <div style="font-size: 0.7rem; line-height: 1.2; color: var(--text-secondary, #94a3b8);">{{ alert.desc }}</div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center gap-3 py-1">
                            <i class="ri-shield-check-line text-success" style="font-size: 1.5rem;"></i>
                            <p class="mb-0" style="font-size: 0.8rem; font-weight: 500; color: var(--text-secondary, #94a3b8);">
                                El análisis estadístico no detecta tendencias, rachas o puntos fuera de control. 
                                <span class="text-success fw-bold">El proceso se mantiene estable.</span>
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>



<style>
    /* Hide Vertical Scroll globally for this view */
    body { overflow: hidden !important; }

    .shadow-danger {
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4) !important;
    }
    .shadow-danger:hover {
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6) !important;
        transform: translateY(-1px);
    }

    /* Custom Scrollbar for side panel - Dark Theme */
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }

    /* Dark Theme Stats Table */
    .stats-table-dark { 
        background: transparent;
    }
    .stats-table-dark td { 
        padding: 0.55rem 0.75rem; 
        font-size: 0.85rem; 
        border-bottom: 1px solid rgba(255,255,255,0.05);
        color: var(--text-secondary, #94a3b8);
    }
    .stats-table-dark td:first-child {
        color: var(--text-muted, #64748b);
        font-weight: 500;
    }
    .stats-table-dark td:last-child {
        color: var(--text-primary, #fff);
    }
    .stats-table-dark tr:last-child td { border: none; }
    .stats-table-dark tr.table-highlight td {
        background: rgba(239, 68, 68, 0.1);
    }
    .stats-table-dark .text-danger {
        color: #f87171 !important;
    }

    /* Control list item styles */
    .control-list-item {
        text-decoration: none !important;
        border-bottom: 1px solid rgba(255,255,255,0.03) !important;
    }
    .control-list-item:hover {
        background: rgba(255,255,255,0.05) !important;
        color: var(--text-primary, #fff) !important;
        text-decoration: none !important;
    }
    .control-list-item:focus,
    .control-list-item:active {
        text-decoration: none !important;
        outline: none;
    }
    
    /* Override Bootstrap list-group-item styles */
    .list-group-item.control-list-item {
        background-color: transparent !important;
        border: none !important;
        border-left: 3px solid transparent !important;
        border-bottom: 1px solid rgba(255,255,255,0.03) !important;
    }
    .list-group-item.control-list-item:last-child {
        border-bottom: none !important;
    }
    
    .btn-back-simple {
        color: #94a3b8;
        font-size: 0.85rem;
        font-weight: 600;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.8rem;
        background: var(--bg-card, #161c2d);
        border-radius: 8px;
        transition: 0.2s;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .btn-back-simple:hover { background: rgba(255,255,255,0.05); color: #fff; }

    .chart-thumb:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3) !important;
        border: 1px solid #3b82f6 !important;
    }
    .chart-thumb.active {
        border: 2px solid #3b82f6 !important;
        background: rgba(59, 130, 246, 0.1);
    }

    /* Soft Badges for CP/CPK */
    .badge-soft-danger {
        background-color: rgba(239, 68, 68, 0.2) !important;
        color: #f87171 !important;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    .badge-soft-warning {
        background-color: rgba(245, 158, 11, 0.2) !important;
        color: #fbbf24 !important;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    .badge-soft-success {
        background-color: rgba(16, 185, 129, 0.2) !important;
        color: #34d399 !important;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }
    .badge-soft-excellent {
        background-color: rgba(6, 182, 212, 0.2) !important;
        color: #22d3ee !important;
        border: 1px solid rgba(6, 182, 212, 0.3);
    }

    /* Cards in dark mode */
    .card {
        background: var(--bg-card, #161c2d) !important;
        border: 1px solid rgba(255,255,255,0.05) !important;
    }
    .card-body h5, .card-body h6 {
        color: var(--text-primary, #fff) !important;
    }
    .text-xxs {
        font-size: 0.65rem;
        color: var(--text-muted, #64748b);
    }

    /* Premium Swal Design */
    .premium-swal-popup {
        border-radius: 45px !important;
        padding: 3.5rem 3rem !important;
        box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.3) !important;
        background: #ffffff !important;
    }
    .premium-confirm-btn {
        background-color: #2563eb !important;
        color: white !important;
        border-radius: 22px !important;
        padding: 18px 60px !important;
        font-weight: 800 !important;
        font-size: 1.2rem !important;
        border: none !important;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 12px !important;
        box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4) !important;
        width: auto !important;
        min-width: 200px !important;
    }
    .premium-confirm-btn:hover {
        background-color: #1d4ed8 !important;
        transform: translateY(-3px);
        box-shadow: 0 15px 30px -5px rgba(37, 99, 235, 0.5) !important;
    }
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const DATA = {
        points: {{ data_points_json|safe }},
        labels: {{ labels_json|safe }},
        stats: {{ stats_json|safe }}
    };

    // Global Instances
    let mainChartInstance = null;
    const thumbInstances = {};

    // --- Data Preparation Helpers ---
    function getTrendConfig(isThumb = false) {
        return {
            type: 'line',
            data: {
                labels: DATA.labels,
                datasets: [
                    {
                        label: 'Mediciones',
                        data: DATA.points,
                        borderColor: '#00d4ff', // Cyan neón
                        backgroundColor: 'rgba(0, 212, 255, 0.15)',
                        borderWidth: isThumb ? 2 : 3,
                        pointRadius: isThumb ? 0 : 5,
                        pointBackgroundColor: '#00d4ff',
                        pointBorderColor: '#fff',
                        tension: 0,
                        order: 1
                    },
                    // --- Reference Lines (Only for Main Chart) ---
                    (!isThumb && typeof DATA.stats.mean === 'number') ? {
                        label: 'Media (X̄)',
                        data: DATA.labels.map(() => DATA.stats.mean),
                        borderColor: '#00ff88', // Verde neón
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        order: 2
                    } : null,
                    (!isThumb && typeof DATA.stats.lsc === 'number') ? {
                        label: 'Límites Control (LSC)',
                        data: DATA.labels.map(() => DATA.stats.lsc),
                        borderColor: '#ff4d6a', // Rosa neón
                        borderWidth: 2,
                        borderDash: [4, 4],
                        pointRadius: 0,
                        order: 3
                    } : null,
                    (!isThumb && typeof DATA.stats.lic === 'number') ? {
                        label: 'Límites Control (LIC)',
                        data: DATA.labels.map(() => DATA.stats.lic),
                        borderColor: '#ff4d6a', // Rosa neón
                        borderWidth: 2,
                        borderDash: [4, 4],
                        pointRadius: 0,
                        order: 3
                    } : null,
                    (!isThumb && typeof DATA.stats.usl === 'number') ? {
                        label: 'Límites Tol. (LSE)',
                        data: DATA.labels.map(() => DATA.stats.usl),
                        borderColor: '#ffcc00', // Amarillo neón
                        borderWidth: 2,
                        pointRadius: 0,
                        order: 4
                    } : null,
                    (!isThumb && typeof DATA.stats.lsl === 'number') ? {
                        label: 'Límites Tol. (LIE)',
                        data: DATA.labels.map(() => DATA.stats.lsl),
                        borderColor: '#ffcc00', // Amarillo neón
                        borderWidth: 2,
                        pointRadius: 0,
                        order: 4
                    } : null
                ].filter(Boolean)
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: { 
                    legend: { 
                        display: !isThumb,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            boxWidth: 8,
                            color: '#1e293b',
                            padding: 20
                        }
                    }, 
                    tooltip: { enabled: !isThumb } 
                },
                scales: {
                    x: { 
                        display: !isThumb, 
                        grid: { display: false },
                        ticks: { color: '#475569' }
                    },
                    y: { 
                        display: !isThumb,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { color: '#475569' }
                    }
                }
            }
        };
    }

    function getRangeConfig(isThumb = false) {
        const ranges = DATA.points.map((v, i) => i === 0 ? null : Math.abs(v - DATA.points[i-1]));
        return {
            type: 'line',
            data: {
                labels: DATA.labels,
                datasets: [
                    {
                        label: 'Rango Móvil',
                        data: ranges,
                        borderColor: '#a855f7', // Violeta neón
                        backgroundColor: 'rgba(168, 85, 247, 0.15)',
                        borderWidth: isThumb ? 2 : 3,
                        pointRadius: isThumb ? 0 : 4,
                        pointBackgroundColor: '#a855f7',
                        pointBorderColor: '#fff',
                        tension: 0,
                        order: 1
                    },
                    // --- Reference Lines (Only for Main Chart) ---
                    (!isThumb && typeof DATA.stats.r_mean === 'number') ? {
                        label: 'Rango Medio (R̄)',
                        data: DATA.labels.map(() => DATA.stats.r_mean),
                        borderColor: '#00ff88', // Verde neón
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        order: 2
                    } : null,
                    (!isThumb && typeof DATA.stats.r_lsc === 'number') ? {
                        label: 'Límites Control (LSC)',
                        data: DATA.labels.map(() => DATA.stats.r_lsc),
                        borderColor: '#ff4d6a', // Rosa neón
                        borderWidth: 2,
                        borderDash: [4, 4],
                        pointRadius: 0,
                        order: 3
                    } : null,
                    (!isThumb && typeof DATA.stats.r_lic === 'number') ? { // Check undefined/null specifically as it might be 0
                        label: 'Límites Control (LIC)',
                        data: DATA.labels.map(() => DATA.stats.r_lic),
                        borderColor: '#ff4d6a', // Rosa neón
                        borderWidth: 2,
                        borderDash: [4, 4],
                        pointRadius: 0,
                        order: 3
                    } : null
                ].filter(Boolean)
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: { 
                    legend: { 
                        display: !isThumb,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            boxWidth: 8,
                            color: '#1e293b',
                            padding: 20
                        }
                    },
                    tooltip: { enabled: !isThumb } 
                },
                scales: {
                    x: { 
                        display: !isThumb, 
                        grid: { display: false },
                        ticks: { color: '#475569' }
                    },
                    y: { 
                        display: !isThumb, 
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { color: '#475569' }
                    }
                }
            }
        };
    }

    function getFreqConfig(isThumb = false) {
        if (!DATA.points || DATA.points.length === 0) return null;
        
        const bins = 8;
        const min = Math.min(...DATA.points);
        const max = Math.max(...DATA.points);
        // Ensure non-zero range
        const safeMax = max === min ? max + 1 : max;
        const binWidth = (safeMax - min) / bins;
        
        const freqData = new Array(bins).fill(0);
        DATA.points.forEach(v => {
            let b = Math.floor((v - min) / binWidth);
            if (b >= bins) b = bins - 1;
            freqData[b]++;
        });
        
        const labels = freqData.map((_, i) => (min + i * binWidth + binWidth/2).toFixed(3)); // Midpoint labels
        
        return {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Frecuencia',
                        data: freqData,
                        backgroundColor: 'rgba(99, 102, 241, 0.5)', // Indigo
                        borderColor: '#6366f1',
                        borderWidth: 1,
                        barPercentage: 0.95,
                        categoryPercentage: 0.95,
                        order: 2
                    },
                    {
                        type: 'line',
                        label: 'Polígono',
                        data: freqData,
                        borderColor: '#10b981', // Emerald
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: isThumb ? 1 : 2,
                        tension: 0.1,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#10b981',
                        pointRadius: isThumb ? 0 : 4,
                        order: 1,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { 
                    legend: { 
                        display: !isThumb, 
                        position: 'top',
                        labels: { color: '#1e293b', padding: 20 }
                    }, 
                    tooltip: { enabled: !isThumb } 
                },
                scales: {
                    x: { 
                        display: !isThumb, 
                        grid: { display: false },
                        ticks: { color: '#475569' }
                    },
                    y: { 
                        display: !isThumb, 
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { color: '#475569' }
                    }
                }
            }
        };
    }

    function getGaussConfig(isThumb = false) {
        const mean = DATA.stats.mean;
        const std = DATA.stats.stdev || 0.0001; 
        const nominal = DATA.stats.nominal || mean;
        
        // Calculate Specified Sigma based on Tolerance / 6 (Cp=1 basis)
        let specStd = null;
        let target = nominal;

        if (typeof DATA.stats.usl === 'number' && typeof DATA.stats.lsl === 'number') {
             specStd = (DATA.stats.usl - DATA.stats.lsl) / 6;
             target = (DATA.stats.usl + DATA.stats.lsl) / 2;
        } else if (typeof DATA.stats.usl === 'number') {
            // One sided Upper: treat distance from nominal to USL as 3 sigma
            specStd = Math.abs(DATA.stats.usl - nominal) / 3;
        } else if (typeof DATA.stats.lsl === 'number') {
            // One sided Lower
            specStd = Math.abs(nominal - DATA.stats.lsl) / 3;
        }
        
        if (specStd <= 0 || specStd === null) specStd = std;

        // --- Determine X-Axis Range to fit BOTH curves ---
        const range1 = [mean - 4.5 * std, mean + 4.5 * std];
        const range2 = [target - 4.5 * specStd, target + 4.5 * specStd];
        
        const start = Math.min(range1[0], range2[0]);
        const end = Math.max(range1[1], range2[1]);
        const step = (end - start) / 80;

        // --- Generate Data ---
        const gaussDataObtenido = [];
        const gaussDataEspecificado = [];
        
        let maxY = 0;
        
        for (let x = start; x <= end; x += step) {
            // Actual Process Curve (Blue)
            const y1 = (1 / (std * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - mean) / std, 2));
            gaussDataObtenido.push({x: x, y: y1});
            
            // Specified Curve (Red)
            const y2 = (1 / (specStd * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - target) / specStd, 2));
            gaussDataEspecificado.push({x: x, y: y2});

            if(y1 > maxY) maxY = y1;
            if(y2 > maxY) maxY = y2;
        }

        // Helper for vertical lines
        const createVerticalLine = (val, color, label) => (val !== null && val !== undefined) ? ({
            label: label,
            data: [{x: val, y: 0}, {x: val, y: maxY * 1.05}],
            borderColor: color,
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            type: 'line',
            fill: false,
            showLine: true,
            order: 0
        }) : null;

        return {
            type: 'line',
            data: {
                datasets: [
                    // Actual Process
                    {
                        label: 'Obtenido',
                        data: gaussDataObtenido,
                        borderColor: '#0284c7', // Sky 600
                        backgroundColor: 'rgba(2, 132, 199, 0.2)',
                        borderWidth: isThumb ? 1 : 3,
                        pointRadius: 0,
                        fill: true,
                        tension: 0.4,
                        order: 2
                    },
                    // Curve Legend Update
                    (!isThumb) ? {
                        label: 'Curva Ideal (Teórica)',
                        data: gaussDataEspecificado,
                        borderColor: '#ef4444',
                        borderWidth: 2,
                        borderDash: [4, 4],
                        pointRadius: 0,
                        fill: false,
                        tension: 0.4,
                        order: 1
                    } : null,
                    
                    !isThumb ? createVerticalLine(DATA.stats.mean, '#0284c7', 'Media (X̄)') : null,
                    !isThumb ? createVerticalLine(DATA.stats.nominal, '#ef4444', 'Nominal (Objetivo)') : null,
                    // Engineering Limits (Tolerances)
                    !isThumb ? createVerticalLine(DATA.stats.lsl, '#ef4444', 'Tolerancia Mín. (LIE)') : null,
                    !isThumb ? createVerticalLine(DATA.stats.usl, '#ef4444', 'Tolerancia Máx. (LSE)') : null,
                    // Natural Process Limits (Real Capacity)
                    !isThumb ? createVerticalLine(DATA.stats.lic, '#f59e0b', 'Capacidad Real Mín. (LIC)') : null,
                    !isThumb ? createVerticalLine(DATA.stats.lsc, '#f59e0b', 'Capacidad Real Máx. (LSC)') : null
                ].filter(Boolean)
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'nearest', axis: 'x', intersect: false },
                plugins: { 
                    legend: { 
                        display: !isThumb, 
                        position: 'top',
                        labels: { color: '#1e293b', padding: 20 }
                    }, 
                    tooltip: { enabled: !isThumb, callbacks: { title: (ctx) => 'Valor: ' + ctx[0].parsed.x.toFixed(4) } } 
                },
                scales: { 
                    x: { 
                        type: 'linear', 
                        display: !isThumb,
                        min: start,
                        max: end,
                        grid: { display: true, color: 'rgba(0,0,0,0.05)' },
                        ticks: { color: '#475569' }
                    },
                    y: { 
                        display: !isThumb, 
                        beginAtZero: true, 
                        grid: { display: false },
                        ticks: { color: '#475569' }
                    } 
                },
                elements: { point: { radius: 0 } }
            }
        };
    }

    function getPieConfig(isThumb = false) {
        // Use pre-calculated values from backend
        const approved = DATA.stats.n_approved || 0;
        const rejected = DATA.stats.n_rejected || 0;
        const total = DATA.stats.n_total || 0;
        
        const approvedPct = total ? ((approved / total) * 100).toFixed(1) : 0;

        return {
            type: 'doughnut',
            data: {
                labels: [`Aceptadas (${approved})`, `Rechazadas (${rejected})`],
                datasets: [{
                    data: [approved, rejected],
                    backgroundColor: ['#10b981', '#ef4444'], // Emerald, Red
                    borderColor: '#ffffff',
                    borderWidth: 2,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: { 
                        display: !isThumb, 
                        position: 'right',
                        labels: { color: '#1e293b', padding: 20 }
                    },
                    tooltip: { 
                        enabled: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                let value = context.parsed;
                                let pct = total ? ((value / total) * 100).toFixed(1) + '%' : '';
                                return label + value + ' (' + pct + ')';
                            }
                        }
                    },
                    title: {
                        display: !isThumb,
                        text: `Índice de Aprobación: ${approvedPct}% (${approved}/${total} piezas)`,
                        position: 'bottom',
                        font: { size: 16, weight: 'bold' },
                        color: '#1e293b'
                    }
                }
            }
        };
    }

    // --- Switcher Logic ---
    function switchChart(type, title, element) {
        try {
            document.getElementById('mainChartTitle').innerText = title;
            
            if (mainChartInstance) mainChartInstance.destroy();
            
            const canvas = document.getElementById('mainChartCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let config;
            
            switch(type) {
                case 'trend': config = getTrendConfig(false); break;
                case 'range': config = getRangeConfig(false); break;
                case 'freq': config = getFreqConfig(false); break;
                case 'gauss': config = getGaussConfig(false); break;
                case 'pie': config = getPieConfig(false); break;
            }
            
            if (config) {
                mainChartInstance = new Chart(ctx, config);
            } else {
                // If config is null (e.g. no data for freq), show a message or clear
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = "16px sans-serif";
                ctx.textAlign = "center";
                ctx.fillText("Sin datos suficientes para este gráfico", canvas.width/2, canvas.height/2);
            }
        } catch (err) {
            console.error("Error switching chart:", err);
        }

        // Update active class on thumbnails
        if (element) {
            document.querySelectorAll('.chart-thumb').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }
    }

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
        try {
            const safeInit = (id, config) => {
                const el = document.getElementById(id);
                if (el && config) {
                    if (thumbInstances[id]) thumbInstances[id].destroy();
                    thumbInstances[id] = new Chart(el, config);
                }
            };
            // Init Thumbnails
            safeInit('thumbTrend', getTrendConfig(true));
            safeInit('thumbRange', getRangeConfig(true));
            safeInit('thumbFreq', getFreqConfig(true));
            safeInit('thumbGauss', getGaussConfig(true));
            safeInit('thumbPie', getPieConfig(true));
    
            switchChart('trend', 'Gráfico de Medidas');
        } catch (err) {
            console.warn("Init error:", err);
        }
    });
    async function loadControlData(event, controlId, element) {
        event.preventDefault();
        
        // Update Sidebar UI immediately for better feedback
        document.querySelectorAll('.control-list-item').forEach(el => {
            el.style.setProperty('background-color', 'transparent', 'important');
            el.style.setProperty('color', 'var(--text-secondary, #94a3b8)', 'important');
            el.style.fontWeight = 'normal';
            el.style.borderLeftColor = 'transparent';
        });
        element.style.setProperty('background-color', 'rgba(59, 130, 246, 0.15)', 'important');
        element.style.setProperty('color', '#60a5fa', 'important');
        element.style.fontWeight = '600';
        element.style.borderLeftColor = '#3b82f6';

        try {
            const response = await fetch(`/mediciones/estadisticas/${controlId}/`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await response.json();

            // 1. Update Global Data Object
            DATA.stats = data.stats;
            DATA.points = data.data_points;
            DATA.labels = data.labels;

            // 2. Update Headers
            document.getElementById('controlTitleHeader').innerText = `SEGUIMIENTO DE PARÁMETROS: ${data.control_nombre}`;
            document.getElementById('controlSubHeader').innerText = `Proyecto: ${data.proyecto} | OP: ${data.num_op} | Proceso: ${data.proceso_nombre} | Cliente: ${data.cliente}`;
            document.getElementById('btnVolver').href = `/mediciones/nueva/?proy=${data.proyecto}&op=${data.num_op}&proc=${data.proceso_id}`;
            
            // Top Report Button Visibility
            const topReportBtn = document.getElementById('topReportBtn');
            if (data.stats.alerts.length > 0) {
                topReportBtn.style.setProperty('display', 'flex', 'important');
            } else {
                topReportBtn.style.setProperty('display', 'none', 'important');
            }

            // 3. Update Stats Table
            document.getElementById('stat-mean').innerText = parseFloat(data.stats.mean).toFixed(2);
            document.getElementById('stat-lic').innerText = parseFloat(data.stats.lic).toFixed(2);
            document.getElementById('stat-lsc').innerText = parseFloat(data.stats.lsc).toFixed(2);
            document.getElementById('stat-range').innerText = parseFloat(data.stats.range).toFixed(2);
            document.getElementById('stat-n').innerText = data.stats.n;
            document.getElementById('stat-stdev').innerText = parseFloat(data.stats.stdev).toFixed(2);
            document.getElementById('stat-usl').innerText = data.stats.usl ? parseFloat(data.stats.usl).toFixed(2) : "N/A";
            document.getElementById('stat-lsl').innerText = data.stats.lsl ? parseFloat(data.stats.lsl).toFixed(2) : "N/A";
            
            // CP/CPK Badges
            const cpContainer = document.getElementById('stat-cp-container');
            cpContainer.innerHTML = `<span class="fw-bold">${data.stats.cp || 'N/D'}</span>`;
            if (data.stats.cp && data.stats.cp_info) {
                cpContainer.innerHTML += `<span class="badge ${data.stats.cp_info.class}" style="font-size: 0.7rem;">${data.stats.cp_info.text}</span>`;
            }

            const cpkContainer = document.getElementById('stat-cpk-container');
            cpkContainer.innerHTML = `<span class="fw-bold">${data.stats.cpk || 'N/D'}</span>`;
            if (data.stats.cpk && data.stats.cpk_info) {
                cpkContainer.innerHTML += `<span class="badge ${data.stats.cpk_info.class}" style="font-size: 0.7rem;">${data.stats.cpk_info.text}</span>`;
            }

            // 4. Update Alerts Panel
            const alertsPanel = document.getElementById('alertsPanel');
            alertsPanel.style.borderTopColor = data.stats.alerts.length > 0 ? '#ef4444' : '#10b981';
            
            let alertsHtml = `
                <div class="config-card-header" style="background: rgba(255,255,255,0.03); color: var(--text-primary, #fff); border-bottom: 1px solid rgba(255,255,255,0.05); padding: 0.6rem 1rem;">
                    <div class="d-flex align-items-center justify-content-between w-100">
                        <div class="d-flex align-items-center gap-2">
                            <i class="ri-radar-line ${data.stats.alerts.length > 0 ? 'text-danger animate__animated animate__pulse animate__infinite' : 'text-success'}" style="font-size: 1.1rem;"></i>
                            <span style="font-weight: 800; font-size: 0.85rem; letter-spacing: 0.05em; color: var(--text-primary, #fff);">ALERTAS INTELIGENTES DEL PROCESO</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            ${data.stats.alerts.length > 0 ? `
                                <button onclick="showDiagnosticReport()" class="btn btn-sm btn-danger d-flex align-items-center gap-1 shadow-danger" style="font-weight: 700; border-radius: 8px; font-size: 0.7rem; padding: 0.4rem 0.8rem;">
                                    <i class="ri-article-line"></i> GENERAR INFORME DETALLADO
                                </button>
                                <span class="badge" style="font-size: 0.7rem; font-weight: 700; background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3);">${data.stats.alerts.length} ANOMALÍAS DETECTADAS</span>
                            ` : `
                                <i class="ri-checkbox-circle-fill text-success"></i>
                                <span class="badge" style="font-size: 0.7rem; font-weight: 700; background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3);">PROCESO ESTABLE</span>
                            `}
                        </div>
                    </div>
                </div>
                <div class="config-card-body p-2" style="background: ${data.stats.alerts.length > 0 ? 'rgba(239, 68, 68, 0.05)' : 'rgba(16, 185, 129, 0.03)'};">`;

            if (data.stats.alerts.length > 0) {
                alertsHtml += '<div class="row g-2">';
                data.stats.alerts.forEach(alert => {
                    alertsHtml += `
                        <div class="col-md-4">
                            <div class="d-flex gap-2 p-2 rounded border-start border-3 border-${alert.type}" style="background: var(--bg-card, #161c2d); box-shadow: 0 1px 3px rgba(0,0,0,0.2); height: 100%;">
                                <i class="${alert.icon} text-${alert.type}" style="font-size: 1.2rem; margin-top: 2px;"></i>
                                <div>
                                    <div class="fw-bold" style="font-size: 0.75rem; color: var(--text-primary, #fff);">${alert.title}</div>
                                    <div style="font-size: 0.7rem; line-height: 1.2; color: var(--text-secondary, #94a3b8);">${alert.desc}</div>
                                </div>
                            </div>
                        </div>`;
                });
                alertsHtml += '</div>';
            } else {
                alertsHtml += `
                    <div class="d-flex align-items-center justify-content-center gap-3 py-1">
                        <i class="ri-shield-check-line text-success" style="font-size: 1.5rem;"></i>
                        <p class="mb-0" style="font-size: 0.8rem; font-weight: 500; color: var(--text-secondary, #94a3b8);">
                            El análisis estadístico no detecta tendencias, rachas o puntos fuera de control. 
                            <span class="text-success fw-bold">El proceso se mantiene estable.</span>
                        </p>
                    </div>`;
            }
            alertsHtml += '</div>';
            alertsPanel.innerHTML = alertsHtml;

            // 5. Re-render Charts (With small delay to ensure canvas is visible and has dimensions)
            setTimeout(() => {
                const activeThumb = document.querySelector('.chart-thumb.active');
                const chartType = activeThumb ? activeThumb.getAttribute('onclick').match(/'([^']+)'/)[1] : 'trend';
                const chartTitle = activeThumb ? activeThumb.querySelector('h6').innerText : 'Gráfico de Medidas';
                switchChart(chartType, chartTitle, activeThumb);
                
                const safeInit = (id, config) => {
                    const el = document.getElementById(id);
                    if (el && config) {
                        if (thumbInstances[id]) thumbInstances[id].destroy();
                        thumbInstances[id] = new Chart(el, config);
                    }
                };
                safeInit('thumbTrend', getTrendConfig(true));
                safeInit('thumbRange', getRangeConfig(true));
                safeInit('thumbFreq', getFreqConfig(true));
                safeInit('thumbGauss', getGaussConfig(true));
                safeInit('thumbPie', getPieConfig(true));
            }, 50);

            // 6. Update URL (Cleanly)
            window.history.pushState({}, '', `/mediciones/estadisticas/${controlId}/`);

        } catch (err) {
            console.error("Error loading control data:", err);
            // Fallback: Reload page if AJAX fails
            window.location.href = `/mediciones/estadisticas/${controlId}/`;
        }
    }

    // --- Full Screen Logic ---
    function toggleFullScreen() {
        const icon = document.getElementById('fsIcon');
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.error(`Error al intentar modo pantalla completa: ${err.message}`);
            });
            if (icon) {
                icon.classList.remove('ri-fullscreen-line');
                icon.classList.add('ri-fullscreen-exit-line');
            }
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
                if (icon) {
                    icon.classList.remove('ri-fullscreen-exit-line');
                    icon.classList.add('ri-fullscreen-line');
                }
            }
        }
    }

    // Listener for ESC key or exit system button
    document.addEventListener('fullscreenchange', () => {
        const icon = document.getElementById('fsIcon');
        if (!document.fullscreenElement && icon) {
            icon.classList.remove('ri-fullscreen-exit-line');
            icon.classList.add('ri-fullscreen-line');
        }
    });

    // --- Intelligent Diagnostic Report ---
    function showDiagnosticReport() {
        if (typeof Swal === 'undefined') return;

        const stats = DATA.stats;
        const alerts = stats.alerts || [];
        
        if (alerts.length === 0) {
            Swal.fire({
                icon: 'success',
                title: '<span style="color: #111827 !important; font-weight: 900;">Proceso Estable</span>',
                html: '<p style="color: #334155 !important; font-weight: 600;">No se detectaron anomalías relevantes en el análisis.</p>',
                confirmButtonText: 'Entendido',
                customClass: { 
                    popup: 'premium-swal-popup',
                    confirmButton: 'premium-confirm-btn'
                },
                buttonsStyling: false
            });
            return;
        }

        let contentHtml = `
            <div class="text-center" style="font-family: 'Inter', sans-serif;">
                <h2 class="fw-black mb-4" style="color: #111827 !important; font-size: 2.2rem; letter-spacing: -0.04em;">Diagnóstico del Proceso</h2>
                
                <div class="text-start custom-diagnostic-list mb-4" style="max-height: 450px; overflow-y: auto; padding-right: 15px;">
        `;

        alerts.forEach(alert => {
            let causes = "";
            let actions = "";
            
            if (alert.title.includes('Fuera de Control')) {
                causes = "Cambio brusco en el proceso o ajuste incorrecto de la máquina.";
                actions = "Parar producción de inmediato y recalibrar.";
            } else if (alert.title.includes('Racha')) {
                causes = "Variación en materia prima o desgaste térmico progresivo.";
                actions = "Observar próximos 5 puntos e inspeccionar refrigeración.";
            } else if (alert.title.includes('Tendencia')) {
                causes = "Desgaste progresivo de herramientas o acumulación de viruta.";
                actions = "Programar cambio de herramienta y revisar compensación.";
            } else if (alert.title.includes('Capacidad')) {
                causes = "La máquina no es capaz de mantener la precisión requerida para esta tolerancia.";
                actions = "Revisar holguras, herramental de alta precisión o reajustar parámetros de corte.";
            } else {
                causes = "Falta de estandarización o variabilidad del método.";
                actions = "Auditar el método de trabajo y verificar sujeción.";
            }

            contentHtml += `
                <div class="mb-4 p-4 rounded-4" style="background: #ffffff !important; border: 2px solid #f1f5f9; box-shadow: 0 10px 30px rgba(0,0,0,0.05);">
                    <!-- Sub-título Anomalia -->
                    <div class="d-flex align-items-center gap-3 mb-4">
                        <div style="padding: 12px; background: ${alert.type === 'danger' ? '#fee2e2' : '#fef3c7'}; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="${alert.icon}" style="font-size: 1.5rem; color: ${alert.type === 'danger' ? '#ef4444' : '#f59e0b'};"></i>
                        </div>
                        <div style="color: #111827 !important; font-size: 1.4rem; font-weight: 900 !important; letter-spacing: -0.02em;">${alert.title}</div>
                    </div>
                    
                    <div class="text-center mb-4" style="color: #334155 !important; font-size: 1.15rem; line-height: 1.6; font-weight: 600 !important;">
                        ${alert.desc}
                    </div>
                    
                    <div class="mt-4 pt-4 border-top text-center" style="border-color: #f1f5f9 !important;">
                        <!-- Titulo: Causa Probable -->
                        <div class="mb-4">
                            <span style="font-size: 1.15rem; font-weight: 900 !important; color: #111827 !important; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 10px;">Causa Probable</span>
                            <div style="color: #475569 !important; font-size: 1.05rem; font-weight: 700 !important;">${causes}</div>
                        </div>
                        <!-- Titulo: Accion Recomendada -->
                        <div class="mt-4">
                            <span style="font-size: 1.15rem; font-weight: 900 !important; color: #059669 !important; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 10px;">Acción Recomendada</span>
                            <div style="color: #059669 !important; font-size: 1.15rem; font-weight: 800 !important;">${actions}</div>
                        </div>
                    </div>
                </div>
            `;
        });

        contentHtml += `
                </div>
                <div class="mt-4 pt-2">
                    <p style="color: #94a3b8 !important; font-size: 0.85rem; font-style: italic; font-weight: 600;">
                        Análisis basado en reglas de control estadístico Western Electric.
                    </p>
                </div>
            </div>
            
            <style>
                .fw-black { font-weight: 900 !important; }
                .custom-diagnostic-list::-webkit-scrollbar { width: 6px; }
                .custom-diagnostic-list::-webkit-scrollbar-track { background: #f8fafc; border-radius: 10px; }
                .custom-diagnostic-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
            </style>
        `;

        Swal.fire({
            html: contentHtml,
            width: '700px',
            showCancelButton: false,
            confirmButtonText: '<i class="ri-check-line" style="font-size: 1.5rem;"></i> Entendido',
            buttonsStyling: false,
            customClass: {
                popup: 'premium-swal-popup',
                confirmButton: 'premium-confirm-btn',
                actions: 'justify-content-center mt-4 w-100'
            }
        });
    }

    // Handle browser back/forward buttons
    window.addEventListener('popstate', () => {
        window.location.reload();
    });
</script>
{% endblock %}
