{% extends 'mediciones/index.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="ec-page-wrapper">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-3">
            <div>
                <h1 id="controlTitleHeader" style="font-size: 1.5rem; font-weight: 800; color: #0f172a; margin: 0; letter-spacing: -0.025em;">
                    SEGUIMIENTO DE PARÁMETROS: {{ tolerancia.control.nombre }}
                </h1>
                <p id="controlSubHeader" style="color: #64748b; font-size: 0.95rem; margin: 0; font-weight: 500;">
                    Proyecto: {{ tolerancia.planilla.proyecto }} | OP: {{ tolerancia.planilla.num_op }} | Proceso: {{ tolerancia.planilla.proceso.nombre }} | Cliente: {{ tolerancia.planilla.cliente.nombre }}
                </p>
            </div>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <a id="btnReportePro" href="/mediciones/{{ tolerancia.planilla.id }}/exportar-pdf-pro/" class="btn shadow-danger d-flex align-items-center gap-2 px-3" style="border-radius: 12px; font-weight: 800; font-size: 0.8rem; height: 42px; border: none; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; text-decoration: none; letter-spacing: 0.02em;">
                <i class="ri-printer-line"></i> REPORTE PRO
            </a>
            
            <button id="topAlertBtn" onclick="showDiagnosticReport()" class="btn btn-danger animate__animated animate__pulse animate__infinite d-flex align-items-center justify-content-center shadow-danger" style="{% if not stats.alerts %}display: none !important;{% endif %} width: 42px; height: 42px; border-radius: 12px; border: none; background: #ef4444;">
                <i class="ri-error-warning-fill" style="font-size: 1.2rem;"></i>
            </button>
            
            <button onclick="toggleFullScreen()" class="btn shadow-sm d-flex align-items-center justify-content-center" style="width: 42px; height: 42px; border-radius: 12px; border: 1px solid #e2e8f0; background: #ffffff;" title="Pantalla Completa">
                <i class="ri-fullscreen-line" id="fsIcon" style="font-size: 1.2rem; color: #64748b;"></i>
            </button>

            <a id="btnVolver" href="{% url 'ingreso_mediciones' tolerancia.planilla.id %}" class="btn" style="background-color: #ef4444; color: white; padding: 0.6rem 1.5rem; border-radius: 12px; font-size: 0.9rem; font-weight: 700; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);">
                <i class="ri-arrow-left-line"></i> Volver
            </a>
        </div>
    </div>

    <!-- Stats & Charts Flex Container — FILA SIEMPRE (nunca colapsa) -->
    <!-- Main Grid Container -->
    <div class="ec-main-grid">
        
        <!-- COLUMNA IZQUIERDA -->
        <div class="ec-left-col">
            <!-- Estadísticos -->
            <div class="ec-stats-container">
                <div class="config-card" style="background: #ffffff; border: 1px solid #dbeafe; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); display: flex; flex-direction: column;">
                    <div class="config-card-header" style="background: #eff6ff; color: #2563eb; padding: 0.4rem 0.6rem; border-bottom: 1px solid #dbeafe; display: flex; align-items: center; gap: 0.4rem; flex-shrink: 0;">
                        <i class="ri-settings-5-line" style="font-size: 0.9rem;"></i>
                        <span style="font-weight: 800; letter-spacing: 0.05em; font-size: 0.72rem;">ESTADÍSTICOS X-R</span>
                    </div>
                    <div class="config-card-body p-0">
                        <table class="table table-sm mb-0 stats-table-compact">
                            <tr>
                                <td>Media (X̄) <span class="btn-info-help" onclick="showHelp('media')" title="Ver explicación"><i class="ri-information-line"></i></span></td>
                                <td class="text-end fw-bold" id="stat-mean">{{ stats.mean|floatformat:3 }}</td>
                            </tr>
                            <tr>
                                <td>L.I.C. <span class="btn-info-help" onclick="showHelp('lic')" title="Ver explicación"><i class="ri-information-line"></i></span></td>
                                <td class="text-end fw-bold" id="stat-lic">{{ stats.lic|floatformat:3 }}</td>
                            </tr>
                            <tr>
                                <td>L.S.C. <span class="btn-info-help" onclick="showHelp('lsc')" title="Ver explicación"><i class="ri-information-line"></i></span></td>
                                <td class="text-end fw-bold" id="stat-lsc">{{ stats.lsc|floatformat:3 }}</td>
                            </tr>
                            <tr>
                                <td>Rango (R) <span class="btn-info-help" onclick="showHelp('rango')" title="Ver explicación"><i class="ri-information-line"></i></span></td>
                                <td class="text-end fw-bold" id="stat-range">{{ stats.range|floatformat:3 }}</td>
                            </tr>
                            <tr>
                                <td>Lote (n) <span class="btn-info-help" onclick="showHelp('n')" title="Ver explicación"><i class="ri-information-line"></i></span></td>
                                <td class="text-end fw-bold" id="stat-n">{{ stats.n }}</td>
                            </tr>
                            <tr>
                                <td>Desv. Est. (σ) <span class="btn-info-help" onclick="showHelp('sigma')" title="Ver explicación"><i class="ri-information-line"></i></span></td>
                                <td class="text-end fw-bold" id="stat-stdev">{{ stats.stdev|floatformat:3 }}</td>
                            </tr>
                            <tr class="table-highlight">
                                <td>L.S.E. (TOL+) <span class="btn-info-help" onclick="showHelp('lse')" title="Ver explicación"><i class="ri-information-line"></i></span></td>
                                <td class="text-end fw-bold text-danger" id="stat-usl">{{ stats.usl|floatformat:3|default:"N/A" }}</td>
                            </tr>
                            <tr class="table-highlight">
                                <td>L.I.E. (TOL-) <span class="btn-info-help" onclick="showHelp('lie')" title="Ver explicación"><i class="ri-information-line"></i></span></td>
                                <td class="text-end fw-bold text-danger" id="stat-lsl">{{ stats.lsl|floatformat:3|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <td>Índice CP <span class="btn-info-help" onclick="showHelp('cp')" title="Ver explicación"><i class="ri-information-line"></i></span></td>
                                <td class="text-end">
                                    <div class="d-flex justify-content-end align-items-center gap-1" id="stat-cp-container">
                                        <span class="fw-bold">{{ stats.cp|default:"N/D" }}</span>
                                        {% if stats.cp and stats.cp_info %}
                                            <span class="badge {{ stats.cp_info.class }}" style="font-size: 0.6rem; padding: 0.15rem 0.3rem;">{{ stats.cp_info.text }}</span>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Índice CPK <span class="btn-info-help" onclick="showHelp('cpk')" title="Ver explicación"><i class="ri-information-line"></i></span></td>
                                <td class="text-end">
                                    <div class="d-flex justify-content-end align-items-center gap-1" id="stat-cpk-container">
                                        <span class="fw-bold">{{ stats.cpk|default:"N/D" }}</span>
                                        {% if stats.cpk and stats.cpk_info %}
                                            <span class="badge {{ stats.cpk_info.class }}" style="font-size: 0.6rem; padding: 0.15rem 0.3rem;">{{ stats.cpk_info.text }}</span>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Controles (EXPANDIBLE) -->
            <div class="ec-controls-container">
                <div class="config-card h-100" style="display: flex; flex-direction: column; overflow: hidden; background: #ffffff; border-radius: 12px; border: 1px solid #e0e7ff; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
                     <div class="config-card-header" style="background: #eef2ff; color: #4338ca; border-bottom: 1px solid #e0e7ff; padding: 0.4rem 0.6rem; flex-shrink: 0;">
                         <div class="d-flex align-items-center gap-2">
                            <i class="ri-list-check" style="font-size: 0.9rem;"></i>
                            <span style="font-weight: 800; font-size: 0.72rem; letter-spacing: 0.05em;">CONTROLES</span>
                         </div>
                    </div>
                    <div class="config-card-body p-0 custom-scrollbar" style="flex: 1; overflow-y: auto;">
                        <div class="list-group list-group-flush">
                            {% regroup controles_hermanos by planilla.elemento.nombre as element_list %}
                            {% for element in element_list %}
                                {% for sibling in element.list %}
                                {% if sibling.control.pnp %}
                                <div class="list-group-item d-flex align-items-center justify-content-between px-3 py-1.5"
                                     style="font-size: 0.8rem; background: transparent; color: #4b5563; opacity: 0.6; cursor: not-allowed; border: none;">
                                    <span class="text-truncate d-flex align-items-center gap-2" style="flex: 1;">
                                        {{ sibling.control.nombre }}
                                        <span class="badge rounded-pill" style="font-size: 0.6rem; font-weight: 500; background: rgba(0,0,0,0.05); color: #4b5563;">PnP</span>
                                    </span>
                                </div>
                                {% else %}
                                <a href="{% url 'estadisticas_control' sibling.id %}" 
                                   onclick="loadControlData(event, {{ sibling.id }}, this)"
                                   data-id="{{ sibling.id }}"
                                   class="list-group-item list-group-item-action d-flex align-items-center justify-content-between px-3 py-1.5 control-list-item"
                                   style="font-size: 0.8rem; transition: all 0.2s; border: none; border-left: 3px solid transparent; background: transparent; {% if sibling.id == tolerancia.id %}background-color: rgba(99, 102, 241, 0.1) !important; color: #4338ca !important; font-weight: 600; border-left-color: #6366f1 !important;{% else %}color: #475569;{% endif %}">
                                    <span class="text-truncate d-flex align-items-center gap-2" style="flex: 1;">
                                        {{ sibling.control.nombre }}
                                    </span>
                                    {% if sibling.id == tolerancia.id %}
                                    <i class="ri-arrow-right-s-line"></i>
                                    {% endif %}
                                </a>
                                {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLUMNA DERECHA -->
        <div class="ec-right-col">
            <!-- Gráficos -->
            <div class="ec-charts-container">
                <div class="card border-0 shadow-sm animate__animated animate__fadeIn mb-2" style="border-radius: 16px;">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="fw-bold mb-0" id="mainChartTitle" style="font-size: 1rem; color: #0f172a; text-transform: uppercase; letter-spacing: 0.05em;">
                                GRÁFICO DE MEDIDAS
                            </h5>
                            <div class="badge bg-light text-dark border" style="font-size: 0.65rem;">Vista Detallada</div>
                        </div>
                        <div style="position: relative; height: 45vh; width: 100%;" id="chartContainer">
                            <canvas id="mainChartCanvas"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Thumbnails Selector -->
                <div style="display: flex; gap: 0.5rem; flex-shrink: 0;">
                    <div style="flex: 1; min-width: 0;">
                        <div class="card border-0 shadow-sm h-100 chart-thumb active" onclick="switchChart('trend', 'GRÁFICO DE MEDIDAS', this)" style="cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                            <div class="card-body p-2 text-center">
                                <h6 class="text-xxs fw-bold mb-1 text-truncate">MEDIDAS</h6>
                                <div style="height: 40px; width: 100%;"><canvas id="thumbTrend"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div class="card border-0 shadow-sm h-100 chart-thumb" onclick="switchChart('range', 'GRÁFICO DE AMPLITUD (R)', this)" style="cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                            <div class="card-body p-2 text-center">
                                <h6 class="text-xxs fw-bold mb-1 text-truncate">RANGOS</h6>
                                <div style="height: 40px; width: 100%;"><canvas id="thumbRange"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div class="card border-0 shadow-sm h-100 chart-thumb" onclick="switchChart('freq', 'DISTRIBUCIÓN DE FRECUENCIAS', this)" style="cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                            <div class="card-body p-2 text-center">
                                <h6 class="text-xxs fw-bold mb-1 text-truncate">HISTOGRAMA</h6>
                                <div style="height: 40px; width: 100%;"><canvas id="thumbFreq"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div class="card border-0 shadow-sm h-100 chart-thumb" onclick="switchChart('gauss', 'CAMPANA DE GAUSS (CAPABILIDAD)', this)" style="cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                            <div class="card-body p-2 text-center">
                                <h6 class="text-xxs fw-bold mb-1 text-truncate">CAPABILIDAD</h6>
                                <div style="height: 40px; width: 100%;"><canvas id="thumbGauss"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div class="card border-0 shadow-sm h-100 chart-thumb" onclick="switchChart('pie', 'ESTATUS DE LOTE', this)" style="cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                            <div class="card-body p-2 text-center">
                                <h6 class="text-xxs fw-bold mb-1 text-truncate">ESTATUS</h6>
                                <div style="height: 40px; width: 100%;"><canvas id="thumbPie"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alertas (EXPANDIBLE) -->
            <div class="ec-alerts-container">
                <div id="alertsPanel" class="config-card h-100 animate__animated animate__fadeInUp" style="border-top: 3px solid {% if stats.alerts %}#ef4444{% else %}#10b981{% endif %}; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); display: flex; flex-direction: column; overflow: hidden;">
                    <div class="config-card-header" style="background: #ffffff; color: #0f172a; border-bottom: 1px solid #f1f5f9; padding: 0.6rem 1rem; flex-shrink: 0;">
                        <div class="d-flex align-items-center justify-content-between w-100">
                            <div class="d-flex align-items-center gap-2">
                                <i class="ri-radar-line {% if stats.alerts %}text-danger animate__animated animate__pulse animate__infinite{% else %}text-success{% endif %}" style="font-size: 1.1rem;"></i>
                                <span style="font-weight: 800; font-size: 0.75rem; letter-spacing: 0.02em; color: #334155;">ALERTAS INTELIGENTES DEL PROCESO</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                {% if stats.alerts %}
                                <button onclick="showDiagnosticReport()" class="btn btn-sm btn-danger d-flex align-items-center gap-1 shadow-danger" style="font-weight: 800; border-radius: 8px; font-size: 0.65rem; padding: 0.4rem 0.8rem; background: #ed1c24; border: none; text-transform: uppercase;">
                                    <i class="ri-article-line"></i> GENERAR INFORME DETALLADO
                                </button>
                                <span class="badge" style="font-size: 0.65rem; font-weight: 700; background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; padding: 0.45rem 0.8rem; border-radius: 8px; text-transform: uppercase;">
                                    {{ stats.alerts|length }} ANOMALÍAS DETECTADAS
                                </span>
                                {% else %}
                                <i class="ri-checkbox-circle-fill text-success" style="font-size: 1.1rem;"></i>
                                <span class="badge" style="font-size: 0.65rem; font-weight: 700; background: #ecfdf5; color: #10b981; border: 1px solid #d1fae5; padding: 0.45rem 0.8rem; border-radius: 8px;">PROCESO ESTABLE</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="config-card-body p-2 custom-scrollbar" style="flex: 1; overflow-y: auto; background: #fafafa;">
                        <div class="d-flex flex-wrap gap-2" id="alertsListContainer">
                            {% for alert in stats.alerts %}
                            <div class="alert-card animate__animated animate__fadeInIn" style="flex: 1; min-width: calc(50% - 0.5rem); background: #ffffff; border: 1px solid #fee2e2; border-left: 4px solid #ef4444; border-radius: 8px; padding: 0.6rem 0.8rem; display: flex; align-items: center; gap: 0.75rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                <div class="alert-icon-circle" style="width: 32px; height: 32px; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="ri-error-warning-fill text-danger" style="font-size: 1.1rem;"></i>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 800; font-size: 0.75rem; color: #991b1b; text-transform: uppercase; letter-spacing: 0.02em; margin-bottom: 0.1rem;">{{ alert.title }}</div>
                                    <div style="font-size: 0.72rem; color: #4b5563; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ alert.message }}">{{ alert.message }}</div>
                                </div>
                                <div class="alert-action" title="Ver detalles" style="cursor: pointer; color: #9ca3af;">
                                    <i class="ri-arrow-right-s-line"></i>
                                </div>
                            </div>
                            {% empty %}
                            <div class="d-flex flex-column align-items-center justify-content-center py-4 w-100" style="color: #94a3b8;">
                                <i class="ri-shield-check-line text-success mb-2" style="font-size: 2rem;"></i>
                                <span style="font-size: 0.75rem; font-weight: 600;">Proceso Operando con Normalidad</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div><!-- /ec-page-wrapper -->

<style>
    /* ===== LAYOUT OVERRIDE ===== */
    .ec-page-wrapper {
        padding: 0.75rem 1rem;
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        overflow-x: hidden;
        background: #f8fafc;
        gap: 0.75rem;
    }

    /* Grid principal de dos columnas */
    .ec-main-grid {
        display: flex !important;
        flex-direction: row !important;
        gap: 1rem;
        width: 100%;
        flex: 1;
        min-width: 0;
        min-height: 0;
        align-items: stretch;
        box-sizing: border-box;
    }

    .ec-left-col {
        flex: 0 0 250px;
        width: 250px;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        min-height: 0;
        min-width: 0;
    }

    .ec-right-col {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        min-height: 0;
    }

    .ec-stats-container, .ec-charts-container {
        flex-shrink: 0;
    }

    .ec-controls-container, .ec-alerts-container {
        flex: 1;
        min-height: 0;
    }

    .stats-table-compact { background: transparent; width: 100%; border-collapse: collapse; }
    .stats-table-compact td { 
        padding: 0.25rem 0.4rem; 
        font-size: 0.72rem; 
        border-bottom: 1px solid #f1f5f9;
        color: #475569;
        line-height: 1.1;
    }
    .stats-table-compact td:first-child { color: #64748b; font-weight: 500; }
    .stats-table-compact td:last-child { color: #0f172a; font-weight: 700; text-align: right; }
    .stats-table-compact tr.table-highlight td { background: rgba(239, 68, 68, 0.04); }

    /* Override: el card del gráfico principal no debe tener margin-bottom */
    .ec-right-col .card {
        margin-bottom: 0 !important;
    }

    .shadow-danger {
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4) !important;
    }
    .shadow-danger:hover {
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6) !important;
        transform: translateY(-1px);
    }

    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.25); }

    .stats-table-dark { background: transparent; }
    .stats-table-dark td { 
        padding: 0.55rem 0.75rem; 
        font-size: 0.85rem; 
        border-bottom: 1px solid #f1f5f9;
        color: #475569;
        vertical-align: middle;
    }
    .stats-table-dark td:first-child { color: #64748b; font-weight: 500; }
    .stats-table-dark td:last-child { color: #0f172a; font-weight: 600; }
    .stats-table-dark tr:last-child td { border: none; }
    .stats-table-dark tr.table-highlight td { background: rgba(239, 68, 68, 0.06); }
    .stats-table-dark .text-danger { color: #dc2626 !important; }

    .control-list-item {
        text-decoration: none !important;
        border-bottom: 1px solid #f1f5f9 !important;
        color: #475569 !important;
    }
    .control-list-item:hover {
        background: rgba(99, 102, 241, 0.06) !important;
        color: #4338ca !important;
        text-decoration: none !important;
    }
    .list-group-item.control-list-item {
        background-color: transparent !important;
        border: none !important;
        border-left: 3px solid transparent !important;
        border-bottom: 1px solid #f1f5f9 !important;
    }
    .list-group-item.control-list-item:last-child { border-bottom: none !important; }

    .chart-thumb:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3) !important;
        border: 1px solid #3b82f6 !important;
    }
    .chart-thumb.active {
        border: 2px solid #3b82f6 !important;
        background: rgba(59, 130, 246, 0.1);
    }

    .badge-soft-danger {
        background-color: rgba(239, 68, 68, 0.2) !important;
        color: #f87171 !important;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    .badge-soft-warning {
        background-color: rgba(245, 158, 11, 0.2) !important;
        color: #fbbf24 !important;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    .badge-soft-success {
        background-color: rgba(16, 185, 129, 0.2) !important;
        color: #34d399 !important;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }
    .badge-soft-excellent {
        background-color: rgba(6, 182, 212, 0.2) !important;
        color: #22d3ee !important;
        border: 1px solid rgba(6, 182, 212, 0.3);
    }

    .card {
        background: #ffffff !important;
        border: 1px solid #e2e8f0 !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08) !important;
    }
    .card-body h5, .card-body h6 {
        color: #0f172a !important;
    }
    .text-xxs {
        font-size: 0.65rem;
        color: #64748b;
    }

    /* Grid helpers para el panel de alertas */
    .row.g-2 { display: flex; flex-wrap: wrap; margin: -0.25rem; }
    .row.g-2 > .col-md-4 { padding: 0.25rem; flex: 0 0 33.333%; max-width: 33.333%; }
    @media (max-width: 900px) { .row.g-2 > .col-md-4 { flex: 0 0 50%; max-width: 50%; } }
    @media (max-width: 600px) { .row.g-2 > .col-md-4 { flex: 0 0 100%; max-width: 100%; } }

    /* Helpers adicionales */
    .fw-bold { font-weight: 700 !important; }
    .mb-3 { margin-bottom: 1rem !important; }
    .mb-0 { margin-bottom: 0 !important; }
    .p-4 { padding: 1.5rem !important; }
    .p-2 { padding: 0.5rem !important; }
    .p-0 { padding: 0 !important; }
    .px-3 { padding-left: 0.75rem !important; padding-right: 0.75rem !important; }
    .py-2 { padding-top: 0.5rem !important; padding-bottom: 0.5rem !important; }
    .py-1 { padding-top: 0.25rem !important; padding-bottom: 0.25rem !important; }
    .gap-3 { gap: 0.75rem; }
    .gap-1 { gap: 0.25rem; }
    .w-100 { width: 100%; }
    .text-end { text-align: right; }
    .text-truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .rounded { border-radius: 0.375rem; }
    .border-start { border-left-width: 1px; border-left-style: solid; }
    .border-3 { border-left-width: 3px !important; }
    .border-danger { border-color: #dc2626 !important; }
    .border-warning { border-color: #d97706 !important; }
    .border-success { border-color: #059669 !important; }
    .border-info { border-color: #2563eb !important; }
    .text-success { color: #059669 !important; }
    .text-danger { color: #dc2626 !important; }
    .text-warning { color: #d97706 !important; }
    .h-100 { height: 100%; }
    .list-group { display: flex; flex-direction: column; }
    .list-group-flush { border-radius: 0; }
    .list-group-item { position: relative; display: block; padding: 0.5rem 1rem; }
    .list-group-item-action { cursor: pointer; }
    .justify-content-end { justify-content: flex-end; }
    .justify-content-center { justify-content: center; }
    .table { width: 100%; border-collapse: collapse; }
    .table-sm td, .table-sm th { padding: 0.25rem 0.5rem; }
    .shadow-sm { box-shadow: 0 1px 2px rgba(0,0,0,0.05) !important; }
    .animate__fadeIn { animation: fadeIn 0.3s ease; }
    .animate__fadeInUp { animation: fadeInUp 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .border-0 { border: none !important; }
    .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
    .bg-light { background-color: #f8fafc !important; }
    .text-dark { color: #0f172a !important; }
    .border { border: 1px solid #e2e8f0 !important; }
    .badge.rounded-pill { border-radius: 50rem; }
    .badge.bg-light { background-color: #f1f5f9 !important; color: #475569 !important; border: 1px solid #e2e8f0; }
    .bg-danger { background-color: #dc2626 !important; }
    .bg-warning { background-color: #d97706 !important; }
    .bg-success { background-color: #059669 !important; }
    .badge.bg-danger { color: white !important; }
    .badge.bg-warning { color: white !important; }
    .badge.bg-success { color: white !important; }
    .badge.bg-warning.text-dark { color: #0f172a !important; }
    .ms-2 { margin-left: 0.5rem; }
    .ms-auto { margin-left: auto; }
    .rounded-pill { border-radius: 50rem !important; }
    .opacity-60 { opacity: 0.6; }

    .premium-swal-popup {
        border-radius: 45px !important;
        padding: 3.5rem 3rem !important;
        box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.3) !important;
        background: #ffffff !important;
    }
    .premium-confirm-btn {
        background-color: #2563eb !important;
        color: white !important;
        border-radius: 22px !important;
        padding: 18px 60px !important;
        font-weight: 800 !important;
        font-size: 1.2rem !important;
        border: none !important;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 12px !important;
        box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4) !important;
        width: auto !important;
        min-width: 200px !important;
    }
    .premium-confirm-btn:hover {
        background-color: #1d4ed8 !important;
        transform: translateY(-3px);
        box-shadow: 0 15px 30px -5px rgba(37, 99, 235, 0.5) !important;
    }

    .btn-info-help {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        background: rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        color: #64748b;
        font-size: 0.7rem;
        cursor: pointer;
        margin-left: 6px;
        transition: all 0.2s;
        vertical-align: middle;
    }
    .btn-info-help:hover {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
        transform: scale(1.1);
    }
</style>

<!-- Layout fix: quitar padding del content-wrapper para esta página -->
<script>
    (function() {
        const cw = document.querySelector('.content-wrapper');
        if (cw) {
            cw.style.padding = '0';
            cw.style.margin = '0';
            cw.style.maxWidth = '100%';
            cw.style.width = '100%';
            cw.style.overflowX = 'hidden';
        }
        document.body.style.overflowX = 'hidden';
    })();
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const DATA = {
        points: {{ data_points_json|safe }},
        labels: {{ labels_json|safe }},
        stats: {{ stats_json|safe }}
    };

    let mainChartInstance = null;
    const thumbInstances = {};

    function getTrendConfig(isThumb = false) {
        const useSubgroups = DATA.stats.x_bars && DATA.stats.x_bars.length > 0;
        const subgroupSize = 5;
        const datasets = [];

        datasets.push({
            label: 'Valores Obtenidos',
            data: DATA.points,
            borderColor: 'rgba(148, 163, 184, 0.4)',
            backgroundColor: 'rgba(148, 163, 184, 0.2)',
            borderWidth: 1.5,
            pointRadius: isThumb ? 0 : 4,
            pointBackgroundColor: 'rgba(148, 163, 184, 0.6)',
            fill: false,
            tension: 0.1,
            order: 5,
            showLine: true
        });

        if (useSubgroups && !isThumb) {
            const xBarData = [];
            for (let i = 0; i < DATA.stats.x_bars.length; i++) {
                const pos = ((i + 1) * subgroupSize) - 1;
                xBarData.push({ x: DATA.labels[pos], y: DATA.stats.x_bars[i] });
            }
            datasets.push({
                label: 'Promedio Subgrupo (X̄)',
                data: xBarData,
                borderColor: '#00d4ff',
                backgroundColor: 'rgba(0, 212, 255, 0.1)',
                borderWidth: 3,
                pointRadius: 6,
                pointBackgroundColor: '#00d4ff',
                pointBorderColor: '#fff',
                tension: 0.2,
                order: 1
            });
        }

        if (!isThumb) {
            if (typeof DATA.stats.mean === 'number') {
                datasets.push({ label: 'Media Global (X̿)', data: DATA.labels.map(() => DATA.stats.mean), borderColor: '#00ff88', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, order: 2 });
            }
            if (typeof DATA.stats.ucl_x === 'number') {
                datasets.push({ label: 'Control (UCL)', data: DATA.labels.map(() => DATA.stats.ucl_x), borderColor: '#ff4d6a', borderWidth: 2, borderDash: [4, 4], pointRadius: 0, order: 3 });
            }
            if (typeof DATA.stats.lcl_x === 'number') {
                datasets.push({ label: 'Control (LCL)', data: DATA.labels.map(() => DATA.stats.lcl_x), borderColor: '#ff4d6a', borderWidth: 2, borderDash: [4, 4], pointRadius: 0, order: 3 });
            }
            if (typeof DATA.stats.usl === 'number') {
                datasets.push({ label: 'Tol. (LSE)', data: DATA.labels.map(() => DATA.stats.usl), borderColor: '#ffcc00', borderWidth: 2, pointRadius: 0, order: 4 });
            }
            if (typeof DATA.stats.lsl === 'number') {
                datasets.push({ label: 'Tol. (LIE)', data: DATA.labels.map(() => DATA.stats.lsl), borderColor: '#ffcc00', borderWidth: 2, pointRadius: 0, order: 4 });
            }
        }

        return {
            type: 'line',
            data: { labels: DATA.labels, datasets: datasets.filter(Boolean) },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: !isThumb, position: 'top', labels: { usePointStyle: true, boxWidth: 8, color: '#94a3b8', padding: 20 } },
                    tooltip: { enabled: !isThumb }
                },
                scales: {
                    x: { display: !isThumb, grid: { display: false }, ticks: { color: '#94a3b8' } },
                    y: { display: !isThumb, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                }
            }
        };
    }

    function getRangeConfig(isThumb = false) {
        const useSubgroups = DATA.stats.ranges && DATA.stats.ranges.length > 0;
        const subgroupSize = 5;
        const datasets = [];

        if (useSubgroups && !isThumb) {
            const mRData = DATA.points.map((v, i) => i === 0 ? null : Math.abs(v - DATA.points[i-1]));
            datasets.push({ label: 'Variación Individual (mR)', data: mRData, borderColor: 'rgba(148, 163, 184, 0.4)', backgroundColor: 'rgba(148, 163, 184, 0.2)', borderWidth: 1.5, pointRadius: 4, pointBackgroundColor: 'rgba(148, 163, 184, 0.6)', fill: false, tension: 0.1, order: 5, showLine: true });
        }

        let mainData;
        if (useSubgroups && !isThumb) {
            mainData = [];
            for (let i = 0; i < DATA.stats.ranges.length; i++) {
                const pos = ((i + 1) * subgroupSize) - 1;
                mainData.push({ x: DATA.labels[pos], y: DATA.stats.ranges[i] });
            }
        } else {
            mainData = DATA.points.map((v, i) => i === 0 ? null : Math.abs(v - DATA.points[i-1]));
        }

        datasets.push({ label: useSubgroups ? 'Rango Subgrupo (R)' : 'Rango Móvil', data: mainData, borderColor: '#a855f7', backgroundColor: 'rgba(168, 85, 247, 0.15)', borderWidth: isThumb ? 2 : 3, pointRadius: isThumb ? 0 : (useSubgroups ? 6 : 4), pointBackgroundColor: '#a855f7', pointBorderColor: '#fff', tension: 0.1, order: 1 });

        if (!isThumb) {
            if (typeof DATA.stats.avg_range === 'number') datasets.push({ label: 'Rango Medio (R̄)', data: DATA.labels.map(() => DATA.stats.avg_range), borderColor: '#00ff88', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, order: 2 });
            if (typeof DATA.stats.ucl_r === 'number') datasets.push({ label: 'Control (UCL)', data: DATA.labels.map(() => DATA.stats.ucl_r), borderColor: '#ff4d6a', borderWidth: 2, borderDash: [4, 4], pointRadius: 0, order: 3 });
            if (typeof DATA.stats.lcl_r === 'number') datasets.push({ label: 'Control (LCL)', data: DATA.labels.map(() => DATA.stats.lcl_r), borderColor: '#ff4d6a', borderWidth: 2, borderDash: [4, 4], pointRadius: 0, order: 3 });
        }

        return {
            type: 'line',
            data: { labels: DATA.labels, datasets: datasets.filter(Boolean) },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: !isThumb, position: 'top', labels: { usePointStyle: true, boxWidth: 8, color: '#94a3b8', padding: 20 } },
                    tooltip: { enabled: !isThumb }
                },
                scales: {
                    x: { display: !isThumb, grid: { display: false }, ticks: { color: '#94a3b8' } },
                    y: { display: !isThumb, beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                }
            }
        };
    }

    function getFreqConfig(isThumb = false) {
        if (!DATA.points || DATA.points.length === 0) return null;
        const bins = 8;
        const min = Math.min(...DATA.points);
        const max = Math.max(...DATA.points);
        const safeMax = max === min ? max + 1 : max;
        const binWidth = (safeMax - min) / bins;
        const freqData = new Array(bins).fill(0);
        DATA.points.forEach(v => { let b = Math.floor((v - min) / binWidth); if (b >= bins) b = bins - 1; freqData[b]++; });
        const labels = freqData.map((_, i) => (min + i * binWidth + binWidth/2).toFixed(3));
        return {
            type: 'bar',
            data: { labels: labels, datasets: [
                { label: 'Frecuencia', data: freqData, backgroundColor: 'rgba(99, 102, 241, 0.5)', borderColor: '#6366f1', borderWidth: 1, barPercentage: 0.95, categoryPercentage: 0.95, order: 2 },
                { type: 'line', label: 'Polígono', data: freqData, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: isThumb ? 1 : 2, tension: 0.1, pointBackgroundColor: '#fff', pointBorderColor: '#10b981', pointRadius: isThumb ? 0 : 4, order: 1, fill: false }
            ]},
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: !isThumb }, tooltip: { enabled: !isThumb } }, scales: { x: { display: !isThumb, grid: { display: false } }, y: { display: !isThumb, beginAtZero: true } } }
        };
    }

    function getGaussConfig(isThumb = false) {
        const mean = DATA.stats.mean;
        const std = DATA.stats.stdev || 0.0001;
        const nominal = DATA.stats.nominal || mean;
        let specStd = null, target = nominal;
        if (typeof DATA.stats.usl === 'number' && typeof DATA.stats.lsl === 'number') { specStd = (DATA.stats.usl - DATA.stats.lsl) / 6; target = (DATA.stats.usl + DATA.stats.lsl) / 2; }
        else if (typeof DATA.stats.usl === 'number') { specStd = Math.abs(DATA.stats.usl - nominal) / 3; }
        else if (typeof DATA.stats.lsl === 'number') { specStd = Math.abs(nominal - DATA.stats.lsl) / 3; }
        if (!specStd || specStd <= 0) specStd = std;
        const range1 = [mean - 4.5 * std, mean + 4.5 * std];
        const range2 = [target - 4.5 * specStd, target + 4.5 * specStd];
        const start = Math.min(range1[0], range2[0]);
        const end = Math.max(range1[1], range2[1]);
        const step = (end - start) / 80;
        const gaussDataObtenido = [], gaussDataEspecificado = [];
        let maxY = 0;
        for (let x = start; x <= end; x += step) {
            const y1 = (1 / (std * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - mean) / std, 2));
            const y2 = (1 / (specStd * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - target) / specStd, 2));
            gaussDataObtenido.push({x, y: y1}); gaussDataEspecificado.push({x, y: y2});
            if (y1 > maxY) maxY = y1; if (y2 > maxY) maxY = y2;
        }
        const vLine = (val, color, label) => (val != null) ? ({ label, data: [{x: val, y: 0}, {x: val, y: maxY * 1.05}], borderColor: color, borderWidth: 2, borderDash: [5, 5], pointRadius: 0, type: 'line', fill: false, showLine: true, order: 0 }) : null;
        return {
            type: 'line',
            data: { datasets: [
                { label: 'Obtenido', data: gaussDataObtenido, borderColor: '#0284c7', backgroundColor: 'rgba(2, 132, 199, 0.2)', borderWidth: isThumb ? 1 : 3, pointRadius: 0, fill: true, tension: 0.4, order: 2 },
                !isThumb ? { label: 'Curva Ideal (Teórica)', data: gaussDataEspecificado, borderColor: '#ef4444', borderWidth: 2, borderDash: [4, 4], pointRadius: 0, fill: false, tension: 0.4, order: 1 } : null,
                !isThumb ? vLine(DATA.stats.mean, '#0284c7', 'Media (X̄)') : null,
                !isThumb ? vLine(DATA.stats.nominal, '#ef4444', 'Nominal') : null,
                !isThumb ? vLine(DATA.stats.lsl, '#ef4444', 'Tolerancia Mín.') : null,
                !isThumb ? vLine(DATA.stats.usl, '#ef4444', 'Tolerancia Máx.') : null,
                !isThumb ? vLine(DATA.stats.lic, '#f59e0b', 'Cap. Real Mín.') : null,
                !isThumb ? vLine(DATA.stats.lsc, '#f59e0b', 'Cap. Real Máx.') : null
            ].filter(Boolean) },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: !isThumb, position: 'top', labels: { color: '#94a3b8' } }, tooltip: { enabled: !isThumb } }, scales: { x: { type: 'linear', display: !isThumb, min: start, max: end }, y: { display: !isThumb, beginAtZero: true } }, elements: { point: { radius: 0 } } }
        };
    }

    function getPieConfig(isThumb = false) {
        const approved = DATA.stats.n_approved || 0;
        const rejected = DATA.stats.n_rejected || 0;
        const total = DATA.stats.n_total || 0;
        const approvedPct = total ? ((approved / total) * 100).toFixed(1) : 0;
        return {
            type: 'doughnut',
            data: { labels: [`Aceptadas (${approved})`, `Rechazadas (${rejected})`], datasets: [{ data: [approved, rejected], backgroundColor: ['#10b981', '#ef4444'], borderColor: '#ffffff', borderWidth: 2, hoverOffset: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { display: !isThumb, position: 'right', labels: { color: '#94a3b8' } }, tooltip: { enabled: true }, title: { display: !isThumb, text: `Índice de Aprobación: ${approvedPct}% (${approved}/${total} piezas)`, position: 'bottom', font: { size: 14, weight: 'bold' }, color: '#94a3b8' } } }
        };
    }

    function switchChart(type, title, element) {
        try {
            document.getElementById('mainChartTitle').innerText = title;
            if (mainChartInstance) mainChartInstance.destroy();
            const canvas = document.getElementById('mainChartCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let config;
            switch(type) {
                case 'trend': config = getTrendConfig(false); break;
                case 'range': config = getRangeConfig(false); break;
                case 'freq': config = getFreqConfig(false); break;
                case 'gauss': config = getGaussConfig(false); break;
                case 'pie': config = getPieConfig(false); break;
            }
            if (config) { mainChartInstance = new Chart(ctx, config); }
        } catch (err) { console.error("Error switching chart:", err); }
        if (element) {
            document.querySelectorAll('.chart-thumb').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        try {
            const safeInit = (id, config) => {
                const el = document.getElementById(id);
                if (el && config) { if (thumbInstances[id]) thumbInstances[id].destroy(); thumbInstances[id] = new Chart(el, config); }
            };
            safeInit('thumbTrend', getTrendConfig(true));
            safeInit('thumbRange', getRangeConfig(true));
            safeInit('thumbFreq', getFreqConfig(true));
            safeInit('thumbGauss', getGaussConfig(true));
            safeInit('thumbPie', getPieConfig(true));
            switchChart('trend', 'GRÁFICO DE MEDIDAS');
        } catch (err) { console.warn("Init error:", err); }
    });

    async function loadControlData(event, controlId, element) {
        event.preventDefault();
        document.querySelectorAll('.control-list-item').forEach(el => {
            el.style.setProperty('background-color', 'transparent', 'important');
            el.style.setProperty('color', 'var(--text-secondary, #94a3b8)', 'important');
            el.style.fontWeight = 'normal';
            el.style.borderLeftColor = 'transparent';
        });
        element.style.setProperty('background-color', 'rgba(99, 102, 241, 0.1)', 'important');
        element.style.setProperty('color', '#4338ca', 'important');
        element.style.fontWeight = '600';
        element.style.borderLeftColor = '#6366f1';

        try {
            const response = await fetch(`/mediciones/estadisticas/${controlId}/`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            const data = await response.json();
            DATA.stats = data.stats; DATA.points = data.data_points; DATA.labels = data.labels;
            document.getElementById('controlTitleHeader').innerText = `SEGUIMIENTO DE PARÁMETROS: ${data.control_nombre}`;
            document.getElementById('controlSubHeader').innerText = `Proyecto: ${data.proyecto} | OP: ${data.num_op} | Proceso: ${data.proceso_nombre} | Cliente: ${data.cliente}`;
            document.getElementById('btnVolver').href = `/mediciones/${data.planilla_id}/ingresar/`;
            document.getElementById('btnReportePro').href = `/mediciones/${data.planilla_id}/exportar-pdf-pro/`;
            const topAlertBtn = document.getElementById('topAlertBtn');
            if (data.stats.alerts.length > 0) { topAlertBtn.style.setProperty('display', 'flex', 'important'); } else { topAlertBtn.style.setProperty('display', 'none', 'important'); }
            document.getElementById('stat-mean').innerText = parseFloat(data.stats.mean).toFixed(3);
            document.getElementById('stat-lic').innerText = parseFloat(data.stats.lic).toFixed(3);
            document.getElementById('stat-lsc').innerText = parseFloat(data.stats.lsc).toFixed(3);
            document.getElementById('stat-range').innerText = parseFloat(data.stats.range).toFixed(3);
            document.getElementById('stat-n').innerText = data.stats.n;
            document.getElementById('stat-stdev').innerText = parseFloat(data.stats.stdev).toFixed(3);
            document.getElementById('stat-usl').innerText = data.stats.usl ? parseFloat(data.stats.usl).toFixed(3) : "N/A";
            document.getElementById('stat-lsl').innerText = data.stats.lsl ? parseFloat(data.stats.lsl).toFixed(3) : "N/A";
            const cpContainer = document.getElementById('stat-cp-container');
            cpContainer.innerHTML = `<span class="fw-bold">${data.stats.cp || 'N/D'}</span>`;
            if (data.stats.cp && data.stats.cp_info) cpContainer.innerHTML += `<span class="badge ${data.stats.cp_info.class}" style="font-size:0.7rem;">${data.stats.cp_info.text}</span>`;
            const cpkContainer = document.getElementById('stat-cpk-container');
            cpkContainer.innerHTML = `<span class="fw-bold">${data.stats.cpk || 'N/D'}</span>`;
            if (data.stats.cpk && data.stats.cpk_info) cpkContainer.innerHTML += `<span class="badge ${data.stats.cpk_info.class}" style="font-size:0.7rem;">${data.stats.cpk_info.text}</span>`;

            const alertsPanel = document.getElementById('alertsPanel');
            alertsPanel.style.borderTopColor = data.stats.alerts.length > 0 ? '#ef4444' : '#10b981';
            let alertsHtml = `<div class="config-card-header" style="background: #f8fafc; color: #0f172a; border-bottom: 1px solid #e2e8f0; padding: 0.6rem 1rem;"><div class="d-flex align-items-center justify-content-between w-100"><div class="d-flex align-items-center gap-2"><i class="ri-radar-line ${data.stats.alerts.length > 0 ? 'text-danger animate__animated animate__pulse animate__infinite' : 'text-success'}" style="font-size: 1.1rem;"></i><span style="font-weight: 800; font-size: 0.85rem; letter-spacing: 0.05em; color: #0f172a;">ALERTAS INTELIGENTES DEL PROCESO</span></div><div class="d-flex align-items-center gap-2">${data.stats.alerts.length > 0 ? `<button onclick="showDiagnosticReport()" class="btn btn-sm btn-danger d-flex align-items-center gap-1 shadow-danger" style="font-weight: 700; border-radius: 8px; font-size: 0.7rem; padding: 0.4rem 0.8rem;"><i class="ri-article-line"></i> GENERAR INFORME DETALLADO</button><span class="badge" style="font-size: 0.7rem; font-weight: 700; background: rgba(239, 68, 68, 0.2); color: #dc2626; border: 1px solid rgba(239, 68, 68, 0.3);">${data.stats.alerts.length} ANOMALÍAS DETECTADAS</span>` : `<i class="ri-checkbox-circle-fill text-success"></i><span class="badge" style="font-size: 0.7rem; font-weight: 700; background: rgba(16, 185, 129, 0.2); color: #059669; border: 1px solid rgba(16, 185, 129, 0.3);">PROCESO ESTABLE</span>`}</div></div></div><div class="config-card-body p-2" style="background: ${data.stats.alerts.length > 0 ? 'rgba(239, 68, 68, 0.04)' : 'rgba(16, 185, 129, 0.03)'};">`;
            if (data.stats.alerts.length > 0) {
                alertsHtml += '<div class="row g-2">';
                data.stats.alerts.forEach(alert => { alertsHtml += `<div class="col-md-4"><div class="d-flex gap-2 p-2 rounded border-start border-3 border-${alert.type}" style="background: #f8fafc; box-shadow: 0 1px 3px rgba(0,0,0,0.08); height: 100%;"><i class="${alert.icon} text-${alert.type}" style="font-size: 1.2rem; margin-top: 2px;"></i><div><div class="fw-bold" style="font-size: 0.75rem; color: #0f172a;">${alert.title}</div><div style="font-size: 0.7rem; line-height: 1.2; color: #64748b;">${alert.desc}</div></div></div></div>`; });
                alertsHtml += '</div>';
            } else {
                alertsHtml += `<div class="d-flex align-items-center justify-content-center gap-3 py-1"><i class="ri-shield-check-line text-success" style="font-size: 1.5rem;"></i><p class="mb-0" style="font-size: 0.8rem; font-weight: 500; color: #64748b;">El análisis estadístico no detecta tendencias, rachas o puntos fuera de control. <span class="text-success fw-bold">El proceso se mantiene estable.</span></p></div>`;
            }
            alertsHtml += '</div>';
            alertsPanel.innerHTML = alertsHtml;

            setTimeout(() => {
                const activeThumb = document.querySelector('.chart-thumb.active');
                const chartType = activeThumb ? activeThumb.getAttribute('onclick').match(/'([^']+)'/)[1] : 'trend';
                const chartTitle = activeThumb ? activeThumb.querySelector('h6').innerText : 'GRÁFICO DE MEDIDAS';
                switchChart(chartType, chartTitle, activeThumb);
                const safeInit = (id, config) => { const el = document.getElementById(id); if (el && config) { if (thumbInstances[id]) thumbInstances[id].destroy(); thumbInstances[id] = new Chart(el, config); } };
                safeInit('thumbTrend', getTrendConfig(true));
                safeInit('thumbRange', getRangeConfig(true));
                safeInit('thumbFreq', getFreqConfig(true));
                safeInit('thumbGauss', getGaussConfig(true));
                safeInit('thumbPie', getPieConfig(true));
            }, 50);
            window.history.pushState({}, '', `/mediciones/estadisticas/${controlId}/`);
        } catch (err) {
            console.error("Error loading control data:", err);
            window.location.href = `/mediciones/estadisticas/${controlId}/`;
        }
    }

    function toggleFullScreen() {
        const icon = document.getElementById('fsIcon');
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => console.error(err));
            if (icon) { icon.classList.remove('ri-fullscreen-line'); icon.classList.add('ri-fullscreen-exit-line'); }
        } else {
            if (document.exitFullscreen) { document.exitFullscreen(); if (icon) { icon.classList.remove('ri-fullscreen-exit-line'); icon.classList.add('ri-fullscreen-line'); } }
        }
    }
    document.addEventListener('fullscreenchange', () => {
        const icon = document.getElementById('fsIcon');
        if (!document.fullscreenElement && icon) { icon.classList.remove('ri-fullscreen-exit-line'); icon.classList.add('ri-fullscreen-line'); }
    });

    function showDiagnosticReport() {
        if (typeof Swal === 'undefined') return;
        const stats = DATA.stats;
        const alerts = stats.alerts || [];
        if (alerts.length === 0) {
            Swal.fire({ icon: 'success', title: '<span style="color: #111827; font-weight: 900;">Proceso Estable</span>', html: '<p style="color: #334155; font-weight: 600;">No se detectaron anomalías relevantes en el análisis.</p>', confirmButtonText: 'Entendido', customClass: { popup: 'premium-swal-popup', confirmButton: 'premium-confirm-btn' }, buttonsStyling: false });
            return;
        }
        let contentHtml = `<div class="text-center" style="font-family: 'Inter', sans-serif;"><h2 class="fw-black mb-4" style="color: #111827; font-size: 2.2rem; letter-spacing: -0.04em;">Diagnóstico del Proceso</h2><div class="text-start mb-4" style="max-height: 450px; overflow-y: auto; padding-right: 15px;">`;
        alerts.forEach(alert => {
            let causes = "Falta de estandarización o variabilidad del método.", actions = "Auditar el método de trabajo y verificar sujeción.";
            if (alert.title.includes('Fuera de Control')) { causes = "Cambio brusco en el proceso o ajuste incorrecto de la máquina."; actions = "Parar producción de inmediato y recalibrar."; }
            else if (alert.title.includes('Racha')) { causes = "Variación en materia prima o desgaste térmico progresivo."; actions = "Observar próximos 5 puntos e inspeccionar refrigeración."; }
            else if (alert.title.includes('Tendencia')) { causes = "Desgaste progresivo de herramientas o acumulación de viruta."; actions = "Programar cambio de herramienta y revisar compensación."; }
            else if (alert.title.includes('Capacidad')) { causes = "La máquina no es capaz de mantener la precisión requerida."; actions = "Revisar holguras, herramental de alta precisión o reajustar parámetros de corte."; }
            contentHtml += `<div class="mb-4 p-4 rounded-4" style="background: #ffffff; border: 2px solid #f1f5f9; box-shadow: 0 10px 30px rgba(0,0,0,0.05);"><div class="d-flex align-items-center gap-3 mb-4"><div style="padding: 12px; background: ${alert.type === 'danger' ? '#fee2e2' : '#fef3c7'}; border-radius: 12px;"><i class="${alert.icon}" style="font-size: 1.5rem; color: ${alert.type === 'danger' ? '#ef4444' : '#f59e0b'};"></i></div><div style="color: #111827; font-size: 1.4rem; font-weight: 900;">${alert.title}</div></div><div style="color: #334155; font-size: 1.15rem; line-height: 1.6; font-weight: 600;">${alert.desc}</div><div class="mt-4 pt-4 border-top" style="border-color: #f1f5f9 !important;"><div class="mb-4"><span style="font-size:1.1rem;font-weight:900;color:#111827;text-transform:uppercase;display:block;margin-bottom:8px;">Causa Probable</span><div style="color:#475569;font-weight:700;">${causes}</div></div><div><span style="font-size:1.1rem;font-weight:900;color:#059669;text-transform:uppercase;display:block;margin-bottom:8px;">Acción Recomendada</span><div style="color:#059669;font-weight:800;">${actions}</div></div></div></div>`;
        });
        contentHtml += `</div><p style="color: #94a3b8; font-size: 0.85rem; font-style: italic;">Análisis basado en reglas de control estadístico Western Electric.</p></div>`;
        Swal.fire({ html: contentHtml, width: '700px', showCancelButton: false, confirmButtonText: '<i class="ri-check-line" style="font-size: 1.5rem;"></i> Entendido', buttonsStyling: false, customClass: { popup: 'premium-swal-popup', confirmButton: 'premium-confirm-btn', actions: 'justify-content-center mt-4 w-100' } });
    }

    function showHelp(topic) {
        if (typeof Swal === 'undefined') return;
        const concepts = {
            'media': { title: 'Media Aritmética (X̄)', text: 'Es el promedio de todas tus mediciones. Representa el "centro" de tu proceso. Si la media está muy lejos de tu Valor Nominal, el proceso está descentrado.' },
            'lic': { title: 'Límite Control Inferior (L.I.C.)', text: 'Es la frontera estadística inferior de tu máquina. Se calcula como la Media - 3 Desviaciones Estándar. Cualquier punto debajo de esta línea indica una anomalía estadística, incluso si está dentro de tolerancia.' },
            'lsc': { title: 'Límite Control Superior (L.S.C.)', text: 'Es la frontera estadística superior. Si un punto lo supera, algo inusual ocurrió en el proceso (cambio de herramienta, material distinto, etc.).' },
            'rango': { title: 'Rango (R)', text: 'Es la diferencia entre el valor más alto y el más bajo. Un rango muy alto indica que el proceso es inestable.' },
            'n': { title: 'Tamaño de Lote (n)', text: 'Es la cantidad de piezas medidas que se están analizando. A mayor número de piezas, más confiables son los resultados estadísticos.' },
            'sigma': { title: 'Desviación Estándar (σ)', text: 'Indica qué tan "agrupadas" están las piezas respecto al promedio. Una sigma baja significa que la máquina es extremadamente precisa y repetitiva.' },
            'lse': { title: 'Límite Superior Ingeniería (L.S.E.)', text: 'Es la tolerancia máxima permitida por el plano. Cualquier pieza sobre este valor es un RECHAZO.' },
            'lie': { title: 'Límite Inferior Ingeniería (L.I.E.)', text: 'Es la tolerancia mínima permitida por el plano. Cualquier pieza debajo de este valor debe ser rechazada.' },
            'cp': { title: 'Índice de Capacidad (CP)', text: 'Compara el ancho de la tolerancia con la variabilidad real de tu máquina. <br><br><b>¿Por qué dice N/D?</b><br>Si tus tolerancias LSE y LIE son iguales, el ancho es cero y no se puede calcular.' },
            'cpk': { title: 'Índice de Capacidad Real (CPK)', text: 'Evalúa la capacidad considerando el centrado de la producción. El objetivo es que sea mayor a 1.33. Si es menor a 1.0, el proceso va a generar piezas malas tarde o temprano.' }
        };
        const concept = concepts[topic];
        if (!concept) return;
        Swal.fire({ title: `<span style="color: #1e293b; font-weight: 800;">${concept.title}</span>`, html: `<p style="color: #475569; font-size: 1.05rem; line-height: 1.6; text-align: left;">${concept.text}</p>`, confirmButtonText: 'Entendido', buttonsStyling: false, customClass: { popup: 'premium-swal-popup', confirmButton: 'premium-confirm-btn' } });
    }
</script>
{% endblock %}
