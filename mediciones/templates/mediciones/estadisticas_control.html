{% extends 'mediciones/index.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="premium-page-container" style="padding: 1rem 2rem; background: #f8fafc; height: 100vh; overflow: hidden; display: flex; flex-direction: column;">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-3">
            <div>
                <h1 style="font-size: 1.5rem; font-weight: 800; color: #1e293b; margin: 0; letter-spacing: -0.025em;">
                    SEGUIMIENTO DE PARÁMETROS: {{ tolerancia.control.nombre }}
                </h1>
                <p style="color: #64748b; font-size: 0.9rem; margin: 0;">
                    Proyecto: {{ tolerancia.planilla.proyecto }} | OP: {{ tolerancia.planilla.num_op }} | Cliente: {{ tolerancia.planilla.cliente.nombre }}
                </p>
            </div>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'nueva_medicion_op' %}?proy={{ tolerancia.planilla.proyecto }}&op={{ tolerancia.planilla.num_op }}&proc={{ tolerancia.planilla.proceso.id }}" class="btn" style="background-color: #ef4444; color: white; padding: 0.6rem 1.5rem; border-radius: 12px; font-size: 0.9rem; font-weight: 700; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);">
                <i class="ri-arrow-left-line"></i> Volver
            </a>
        </div>
    </div>

    <!-- Stats & Charts Flex Container -->
    <div class="d-flex gap-4 mb-4 flex-column flex-md-row" style="flex: 1; min-height: 0;">
        
        <!-- Left Column: Stats & Controls -->
        <div style="flex: 0 0 320px; min-width: 320px; display: flex; flex-direction: column; gap: 1rem; height: 100%;">
            
            <!-- Stats Table (Top) -->
            <div class="config-card" style="flex-shrink: 0;">
                <div class="config-card-header" style="background: #e0f2fe; color: #0369a1; padding: 0.85rem 1rem; border-bottom: 1px solid #bae6fd;">
                    <i class="ri-settings-5-line" style="font-size: 1.1rem;"></i>
                    <span style="font-weight: 800; letter-spacing: 0.05em;">ESTADÍSTICOS X-R</span>
                </div>
                <div class="config-card-body p-0">
                    <table class="table table-sm mb-0 stats-table-compact">
                        <tr><td>Media (X̄)</td><td class="text-end fw-bold">{{ stats.mean|floatformat:2 }}</td></tr>
                        <tr><td>L.I.C.</td><td class="text-end fw-bold">{{ stats.lic|floatformat:2 }}</td></tr>
                        <tr><td>L.S.C.</td><td class="text-end fw-bold">{{ stats.lsc|floatformat:2 }}</td></tr>
                        <tr><td>Rango (R)</td><td class="text-end fw-bold">{{ stats.range|floatformat:2 }}</td></tr>
                        <tr><td>Lote (n)</td><td class="text-end fw-bold">{{ stats.n }}</td></tr>
                        <tr><td>Desv. Est. (σ)</td><td class="text-end fw-bold">{{ stats.stdev|floatformat:2 }}</td></tr>
                        <tr class="table-info"><td>L.S.E. (TOL+)</td><td class="text-end fw-bold text-danger">{{ stats.usl|floatformat:2|default:"N/A" }}</td></tr>
                        <tr class="table-info"><td>L.I.E. (TOL-)</td><td class="text-end fw-bold text-danger">{{ stats.lsl|floatformat:2|default:"N/A" }}</td></tr>
                        <tr>
                            <td>Indice CP</td>
                            <td class="text-end">
                                <div class="d-flex justify-content-end align-items-center gap-2">
                                    <span class="fw-bold">{{ stats.cp|default:"N/D" }}</span>
                                    {% if stats.cp_info and stats.cp %}
                                    <span class="badge {{ stats.cp_info.class }}" style="font-size: 0.7rem;">{{ stats.cp_info.text }}</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Indice CPK</td>
                            <td class="text-end">
                                <div class="d-flex justify-content-end align-items-center gap-2">
                                    <span class="fw-bold">{{ stats.cpk|default:"N/D" }}</span>
                                    {% if stats.cpk_info and stats.cpk %}
                                    <span class="badge {{ stats.cpk_info.class }}" style="font-size: 0.7rem;">{{ stats.cpk_info.text }}</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Controls List (Bottom - Scrollable) -->
            <div class="config-card" style="flex: 1; min-height: 0; display: flex; flex-direction: column; overflow: hidden; border-top: 3px solid #6366f1;">
                 <div class="config-card-header text-primary" style="background: white; color: #1e293b; border-bottom: 1px solid #f1f5f9; padding: 0.75rem 1rem;">
                     <div class="d-flex align-items-center gap-2">
                        <i class="ri-list-check"></i>
                        <span style="font-weight: 800; font-size: 0.8rem; letter-spacing: 0.05em;">CONTROLES</span>
                     </div>
                </div>
                <div class="config-card-body p-0" style="flex: 1; overflow-y: auto;">
                    <div class="list-group list-group-flush">
                        {% regroup controles_hermanos by planilla.elemento.nombre as element_list %}
                        {% for element in element_list %}
                            {% if element.grouper %}
                            <div class="bg-light border-bottom px-3 py-1 text-muted fw-bold" style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; position: sticky; top: 0; z-index: 10;">
                                {{ element.grouper }}
                            </div>
                            {% endif %}
                            
                            {% for sibling in element.list %}
                            <a href="{% url 'estadisticas_control' sibling.id %}" 
                               class="list-group-item list-group-item-action d-flex align-items-center justify-content-between px-3 py-2 border-bottom-0"
                               style="font-size: 0.85rem; transition: all 0.2s; border-left: 3px solid transparent; {% if sibling.id == tolerancia.id %}background-color: #eff6ff; color: #2563eb; font-weight: 600; border-left-color: #2563eb !important;{% elif sibling.control.pnp %}color: #94a3b8; background-color: #fcfcfd;{% else %}color: #475569;{% endif %}">
                                <span class="text-truncate d-flex align-items-center gap-2" style="flex: 1;">
                                    {{ sibling.control.nombre }}
                                    {% if sibling.control.pnp %}
                                    <span class="badge rounded-pill bg-light text-muted border" style="font-size: 0.6rem; font-weight: 500;">PnP</span>
                                    {% endif %}
                                </span>
                                {% if sibling.id == tolerancia.id %}
                                <i class="ri-arrow-right-s-line"></i>
                                {% endif %}
                            </a>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Charts Gallery (Fills Remaining Space) -->
        <div style="flex: 1; min-width: 0;">
            <!-- Main Large Viewer -->
            <div class="card border-0 shadow-sm mb-4 animate__animated animate__fadeIn" style="border-radius: 16px;">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0" id="mainChartTitle" style="font-size: 1.1rem; color: #1e293b; text-transform: uppercase; letter-spacing: 0.05em;">
                            Gráfico de Medidas
                        </h5>
                        <div class="badge bg-light text-dark border">Vista Detallada</div>
                    </div>
                    
                    <div style="position: relative; height: 42vh; width: 100%;" id="chartContainer">
                        {% if tolerancia.control.pnp %}
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-center p-4" style="background: #f8fafc; border-radius: 12px; border: 2px dashed #e2e8f0;">
                            <i class="ri-information-line" style="font-size: 3rem; color: #94a3b8; margin-bottom: 1rem;"></i>
                            <h6 class="fw-bold text-dark mb-1">CONTROL PASA / NO PASA</h6>
                            <p class="text-muted small mb-0">Este control es dicotómico y no genera gráficos de tendencia o histogramas numéricos. Consulte el gráfico de <b>Estatus</b> para ver el resumen del lote.</p>
                        </div>
                        <canvas id="mainChartCanvas" style="display: none;"></canvas>
                        {% else %}
                        <canvas id="mainChartCanvas"></canvas>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Thumbnails Selector -->
            <!-- Thumbnails Selector (Flex Fit) -->
            <div class="d-flex gap-2 w-100">
                <div style="flex: 1; min-width: 0;">
                    <div class="card border-0 shadow-sm h-100 chart-thumb active" onclick="switchChart('trend', 'Gráfico de Medidas', this)" style="cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                        <div class="card-body p-2 text-center">
                            <h6 class="text-xxs fw-bold mb-2 text-truncate">MEDIDAS</h6>
                            <div style="height: 60px; width: 100%;"><canvas id="thumbTrend"></canvas></div>
                        </div>
                    </div>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div class="card border-0 shadow-sm h-100 chart-thumb" onclick="switchChart('range', 'Gráfico de Amplitud (R)', this)" style="cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                        <div class="card-body p-2 text-center">
                            <h6 class="text-xxs fw-bold mb-2 text-truncate">RANGOS</h6>
                            <div style="height: 60px; width: 100%;"><canvas id="thumbRange"></canvas></div>
                        </div>
                    </div>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div class="card border-0 shadow-sm h-100 chart-thumb" onclick="switchChart('freq', 'Distribución de Frecuencias', this)" style="cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                        <div class="card-body p-2 text-center">
                            <h6 class="text-xxs fw-bold mb-2 text-truncate">HISTOGRAMA</h6>
                            <div style="height: 60px; width: 100%;"><canvas id="thumbFreq"></canvas></div>
                        </div>
                    </div>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div class="card border-0 shadow-sm h-100 chart-thumb" onclick="switchChart('gauss', 'Campana de Gauss (Capabilidad)', this)" style="cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                        <div class="card-body p-2 text-center">
                            <h6 class="text-xxs fw-bold mb-2 text-truncate">CAPABILIDAD</h6>
                            <div style="height: 60px; width: 100%;"><canvas id="thumbGauss"></canvas></div>
                        </div>
                    </div>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div class="card border-0 shadow-sm h-100 chart-thumb" onclick="switchChart('pie', 'Estatus de Lote', this)" style="cursor: pointer; border-radius: 12px; transition: all 0.2s;">
                        <div class="card-body p-2 text-center">
                            <h6 class="text-xxs fw-bold mb-2 text-truncate">ESTATUS</h6>
                            <div style="height: 60px; width: 100%;"><canvas id="thumbPie"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



<style>
    /* Hide Vertical Scroll globally for this view */
    body { overflow: hidden !important; }

    .stats-table-compact td { 
        padding: 0.6rem 0.5rem; 
        font-size: 0.8rem; 
        border-bottom: 1px solid #f1f5f9;
        color: #475569;
    }
    .stats-table-compact tr:last-child td { border: none; }
    
    .btn-back-simple {
        color: #64748b;
        font-size: 0.85rem;
        font-weight: 600;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.8rem;
        background: white;
        border-radius: 8px;
        transition: 0.2s;
        border: 1px solid #e2e8f0;
    }
    .btn-back-simple:hover { background: #f8fafc; color: #1e293b; }

    .chart-thumb:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
        border: 1px solid #3b82f6 !important;
    }
    .chart-thumb.active {
        border: 2px solid #3b82f6 !important;
        background: #eff6ff;
    }

    /* Soft Badges for CP/CPK */
    .badge-soft-danger {
        background-color: #fee2e2 !important; /* Soft Red */
        color: #991b1b !important;
        border: 1px solid #fecaca;
    }
    .badge-soft-warning {
        background-color: #fef3c7 !important; /* Soft Amber */
        color: #92400e !important;
        border: 1px solid #fde68a;
    }
    .badge-soft-success {
        background-color: #dcfce7 !important; /* Soft Green */
        color: #166534 !important;
        border: 1px solid #bbf7d0;
    }
    .badge-soft-excellent {
        background-color: #ccfbf1 !important; /* Soft Teal/Emerald (distinctive green) */
        color: #115e59 !important;
        border: 1px solid #99f6e4;
    }
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const DATA = {
        points: {{ data_points_json|safe }},
        labels: {{ labels_json|safe }},
        stats: {{ stats_json|safe }}
    };

    // Global Instances
    let mainChartInstance = null;
    const thumbInstances = {};

    // --- Data Preparation Helpers ---
    function getTrendConfig(isThumb = false) {
        return {
            type: 'line',
            data: {
                labels: DATA.labels,
                datasets: [
                    {
                        label: 'Mediciones',
                        data: DATA.points,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: isThumb ? 1 : 2,
                        pointRadius: isThumb ? 0 : 4,
                        tension: 0,
                        order: 1
                    },
                    // --- Reference Lines (Only for Main Chart) ---
                    (!isThumb && typeof DATA.stats.mean === 'number') ? {
                        label: 'Media (X̄)',
                        data: DATA.labels.map(() => DATA.stats.mean),
                        borderColor: '#10b981', // Emerald 500
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        order: 2
                    } : null,
                    (!isThumb && typeof DATA.stats.lsc === 'number') ? {
                        label: 'Límites Control (LSC)',
                        data: DATA.labels.map(() => DATA.stats.lsc),
                        borderColor: '#ef4444', // Red 500
                        borderWidth: 1,
                        borderDash: [2, 2],
                        pointRadius: 0,
                        order: 3
                    } : null,
                    (!isThumb && typeof DATA.stats.lic === 'number') ? {
                        label: 'Límites Control (LIC)',
                        data: DATA.labels.map(() => DATA.stats.lic),
                        borderColor: '#ef4444',
                        borderWidth: 1,
                        borderDash: [2, 2],
                        pointRadius: 0,
                        order: 3
                    } : null,
                    (!isThumb && typeof DATA.stats.usl === 'number') ? {
                        label: 'Límites Tol. (LSE)',
                        data: DATA.labels.map(() => DATA.stats.usl),
                        borderColor: '#0f172a', // Slate 900
                        borderWidth: 1.5,
                        pointRadius: 0,
                        order: 4
                    } : null,
                    (!isThumb && typeof DATA.stats.lsl === 'number') ? {
                        label: 'Límites Tol. (LIE)',
                        data: DATA.labels.map(() => DATA.stats.lsl),
                        borderColor: '#0f172a',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        order: 4
                    } : null
                ].filter(Boolean)
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: { 
                    legend: { 
                        display: !isThumb,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            boxWidth: 8
                        }
                    }, 
                    tooltip: { enabled: !isThumb } 
                },
                scales: {
                    x: { display: !isThumb, grid: { display: false } },
                    y: { display: !isThumb }
                }
            }
        };
    }

    function getRangeConfig(isThumb = false) {
        const ranges = DATA.points.map((v, i) => i === 0 ? null : Math.abs(v - DATA.points[i-1]));
        return {
            type: 'line',
            data: {
                labels: DATA.labels,
                datasets: [
                    {
                        label: 'Rango Móvil',
                        data: ranges,
                        borderColor: '#6366f1',
                        borderWidth: isThumb ? 1 : 2,
                        pointRadius: isThumb ? 0 : 3,
                        tension: 0,
                        order: 1
                    },
                    // --- Reference Lines (Only for Main Chart) ---
                    (!isThumb && typeof DATA.stats.r_mean === 'number') ? {
                        label: 'Rango Medio (R̄)',
                        data: DATA.labels.map(() => DATA.stats.r_mean),
                        borderColor: '#10b981', // Emerald 500
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        order: 2
                    } : null,
                    (!isThumb && typeof DATA.stats.r_lsc === 'number') ? {
                        label: 'Límites Control (LSC)',
                        data: DATA.labels.map(() => DATA.stats.r_lsc),
                        borderColor: '#ef4444', // Red 500
                        borderWidth: 1,
                        borderDash: [2, 2],
                        pointRadius: 0,
                        order: 3
                    } : null,
                    (!isThumb && typeof DATA.stats.r_lic === 'number') ? { // Check undefined/null specifically as it might be 0
                        label: 'Límites Control (LIC)',
                        data: DATA.labels.map(() => DATA.stats.r_lic),
                        borderColor: '#ef4444',
                        borderWidth: 1,
                        borderDash: [2, 2],
                        pointRadius: 0,
                        order: 3
                    } : null
                ].filter(Boolean)
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: { 
                    legend: { 
                        display: !isThumb,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            boxWidth: 8
                        }
                    },
                    tooltip: { enabled: !isThumb } 
                },
                scales: {
                    x: { display: !isThumb, grid: { display: false } },
                    y: { display: !isThumb, beginAtZero: true }
                }
            }
        };
    }

    function getFreqConfig(isThumb = false) {
        if (!DATA.points || DATA.points.length === 0) return null;
        
        const bins = 8;
        const min = Math.min(...DATA.points);
        const max = Math.max(...DATA.points);
        // Ensure non-zero range
        const safeMax = max === min ? max + 1 : max;
        const binWidth = (safeMax - min) / bins;
        
        const freqData = new Array(bins).fill(0);
        DATA.points.forEach(v => {
            let b = Math.floor((v - min) / binWidth);
            if (b >= bins) b = bins - 1;
            freqData[b]++;
        });
        
        const labels = freqData.map((_, i) => (min + i * binWidth + binWidth/2).toFixed(2)); // Midpoint labels
        
        return {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Frecuencia',
                        data: freqData,
                        backgroundColor: 'rgba(99, 102, 241, 0.5)', // Indigo
                        borderColor: '#6366f1',
                        borderWidth: 1,
                        barPercentage: 0.95,
                        categoryPercentage: 0.95,
                        order: 2
                    },
                    {
                        type: 'line',
                        label: 'Polígono',
                        data: freqData,
                        borderColor: '#10b981', // Emerald
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: isThumb ? 1 : 2,
                        tension: 0.1,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#10b981',
                        pointRadius: isThumb ? 0 : 4,
                        order: 1,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { 
                    legend: { display: !isThumb, position: 'top' }, 
                    tooltip: { enabled: !isThumb } 
                },
                scales: {
                    x: { display: !isThumb, grid: { display: false } },
                    y: { display: !isThumb, beginAtZero: true }
                }
            }
        };
    }

    function getGaussConfig(isThumb = false) {
        const mean = DATA.stats.mean;
        const std = DATA.stats.stdev || 0.0001; 
        const nominal = DATA.stats.nominal || mean;
        
        // Calculate Specified Sigma based on Tolerance / 6 (Cp=1 basis)
        let specStd = null;
        let target = nominal;

        if (typeof DATA.stats.usl === 'number' && typeof DATA.stats.lsl === 'number') {
             specStd = (DATA.stats.usl - DATA.stats.lsl) / 6;
             target = (DATA.stats.usl + DATA.stats.lsl) / 2;
        } else if (typeof DATA.stats.usl === 'number') {
            // One sided Upper: treat distance from nominal to USL as 3 sigma
            specStd = Math.abs(DATA.stats.usl - nominal) / 3;
        } else if (typeof DATA.stats.lsl === 'number') {
            // One sided Lower
            specStd = Math.abs(nominal - DATA.stats.lsl) / 3;
        }
        
        if (specStd <= 0 || specStd === null) specStd = std;

        // --- Determine X-Axis Range to fit BOTH curves ---
        const range1 = [mean - 4.5 * std, mean + 4.5 * std];
        const range2 = [target - 4.5 * specStd, target + 4.5 * specStd];
        
        const start = Math.min(range1[0], range2[0]);
        const end = Math.max(range1[1], range2[1]);
        const step = (end - start) / 80;

        // --- Generate Data ---
        const gaussDataObtenido = [];
        const gaussDataEspecificado = [];
        
        let maxY = 0;
        
        for (let x = start; x <= end; x += step) {
            // Actual Process Curve (Blue)
            const y1 = (1 / (std * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - mean) / std, 2));
            gaussDataObtenido.push({x: x, y: y1});
            
            // Specified Curve (Red)
            const y2 = (1 / (specStd * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - target) / specStd, 2));
            gaussDataEspecificado.push({x: x, y: y2});

            if(y1 > maxY) maxY = y1;
            if(y2 > maxY) maxY = y2;
        }

        // Helper for vertical lines
        const createVerticalLine = (val, color, label) => (val !== null && val !== undefined) ? ({
            label: label,
            data: [{x: val, y: 0}, {x: val, y: maxY * 1.05}],
            borderColor: color,
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            type: 'line',
            fill: false,
            showLine: true,
            order: 0
        }) : null;

        return {
            type: 'line',
            data: {
                datasets: [
                    // Actual Process
                    {
                        label: 'Obtenido',
                        data: gaussDataObtenido,
                        borderColor: '#0284c7', // Sky 600
                        backgroundColor: 'rgba(2, 132, 199, 0.2)',
                        borderWidth: isThumb ? 1 : 3,
                        pointRadius: 0,
                        fill: true,
                        tension: 0.4,
                        order: 2
                    },
                    // Specified Target
                    (!isThumb) ? {
                        label: 'Especificado',
                        data: gaussDataEspecificado,
                        borderColor: '#ef4444', // Red 500
                        borderWidth: 2,
                        borderDash: [4, 4],
                        pointRadius: 0,
                        fill: false, // Usually specification is just outline
                        tension: 0.4,
                        order: 1
                    } : null,
                    
                    !isThumb ? createVerticalLine(DATA.stats.mean, '#0284c7', 'Media (X̄)') : null,
                    !isThumb ? createVerticalLine(DATA.stats.lsl, '#ef4444', 'Límite Inf. (LIE)') : null,
                    !isThumb ? createVerticalLine(DATA.stats.usl, '#ef4444', 'Límite Sup. (LSE)') : null
                ].filter(Boolean)
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'nearest', axis: 'x', intersect: false },
                plugins: { 
                    legend: { display: !isThumb, position: 'top' }, 
                    tooltip: { enabled: !isThumb, callbacks: { title: (ctx) => 'Valor: ' + ctx[0].parsed.x.toFixed(4) } } 
                },
                scales: { 
                    x: { 
                        type: 'linear', 
                        display: !isThumb,
                        min: start,
                        max: end,
                        grid: { display: true, color: '#f1f5f9' }
                    }, 
                    y: { display: !isThumb, beginAtZero: true, grid: { display: false } } 
                },
                elements: { point: { radius: 0 } }
            }
        };
    }

    function getPieConfig(isThumb = false) {
        // Use pre-calculated values from backend
        const approved = DATA.stats.n_approved || 0;
        const rejected = DATA.stats.n_rejected || 0;
        const total = DATA.stats.n_total || 0;
        
        const approvedPct = total ? ((approved / total) * 100).toFixed(1) : 0;

        return {
            type: 'doughnut',
            data: {
                labels: [`Aceptadas (${approved})`, `Rechazadas (${rejected})`],
                datasets: [{
                    data: [approved, rejected],
                    backgroundColor: ['#10b981', '#ef4444'], // Emerald, Red
                    borderColor: '#ffffff',
                    borderWidth: 2,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: { display: !isThumb, position: 'right' },
                    tooltip: { 
                        enabled: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                let value = context.parsed;
                                let pct = total ? ((value / total) * 100).toFixed(1) + '%' : '';
                                return label + value + ' (' + pct + ')';
                            }
                        }
                    },
                    title: {
                        display: !isThumb,
                        text: `Índice de Aprobación: ${approvedPct}% (${approved}/${total} piezas)`,
                        position: 'bottom',
                        font: { size: 16 }
                    }
                }
            }
        };
    }

    // --- Switcher Logic ---
    function switchChart(type, title, element) {
        try {
            document.getElementById('mainChartTitle').innerText = title;
            
            if (mainChartInstance) mainChartInstance.destroy();
            
            const canvas = document.getElementById('mainChartCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let config;
            
            switch(type) {
                case 'trend': config = getTrendConfig(false); break;
                case 'range': config = getRangeConfig(false); break;
                case 'freq': config = getFreqConfig(false); break;
                case 'gauss': config = getGaussConfig(false); break;
                case 'pie': config = getPieConfig(false); break;
            }
            
            if (config) {
                mainChartInstance = new Chart(ctx, config);
            } else {
                // If config is null (e.g. no data for freq), show a message or clear
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = "16px sans-serif";
                ctx.textAlign = "center";
                ctx.fillText("Sin datos suficientes para este gráfico", canvas.width/2, canvas.height/2);
            }
        } catch (err) {
            console.error("Error switching chart:", err);
        }

        // Update active class on thumbnails
        if (element) {
            document.querySelectorAll('.chart-thumb').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }
    }

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
        try {
            const safeInit = (id, config) => {
                const el = document.getElementById(id);
                if (el && config) new Chart(el, config);
            };
            // Init Thumbnails
            safeInit('thumbTrend', getTrendConfig(true));
            safeInit('thumbRange', getRangeConfig(true));
            safeInit('thumbFreq', getFreqConfig(true));
            safeInit('thumbGauss', getGaussConfig(true));
            safeInit('thumbPie', getPieConfig(true));
    
            switchChart('trend', 'Gráfico de Medidas');
        } catch (err) {
            console.warn("Init error:", err);
        }
    });

</script>
{% endblock %}
