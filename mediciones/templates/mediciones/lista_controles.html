{% extends 'mediciones/index.html' %}

{% block title %}Maestro de Controles{% endblock %}

{% block content %}
<div class="card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="card-title" style="font-size: 1.25rem;">Controles y Magnitudes</h2>
            <div class="text-muted" style="font-size: 0.95rem;">
                Administra los controles de calidad y tipos de datos a recolectar.
            </div>
        </div>
        <a href="{% url 'crear_control' %}" class="btn btn-primary">
            <i class="ri-add-line"></i> Nuevo Control
        </a>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th style="text-align: center;">Tipo</th>
                <th style="text-align: right;">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for control in controles %}
            <tr>
                <td style="width: 80px; font-family: monospace; color: var(--text-secondary);">#{{ control.id }}</td>
                <td class="fw-bold">{{ control.nombre }}</td>
                <td style="text-align: center;">
                    {% if control.pnp %}
                        <span class="badge" style="background-color: #e0f2fe; color: #0284c7;">Pasa / No Pasa</span>
                    {% else %}
                        <span class="badge" style="background-color: #f1f5f9; color: #475569;">Dimensional</span>
                    {% endif %}
                </td>
                <td style="text-align: right; display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <a href="{% url 'editar_control' control.pk %}" class="btn-soft-primary">
                        <i class="ri-edit-line"></i> Editar
                    </a>
                    <form action="{% url 'eliminar_control' control.pk %}" method="post" style="display: inline;" id="delete-form-control-{{ control.pk }}">
                        {% csrf_token %}
                        <button type="button" class="btn-soft-danger" onclick="confirmDelete('{{ control.nombre }}', 'delete-form-control-{{ control.pk }}')">
                            <i class="ri-delete-bin-line"></i> Borrar
                        </button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" class="empty-state">
                    <div class="empty-state-icon">
                        <i class="ri-ruler-2-line"></i>
                    </div>
                    <div class="empty-state-title">No hay controles definidos</div>
                    <div>Define las características que se medirán en las piezas.</div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination and Per Page Selector -->
    <div class="pagination-container">
        <div class="per-page-selector">
            <span>Registros por página:</span>
            <input type="number" class="per-page-input" value="{{ per_page }}" min="1" max="100" 
                   onchange="changePerPage(this.value)"
                   onkeydown="if(event.key==='Enter') changePerPage(this.value)">
        </div>

        <div class="pagination-controls">
            {% if controles.has_previous %}
                <a href="?page=1&per_page={{ per_page }}" class="page-link-premium">
                    <i class="ri-double-left-line"></i>
                </a>
                <a href="?page={{ controles.previous_page_number }}&per_page={{ per_page }}" class="page-link-premium">
                    <i class="ri-arrow-left-s-line"></i>
                </a>
            {% else %}
                <div class="page-link-premium disabled"><i class="ri-double-left-line"></i></div>
                <div class="page-link-premium disabled"><i class="ri-arrow-left-s-line"></i></div>
            {% endif %}

            <div class="page-link-premium active">
                {{ controles.number }} de {{ controles.paginator.num_pages }}
            </div>

            {% if controles.has_next %}
                <a href="?page={{ controles.next_page_number }}&per_page={{ per_page }}" class="page-link-premium">
                    <i class="ri-arrow-right-s-line"></i>
                </a>
                <a href="?page={{ controles.paginator.num_pages }}&per_page={{ per_page }}" class="page-link-premium">
                    <i class="ri-double-right-line"></i>
                </a>
            {% else %}
                <div class="page-link-premium disabled"><i class="ri-arrow-right-s-line"></i></div>
                <div class="page-link-premium disabled"><i class="ri-double-right-line"></i></div>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function changePerPage(value) {
    if (value < 1) value = 1;
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('per_page', value);
    urlParams.set('page', 1);
    window.location.search = urlParams.toString();
}
function confirmDelete(name, formId) {
    Swal.fire({
        title: '¿Estás seguro?',
        text: `Vas a eliminar: "${name}". Esta acción no se puede deshacer.`,
        iconHtml: '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
        showCancelButton: true,
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        buttonsStyling: false,
        customClass: {
            popup: 'premium-swal',
            title: 'premium-title',
            htmlContainer: 'premium-text',
            actions: 'premium-actions',
            confirmButton: 'swal2-confirm premium-confirm-btn premium-confirm-btn-danger',
            cancelButton: 'swal2-cancel premium-cancel-btn',
            icon: 'premium-icon-warning-box'
        },
        reverseButtons: false
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById(formId).submit();
        }
    });
}
</script>
{% endblock %}
