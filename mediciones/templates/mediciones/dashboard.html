{% extends 'mediciones/base.html' %}

{% block title %}Dashboard Ejecutivo{% endblock %}
{% block header_title %}Dashboard Operativo{% endblock %}

{% block content %}
<!-- EXECUTIVE DASHBOARD HEADER -->
<div class="dashboard-header mb-4 animate__animated animate__fadeIn">
    <div class="d-flex align-items-center justify-content-between">
        <div>
            <h1 style="font-size: 1.8rem; font-weight: 800; color: var(--text-primary); margin: 0; letter-spacing: -0.04em;">Dashboard Operativo</h1>
            <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">Resumen de calidad y producción en tiempo real</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'asignar_op' %}" class="btn btn-primary" style="padding: 0.75rem 1.5rem; border-radius: 14px; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);">
                <i class="ri-add-line" style="font-size: 1.2rem;"></i> Nueva OP
            </a>
        </div>
    </div>
</div>

<!-- KPI CARDS GRID -->
<div class="row g-4 mb-4">
    <!-- Total OPs -->
    <div class="col-md-3">
        <div class="kpi-card animate__animated animate__fadeInUp" style="--delay: 0.1s;">
            <div class="kpi-icon" style="background: rgba(99, 102, 241, 0.1); color: #6366f1;">
                <i class="ri-rocket-2-line"></i>
            </div>
            <div class="kpi-data">
                <span class="kpi-label">Total OPs</span>
                <h3 class="kpi-value">{{ total_ops }}</h3>
                <div class="kpi-subtext">Operaciones registradas</div>
            </div>
        </div>
    </div>
    <!-- Mediciones 30d -->
    <div class="col-md-3">
        <div class="kpi-card animate__animated animate__fadeInUp" style="--delay: 0.2s;">
            <div class="kpi-icon" style="background: rgba(6, 182, 212, 0.1); color: #06b6d4;">
                <i class="ri-focus-3-line"></i>
            </div>
            <div class="kpi-data">
                <span class="kpi-label">Mediciones (30d)</span>
                <h3 class="kpi-value">{{ mediciones_recientes }}</h3>
                <div class="kpi-subtext">Puntos controlados</div>
            </div>
        </div>
    </div>
    <!-- Tasa de Calidad -->
    <div class="col-md-3">
        <div class="kpi-card animate__animated animate__fadeInUp" style="--delay: 0.3s;">
            <div class="kpi-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                <i class="ri-checkbox-circle-line"></i>
            </div>
            <div class="kpi-data">
                <span class="kpi-label">Tasa de Aprobación</span>
                <h3 class="kpi-value">
                    {% if mediciones_recientes > 0 %}
                        {% widthratio ok_count mediciones_recientes 100 %}%
                    {% else %}
                        100%
                    {% endif %}
                </h3>
                <div class="kpi-subtext">Cumplimiento global</div>
            </div>
        </div>
    </div>
    <!-- Alertas -->
    <div class="col-md-3">
        <div onclick="window.location='{% url 'lista_instrumentos' %}?filter=alertas';" class="kpi-card animate__animated animate__fadeInUp clickable-kpi" style="{% if total_vencidos_alerta > 0 %}border: 1px solid rgba(239, 68, 68, 0.3);{% endif %} --delay: 0.4s; cursor: pointer;">
            <div class="kpi-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                <i class="ri-alarm-warning-line"></i>
            </div>
            <div class="kpi-data">
                <span class="kpi-label">Alertas Instrumentos</span>
                <h3 class="kpi-value {% if total_vencidos_alerta > 0 %}text-danger{% endif %}">{{ total_vencidos_alerta }}</h3>
                <div class="kpi-subtext">Vencimientos próximos</div>
            </div>
        </div>
    </div>
</div>

<!-- CHARTS ROW -->
<div class="row g-4 mb-4">
    <div class="col-md-8">
        <div class="card h-100 chart-card animate__animated animate__fadeInLeft" style="--delay: 0.5s;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary); margin: 0;">Tendencia de Actividad</h3>
                <span class="badge" style="background: rgba(99, 102, 241, 0.1); color: #6366f1;">Últimos 7 días</span>
            </div>
            <div id="trendChart" style="min-height: 300px;"></div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100 chart-card animate__animated animate__fadeInRight" style="--delay: 0.6s;">
            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary); margin: 0; margin-bottom: 2rem;">Estado de Calidad</h3>
            <div id="statusChart" style="min-height: 300px; display: flex; align-items: center; justify-content: center;"></div>
        </div>
    </div>
</div>

<!-- TABLE SECTION -->
<div class="card animate__animated animate__fadeInUp" style="--delay: 0.7s;" id="dashboard-table-container">
    {% include 'mediciones/partials/dashboard_table.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // TREND CHART
        const trendOptions = {
            series: [{
                name: 'Mediciones Totales',
                data: {{ stats_mediciones|safe }}
            }, {
                name: 'Piezas OK',
                data: {{ stats_oks|safe }}
            }],
            chart: {
                height: 320,
                type: 'area',
                toolbar: { show: false },
                zoom: { enabled: false },
                background: 'transparent'
            },
            colors: ['#6366f1', '#10b981'],
            dataLabels: { enabled: false },
            stroke: { curve: 'smooth', width: 3 },
            fill: {
                type: 'gradient',
                gradient: {
                    shadeIntensity: 1,
                    opacityFrom: 0.4,
                    opacityTo: 0.1,
                    stops: [0, 90, 100]
                }
            },
            xaxis: {
                categories: {{ stats_dias|safe }},
                axisBorder: { show: false },
                axisTicks: { show: false },
                labels: { style: { colors: '#94a3b8' } }
            },
            yaxis: {
                labels: { style: { colors: '#94a3b8' } }
            },
            legend: { position: 'top', horizontalAlign: 'right', labels: { colors: '#94a3b8' } },
            grid: {
                borderColor: 'rgba(255,255,255,0.05)',
                padding: { top: 0, right: 0, bottom: 0, left: 0 }
            }
        };
        new ApexCharts(document.querySelector("#trendChart"), trendOptions).render();

        // STATUS CHART
        const statusOptions = {
            series: [{{ ok_count|default:0 }}, {{ nok_count|default:0 }}],
            chart: {
                height: 300,
                type: 'donut',
            },
            labels: ['OK', 'NOK'],
            colors: ['#10b981', '#ef4444'],
            plotOptions: {
                pie: {
                    donut: {
                        size: '75%',
                        labels: {
                            show: true,
                            total: {
                                show: true,
                                label: 'TOTAL',
                                color: '#94a3b8',
                                formatter: function (w) {
                                    return w.globals.seriesTotals.reduce((a, b) => a + b, 0)
                                }
                            },
                            value: {
                                color: '#f8fafc'
                            }
                        }
                    }
                }
            },
            legend: { position: 'bottom', labels: { colors: '#94a3b8' } },
            stroke: { show: false }
        };
        new ApexCharts(document.querySelector("#statusChart"), statusOptions).render();

        // AUTO-SUBMIT SEARCH (AJAX VERSION)
        const tableContainer = document.getElementById('dashboard-table-container');
        
        function bindDashboardSearch() {
            const searchInput = document.getElementById('dashboardSearchInput');
            if (!searchInput) return;

            // Move cursor to end if already focused
            if (searchInput === document.activeElement) {
                searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);
            }

            let timeout = null;
            searchInput.addEventListener('input', function() {
                clearTimeout(timeout);
                timeout = setTimeout(function() {
                    const q = searchInput.value;
                    const url = `{% url 'index' %}?q=${encodeURIComponent(q)}&partial=1`;
                    
                    // Show a subtle loading state if needed
                    tableContainer.style.opacity = '0.6';
                    
                    fetch(url, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(response => response.text())
                    .then(html => {
                        tableContainer.innerHTML = html;
                        tableContainer.style.opacity = '1';
                        bindDashboardSearch(); // Re-initialize events for the new HTML
                        
                        // Focus the new search input and keep cursor at end
                        const newInput = document.getElementById('dashboardSearchInput');
                        if (newInput) {
                            newInput.focus();
                            newInput.setSelectionRange(newInput.value.length, newInput.value.length);
                        }
                    })
                    .catch(err => {
                        console.error('Error al filtrar tabla:', err);
                        tableContainer.style.opacity = '1';
                    });
                }, 500);
            });

            // Prevent form submit if any
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') e.preventDefault();
            });
        }

        bindDashboardSearch();
    });
</script>
{% endblock %}
