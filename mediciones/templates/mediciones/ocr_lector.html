{% extends 'mediciones/index.html' %}
{% load static %}

{% block title %}Lector OCR de Planos{% endblock %}

{% block content %}
<style>
    :root {
        --stitch-primary: #e11d48;     /* Rose 600 */
        --stitch-secondary: #fda4af;   /* Rose 300 */
        --stitch-bg: #fdf2f8;          /* Rose 50 */
        --stitch-text: #1e293b;        /* Slate 800 */
        --stitch-glass: rgba(255, 255, 255, 0.9);
        --stitch-border: rgba(225, 29, 72, 0.15);
        --stitch-shadow: 0 10px 40px -10px rgba(225, 29, 72, 0.08);
    }
    
    body { font-family: 'Inter', sans-serif; }

    /* Estructura Base y Layout */
    .content-wrapper {
        max-width: none !important;
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
        background: var(--stitch-bg);
        min-height: 100vh;
    }
    
    .topbar { display: none !important; }

    .premium-container {
        display: flex;
        min-height: 100vh;
    }

    /* Sidebar Izquierdo */
    .sidebar-ocr {
        width: 280px;
        background: var(--stitch-glass);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        padding: 2rem 1.5rem;
        border-right: 1px solid var(--stitch-border);
        display: flex;
        flex-direction: column;
        gap: 2rem;
        flex-shrink: 0;
        box-shadow: 4px 0 15px rgba(225, 29, 72, 0.03);
    }

    .sidebar-title {
        font-family: 'Outfit', sans-serif;
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--stitch-text);
        letter-spacing: -0.02em;
        text-transform: uppercase;
    }

    .upload-box {
        border: 2px dashed rgba(225, 29, 72, 0.3);
        background: rgba(225, 29, 72, 0.02);
        border-radius: 16px;
        padding: 2rem 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    .upload-box:hover { background: rgba(225, 29, 72, 0.06); border-color: var(--stitch-primary); transform: translateY(-2px); }
    .upload-box i { font-size: 2.5rem; color: var(--stitch-primary); margin-bottom: 0.5rem; }
    .upload-box span { display: block; font-family: 'Outfit', sans-serif; font-weight: 800; color: var(--stitch-primary); font-size: 1rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .upload-box small { color: #64748b; font-size: 0.75rem; font-weight: 500; }

    .status-card {
        background: var(--stitch-glass);
        border: 1px solid var(--stitch-border);
        box-shadow: var(--stitch-shadow);
        border-radius: 16px;
        padding: 1.5rem;
    }
    .status-label { font-size: 0.65rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; }
    .status-value-op { font-family: 'Outfit', sans-serif; font-size: 1.6rem; font-weight: 800; color: var(--stitch-primary); margin-bottom: 1rem; }
    .status-group { margin-bottom: 1rem; }
    .status-group:last-child { margin-bottom: 0; }
    .status-value-small { font-size: 0.9rem; font-weight: 700; color: var(--stitch-text); line-height: 1.2; }

    /* Contenido Principal */
    .main-content-ocr {
        flex: 1;
        padding: 2rem 3rem;
        overflow-y: auto;
    }

    .header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    .panel-title { font-family: 'Outfit', sans-serif; font-size: 1.8rem; font-weight: 800; color: var(--stitch-text); margin: 0; text-transform: uppercase; letter-spacing: -0.02em; }

    .btn-descartar {
        background: transparent;
        border: 1px dashed #cbd5e1;
        border-radius: 12px;
        color: #64748b;
        font-family: 'Outfit', sans-serif;
        font-weight: 800;
        text-transform: uppercase;
        font-size: 0.85rem;
        padding: 0.6rem 1.5rem;
        transition: all 0.2s;
        cursor: pointer;
    }
    .btn-descartar:hover { color: #1e293b; border-color: #64748b; background: rgba(0,0,0,0.02); }

    .btn-confirmar {
        background: linear-gradient(135deg, var(--stitch-primary), #be123c);
        color: white;
        border: none;
        border-radius: 14px;
        padding: 0.75rem 2rem;
        font-family: 'Outfit', sans-serif;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.9rem;
        box-shadow: 0 10px 20px -5px rgba(225, 29, 72, 0.4);
        transition: all 0.3s;
        cursor: pointer;
    }
    .btn-confirmar:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 15px 30px -5px rgba(225, 29, 72, 0.5); }

    /* Panel de Verificación (Selectores) */
    .verification-bar {
        background: var(--stitch-glass);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--stitch-border);
        box-shadow: var(--stitch-shadow);
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
    }
    .selector-group { display: flex; flex-direction: column; gap: 0.4rem; }
    .selector-label { font-size: 0.65rem; font-weight: 800; color: var(--stitch-primary); text-transform: uppercase; letter-spacing: 0.05em; }
    .selector-select {
        background: white;
        border: 1px solid var(--stitch-border);
        border-radius: 12px;
        padding: 0.5rem 0.8rem;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--stitch-text);
        transition: all 0.2s;
    }
    .selector-select:focus {
        border-color: var(--stitch-primary);
        box-shadow: 0 0 0 4px rgba(225, 29, 72, 0.1);
        outline: none;
    }

    .ok-text { color: #10b981 !important; }
    .nok-text { color: #ef4444 !important; }

    /* Matriz de Control */
    .matrix-card {
        background: var(--stitch-glass);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 24px;
        border: 1px solid var(--stitch-border);
        box-shadow: var(--stitch-shadow);
        overflow: hidden;
    }
    .matrix-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px dashed var(--stitch-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: transparent;
    }
    .matrix-title { font-family: 'Outfit', sans-serif; font-size: 1.2rem; font-weight: 800; color: var(--stitch-primary); text-transform: uppercase; margin: 0; }
    .matrix-badge {
        background: rgba(225, 29, 72, 0.1);
        color: var(--stitch-primary);
        font-size: 0.7rem;
        font-weight: 800;
        padding: 0.4rem 0.8rem;
        border-radius: 8px;
        text-transform: uppercase;
        border: 1px solid rgba(225, 29, 72, 0.2);
    }

    .table-ocr {
        width: 100%;
        border-collapse: collapse;
    }
    .table-ocr th {
        background: #f8fafc;
        text-align: left;
        padding: 0.4rem 0.6rem;
        font-size: 0.6rem;
        font-weight: 800;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 2px solid #e2e8f0;
    }
    .table-ocr td {
        padding: 0.6rem 0.6rem;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.85rem;
        font-weight: 500;
        color: #334155;
    }
    .table-ocr tr:last-child td { border-bottom: none; }

    .instr-badge {
        background: #1e293b;
        color: white;
        font-size: 0.6rem;
        font-weight: 700;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        display: inline-block;
        white-space: nowrap;
    }

    .val-text { font-weight: 800; color: #10b981; }
    .val-text.nok { color: #ef4444; }

    /* Paginación y Visibilidad - DESHABILITADO */
    
    .piece-paginator {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        background: #f1f5f9;
        padding: 0.2rem;
        border-radius: 8px;
    }
    .btn-page {
        border: 1px solid #cbd5e1;
        background: white;
        color: #1e293b;
        font-size: 0.75rem;
        font-weight: 800;
        padding: 0.3rem 0.6rem;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-page:hover:not(:disabled) { background: #f8fafc; border-color: #cbd5e1; }
    .btn-page:disabled { opacity: 0.3; cursor: not-allowed; }

    @media (max-width: 1200px) {
        .verification-bar { grid-template-columns: repeat(2, 1fr); }
    }

    /* Editable Inputs */
    .ocr-input-edit {
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        font-family: inherit;
        font-size: inherit;
        font-weight: inherit;
        color: inherit;
        text-align: inherit;
        width: 100%;
        padding: 4px;
        transition: all 0.2s;
        outline: none;
    }
    .ocr-input-edit:hover {
        background: rgba(59, 130, 246, 0.05);
        border-color: #cbd5e1;
    }
    .ocr-input-edit:focus {
        background: white;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .val-input {
        width: 65px;
        margin: 0 auto;
    }

    /* Animación de Rotación */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .animate-spin {
        display: inline-block;
        animation: spin 1.5s linear infinite;
    }
    
    .text-warning-custom { color: #f59e0b !important; }
</style>

<div class="premium-container animate__animated animate__fadeIn">
    <!-- SIDEBAR -->
    <aside class="sidebar-ocr">
        <h1 class="sidebar-title">LECTOR OCR</h1>
        
        <form method="post" enctype="multipart/form-data" id="ocr-upload-form">
            {% csrf_token %}
            

            <!-- Configuración movida a pantalla dedicada -->

            <input type="file" name="plano_pdf" id="plano_pdf" accept="application/pdf" style="display: none;">
            <div id="upload-content" class="upload-box" onclick="document.getElementById('plano_pdf').click();">
                <i class="ri-file-pdf-2-line"></i>
                <span>Cargar PDF</span>
                <small>Digitalización automática</small>
            </div>
            <!-- Loader Simplificado y Robusto -->
            <div id="processing-loader" style="display: none;" class="px-5 py-5 animate__animated animate__fadeIn">
                <style>
                    @keyframes neon-pulse {
                        0% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
                        50% { transform: scale(1.05); opacity: 0.9; box-shadow: 0 0 0 25px rgba(220, 38, 38, 0); text-shadow: 0 0 10px #dc2626; }
                        100% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
                    }
                    .scan-pulse-icon {
                        font-size: 5rem;
                        color: #dc2626; /* Rojo intenso */
                        animation: neon-pulse 1.5s infinite ease-out;
                        border-radius: 10%; /* Cuadrado redondeado para simular escaner */
                        padding: 10px;
                        display: inline-block;
                    }
                </style>

                <div class="mb-4 text-center">
                    <i class="ri-scan-2-line scan-pulse-icon"></i>
                </div>
                
                <h4 class="text-danger fw-bold text-center mb-3">Digitalizando Plano...</h4>
                <p class="text-muted text-center mb-0" style="font-size: 1.1rem;">
                    El sistema está extrayendo y verificando las mediciones. <br>
                    <span class="text-dark fw-bold">Aguarde un momento mientras se completa la lectura.</span>
                </p>
                <div class="text-center mt-3">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Procesando...</span>
                    </div>
                </div>
            </div>
            
            <script>
                function showLoader() {
                    // Lógica simple: Solo mostrar/ocultar. La animación es CSS puro (imposible que se tilde).
                    const loader = document.getElementById('processing-loader');
                    const upload = document.getElementById('upload-content');
                    
                    if (loader) loader.style.display = 'block';
                    if (upload) upload.style.display = 'none';
                    
                    // Asegurar que cualquier intervalo viejo muera
                    if (window.ocrInterval) clearInterval(window.ocrInterval);
                }

                // AJAX Upload
                const fileInput = document.getElementById('plano_pdf');
                if (fileInput) {
                    fileInput.addEventListener('change', function() {
                        if(this.files.length > 0) {
                            showLoader();
                            
                            const form = document.getElementById('ocr-upload-form');
                            if (!form) return;
                            
                            const formData = new FormData(form);
                            
                            fetch(window.location.href, {
                                method: 'POST',
                                body: formData,
                            })
                            .then(response => response.text())
                            .then(html => {
                                document.open();
                                document.write(html);
                                document.close();
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert("Ocurrió un error de conexión.");
                            });
                        }
                    });
                }
            </script>
        </form>

        {% if success %}
        <div class="status-card">
            <div class="status-group">
                <label class="status-label">Número de OP</label>
                <div class="status-value-op">#{{ header.op }}</div>
            </div>
            <div class="status-group">
                <label class="status-label">Proyecto</label>
                <div class="status-value-small">{{ header.proyecto }}</div>
            </div>
            <div class="status-group">
                <label class="status-label">Cliente / Artículo</label>
                <div class="status-value-small">{{ header.cliente|truncatechars:40 }}</div>
                <div style="font-size: 0.7rem; color: #64748b; margin-top: 2px;">{{ header.articulo }}</div>
            </div>
        </div>
        {% endif %}
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content-ocr">
        <div class="header-actions">
            <h2 class="panel-title">Panel de Verificación</h2>
            <div class="d-flex align-items-center gap-2">
                <button class="btn-descartar" onclick="location.reload();">Descartar</button>
                {% if success %}
                <button id="btn-importar-sistema" class="btn-confirmar">Confirmar e Importar</button>
                {% endif %}
            </div>
        </div>

        {% if success %}
        <!-- SELECTORES DE VINCULACIÓN -->
        <div class="verification-bar animate__animated animate__fadeInDown">
            <div class="selector-group">
                <label class="selector-label">Cliente</label>
                <select id="sel-cliente-ocr" class="selector-select">
                    <option value="">--- Seleccionar ---</option>
                    {% for c in clientes %}
                    <option value="{{ c.id }}" {% if c.id == auto_matched.cliente_id %}selected{% endif %}>{{ c.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="selector-group">
                <label class="selector-label">Proceso</label>
                <select id="sel-proceso-ocr" class="selector-select">
                    <option value="">--- Seleccionar ---</option>
                    {% for p in procesos %}
                    <option value="{{ p.id }}" {% if p.id == auto_matched.proceso_id %}selected{% endif %}>{{ p.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="selector-group">
                <label class="selector-label">Artículo</label>
                <select id="sel-articulo-ocr" class="selector-select">
                    <option value="">--- Seleccionar ---</option>
                    {% for a in articulos %}
                    <option value="{{ a.id }}" {% if a.id == auto_matched.articulo_id %}selected{% endif %}>{{ a.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="selector-group">
                <label class="selector-label">Operación</label>
                <select id="sel-elemento-ocr" class="selector-select">
                    <option value="">--- Seleccionar ---</option>
                    {% for e in elementos %}
                    <option value="{{ e.id }}" {% if e.id == auto_matched.elemento_id %}selected{% endif %}>{{ e.nombre|upper }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- TABLA DE RESULTADOS (Estilo Profesional Audit) -->
        <div class="matrix-card animate__animated animate__fadeInUp">
            <div class="matrix-header">
                <div>
                    <h3 class="matrix-title">Panel de Resultados OCR</h3>
                    <div style="font-size: 0.75rem; color: #64748b; font-weight: 700;">{{ matrix|length }} Controles Detectados / {{ piezas|length }} Piezas Auditadas</div>
                </div>
                
            </div>
            
            <div class="table-responsive" style="overflow-x: auto; background: white;">
                <table class="table-ocr" id="tabla-ocr-resultados" style="width: 100%; border-collapse: separate; border-spacing: 0;">
                    <thead>
                        <tr>
                            <!-- 1. Control (Sticky 0) -->
                            <th style="width: 280px; min-width: 280px; background: #f8fafc; border-bottom: 2px solid #cbd5e1; position: sticky; left: 0; z-index: 30; box-shadow: 2px 0 5px rgba(0,0,0,0.05);" class="ps-4">Control Detectado</th>
                            
                            <!-- 2. Nominal (Sticky 280) -->
                            <th class="text-center" style="width: 120px; min-width: 120px; background: #f8fafc; border-bottom: 2px solid #cbd5e1; position: sticky; left: 280px; z-index: 30;">Nominal</th>
                            
                            <!-- 3. Tol (Sticky 400) -->
                             <th class="text-center" style="width: 160px; min-width: 160px; background: #f8fafc; border-bottom: 2px solid #cbd5e1; position: sticky; left: 400px; z-index: 30;">Tol.</th>
                            
                            <!-- 4. Instr (Sticky 560) -->
                            <th class="text-center" style="width: 90px; min-width: 90px; background: #f8fafc; border-bottom: 2px solid #cbd5e1; position: sticky; left: 560px; z-index: 30; border-right: 2px solid #e2e8f0; box-shadow: 2px 0 5px rgba(0,0,0,0.05);">Instr.</th>
                            
                            {% for p in piezas %}
                            <th class="text-center" style="width: 85px; min-width: 85px; color: #3b82f6; font-size: 0.8rem; font-weight: 800; padding: 0.5rem 0; border-bottom: 2px solid #e2e8f0; background: #fff;">
                                P{{ p }}
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in matrix %}
                        <tr class="ocr-row" style="border-bottom: 1px solid #f1f5f9;">
                            <!-- 1. Control -->
                            <td class="fw-bold ps-4" style="position: sticky; left: 0; z-index: 20; background: #ffffff; border-right: 1px solid #f1f5f9; white-space: nowrap; box-shadow: 2px 0 5px rgba(0,0,0,0.05);">
                                <input type="text" class="ocr-input-edit text-start edit-control" value="{{ row.control }}" style="font-weight: 700; width: 250px; color: #475569; font-size: 0.8rem;">
                            </td>
                            
                            <!-- 2. Nominal -->
                            <td class="text-center" style="position: sticky; left: 280px; z-index: 20; background: #ffffff; white-space: nowrap;">
                                <input type="text" class="ocr-input-edit text-center edit-nominal" value="{{ row.nominal }}" style="color: #2563eb; font-weight: 800; width: 100px; font-size: 0.9rem;">
                            </td>
                            
                            <!-- 3. Tol -->
                            <td class="text-center" style="position: sticky; left: 400px; z-index: 20; background: #ffffff; border-right: 1px solid #f1f5f9; white-space: nowrap;">
                                <div class="d-flex align-items-center justify-content-center">
                                    <input type="text" class="ocr-input-edit text-center edit-tol" value="{{ row.tolerancia }}" style="color: #475569; font-weight: 700; width: 140px; font-size: 0.85rem;">
                                </div>
                            </td>
                            
                            <!-- 4. Instr -->
                            <td class="text-center" style="position: sticky; left: 560px; z-index: 20; background: #ffffff; border-right: 2px solid #e2e8f0; white-space: nowrap; box-shadow: 2px 0 5px rgba(0,0,0,0.05);">
                                <input type="text" class="ocr-input-edit text-center edit-instr" value="{{ row.instrumento }}" style="font-size: 0.75rem; font-weight: 800; color: #1e293b; background: #f1f5f9; padding: 0.2rem 0.4rem; border-radius: 4px; width: 70px;">
                            </td>
                            
                            {% for item in row.valores %}
                            <td class="text-center" style="padding: 0.6rem 0.4rem; border-right: 1px solid #f8fafc; background: #fff;">
                                <input type="text" 
                                       class="ocr-input-edit text-center val-input edit-val {% if item.ok == False %}nok-text{% else %}ok-text{% endif %}" 
                                       value="{% if item.val is not None %}{{ item.val }}{% elif item.get and item.get.val is not None %}{{ item.get.val }}{% else %}{{ item }}{% endif %}"
                                       style="font-size: 0.95rem; font-weight: 800; width: 65px;">
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <!-- ESTADO VACÍO -->
        <div class="text-center py-5 opacity-50" style="margin-top: 5rem;">
            <i class="ri-file-pdf-line" style="font-size: 8rem; color: var(--stitch-primary); opacity: 0.5;"></i>
            <h2 class="mt-4" style="font-family: 'Outfit', sans-serif; font-weight: 800; color: var(--stitch-text); text-transform: uppercase;">Esperando Documento...</h2>
            <p style="font-weight: 500; color: #64748b;">Suba un archivo PDF para comenzar el proceso de digitalización inteligente.</p>
        </div>
        {% endif %}

        {% if header.ai_error_msg %}
        <div class="alert alert-danger animate__animated animate__headShake" role="alert" style="margin-top: 1rem;">
            <i class="ri-error-warning-line me-2"></i>
            <strong>Error de IA:</strong> {{ header.ai_error_msg }}. 
            <small class="d-block mt-1">Por favor verifique su API Key o intente nuevamente.</small>
        </div>
        {% endif %}
        
        {% if header.denominacion == "DOCUMENTO ESCANEADO - DATOS NO LEGIBLES" %}
        <div class="alert alert-warning animate__animated animate__headShake" role="alert" style="margin-top: 2rem;">
            <i class="ri-alert-line me-2"></i>
            <strong>Atención:</strong> El documento parece ser una imagen escaneada sin texto digital. 
            El sistema no pudo extraer los valores automáticamente. Por favor, complete los datos manualmente.
        </div>
        {% endif %}
    </main>
</div>

<script>
    // Paginación DESHABILITADA - Mostrando todas las piezas
    function changePiecePage(dir) {
        // No hacer nada
    }

    function showLoader() {
        if (document.getElementById('upload-content')) document.getElementById('upload-content').style.display = 'none';
        if (document.getElementById('processing-loader')) document.getElementById('processing-loader').style.display = 'block';
    }

    {% if success %}
    document.getElementById('btn-importar-sistema').addEventListener('click', function() {
        const header = JSON.parse('{{ header_json|escapejs }}');
        const piezas = JSON.parse('{{ piezas_json|escapejs }}');
        
        // Colactar matrix desde la tabla editable
        const matrix = [];
        document.querySelectorAll('.ocr-row').forEach(tr => {
            const rowData = {
                control: tr.querySelector('.edit-control').value,
                nominal: tr.querySelector('.edit-nominal').value,
                tolerancia: tr.querySelector('.edit-tol').value,
                instrumento: tr.querySelector('.edit-instr').value,
                valores: []
            };
            
            tr.querySelectorAll('.edit-val').forEach(input => {
                // Si el original era un objeto {val, ok}, mantenemos estructura básica
                // El backend procesará los valores
                rowData.valores.push(input.value);
            });
            
            matrix.push(rowData);
        });
        
        const payload = {
            header: header,
            piezas: piezas, 
            matrix: matrix,
            proceso_id: document.getElementById('sel-proceso-ocr').value,
            articulo_id: document.getElementById('sel-articulo-ocr').value,
            elemento_id: document.getElementById('sel-elemento-ocr').value,
            cliente_id: document.getElementById('sel-cliente-ocr').value
        };

        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

        fetch("{% url 'importar_datos_ocr' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    title: '¡Importación Exitosa!',
                    text: data.message,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    // Redirigir usando Proyecto y Proceso exactos para que Nueva Medición traiga TODO
                    window.location.href = `{% url 'nueva_medicion_op' %}?op=${data.op}&proy=${encodeURIComponent(data.proy)}&proc=${data.proc_id}`;
                });
            } else {
                alert('Error: ' + data.message);
                btn.disabled = false;
                btn.innerHTML = 'Confirmar e Importar';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión al importar.');
            btn.disabled = false;
            btn.innerHTML = 'Confirmar e Importar';
        });
    });
    {% endif %}
</script>
{% endblock %}
