{% extends 'mediciones/base.html' %}
{% load static %}

{% block title %}Historial: {{ instrumento.nombre }}{% endblock %}

{% block content %}
<div class="premium-dashboard-container animate__animated animate__fadeIn">
    <!-- Breadcrumb -->
    <nav class="mb-4">
        <ol class="breadcrumb premium-breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard_calibracion' %}">Metrología</a></li>
            <li class="breadcrumb-item active">{{ instrumento.nombre }}</li>
        </ol>
    </nav>

    <div class="row g-4">
        <!-- Sidebar Info -->
        <div class="col-lg-4">
            <div class="premium-card sticky-top" style="top: 20px;">
                <div class="text-center mb-4">
                    <div class="instrument-avatar">
                        <i class="ri-tools-fill"></i>
                    </div>
                    <h2 class="premium-title mt-3" style="font-size: 1.5rem;">{{ instrumento.nombre }}</h2>
                    <span class="badge bg-primary-soft text-primary mt-1">{{ instrumento.get_tipo_display|upper }}</span>
                </div>

                <div class="instrument-details-list">
                    <div class="detail-item">
                        <span class="label">Código/Inventario</span>
                        <span class="value">{{ instrumento.codigo|default:"Sin código" }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Marca</span>
                        <span class="value">{{ instrumento.marca|default:"Genérico" }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Frecuencia de Calib.</span>
                        <span class="value">{{ instrumento.frecuencia_meses }} meses</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Estado Actual</span>
                        <span class="value">
                            {% if not instrumento.en_servicio %}
                                <span class="text-danger">● FUERA DE SERVICIO</span>
                            {% elif instrumento.is_calibracion_vencida %}
                                <span class="text-danger">● VENCIDO</span>
                            {% elif instrumento.is_en_alerta %}
                                <span class="text-warning">● EN ALERTA</span>
                            {% else %}
                                <span class="text-success">● OPERATIVO</span>
                            {% endif %}
                        </span>
                    </div>
                </div>

                <hr class="my-4" style="opacity: 0.1;">

                <div class="d-grid gap-2">
                    <button onclick="openCalibrationModal('{{ instrumento.id }}', '{{ instrumento.nombre }}')" class="btn-premium-primary w-100 justify-content-center">
                        <i class="ri-shield-check-line"></i> Registrar Calibración
                    </button>
                    <a href="{% url 'editar_instrumento' instrumento.pk %}" class="btn-premium-secondary w-100 justify-content-center">
                        <i class="ri-edit-line"></i> Editar Datos Maestro
                    </a>
                </div>
            </div>
        </div>

        <!-- content: History Timeline -->
        <div class="col-lg-8">
            <div class="premium-card">
                <h3 class="card-title-premium mb-5">Historial Maestro de Calibraciones</h3>
                
                <div class="premium-timeline">
                    {% for item in historial %}
                    <div class="timeline-item animate__animated animate__fadeInUp" style="animation-delay: {{ forloop.counter0|add:1 }}00ms">
                        <div class="timeline-marker {% if item.resultado == 'APROBADO' %}bg-success{% else %}bg-danger{% endif %}"></div>
                        <div class="timeline-content">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h4 class="m-0 fw-800 text-dark">Calibración #{{ forloop.revcounter }}</h4>
                                    <span class="text-muted small"><i class="ri-calendar-line"></i> {{ item.fecha_calibracion|date:"d F, Y" }}</span>
                                </div>
                                <div class="text-end">
                                    <span class="status-pill {% if item.resultado == 'APROBADO' %}green{% else %}red{% endif %}">
                                        {{ item.resultado }}
                                    </span>
                                </div>
                            </div>

                            <div class="timeline-body p-3 bg-light rounded-3 mt-3">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="text-xxs text-muted text-uppercase fw-800">Certificado</div>
                                        <div class="fw-bold text-dark">{{ item.certificado_nro|default:"S/N" }}</div>
                                    </div>
                                    <div class="col-md-6 text-md-end">
                                        <div class="text-xxs text-muted text-uppercase fw-800">Registrado por</div>
                                        <div class="fw-bold text-dark">{{ item.usuario.get_full_name|default:item.usuario.username }}</div>
                                    </div>
                                    {% if item.observaciones %}
                                    <div class="col-12">
                                        <div class="text-xxs text-muted text-uppercase fw-800">Observaciones</div>
                                        <div class="small text-muted italic italic-text">"{{ item.observaciones }}"</div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if item.archivo_certificado %}
                            <div class="mt-3">
                                <a href="{{ item.archivo_certificado.url }}" target="_blank" class="cert-link-premium">
                                    <i class="ri-file-search-line"></i> Ver Archivo Adjunto (Certificado)
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5">
                        <div class="empty-state">
                            <i class="ri-history-line"></i>
                            <p>No hay registros históricos para este instrumento.</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'mediciones/components/modal_calibracion.html' %}

<style>
    .premium-breadcrumb { display: flex; align-items: center; list-style: none; padding: 0; gap: 0.5rem; font-size: 0.95rem; }
    .premium-breadcrumb .breadcrumb-item { display: flex; align-items: center; gap: 0.5rem; color: #64748b; font-weight: 600; }
    .premium-breadcrumb .breadcrumb-item + .breadcrumb-item::before { content: "›"; color: #94a3b8; font-size: 1.2rem; display: inline-block; line-height: 1; margin-right: 0.5rem; }
    .premium-breadcrumb a { color: #3b82f6; text-decoration: none; transition: color 0.2s; }
    .premium-breadcrumb a:hover { color: #2563eb; }
    
    .instrument-avatar { width: 80px; height: 80px; background: #eff6ff; color: #3b82f6; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin: 0 auto; border: 2px solid #dbeafe; }
    
    .instrument-details-list { display: flex; flex-direction: column; gap: 1rem; margin-top: 2rem; }
    .detail-item { display: flex; justify-content: space-between; border-bottom: 1px solid #f1f5f9; padding-bottom: 0.5rem; align-items: center; }
    .detail-item .label { font-size: 0.7rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
    .detail-item .value { font-size: 0.9rem; font-weight: 700; color: #1e293b; text-align: right; }

    /* Timeline Styles - Fixed for Overlap */
    .premium-timeline { position: relative; padding-left: 2.5rem; margin-top: 1rem; }
    .premium-timeline::before { content: ''; position: absolute; left: 0.5rem; top: 0; bottom: 0; width: 2px; background: #e2e8f0; }
    
    .timeline-item { position: relative; margin-bottom: 2.5rem; }
    .timeline-marker { position: absolute; left: calc(-2rem - 3px); top: 5px; width: 14px; height: 14px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 4px rgba(226, 232, 240, 1); z-index: 2; }
    
    .timeline-content { background: white; border-radius: 16px; padding: 0 !important; }
    .timeline-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
    
    .timeline-body { padding: 1.25rem !important; background: #f8fafc; border-radius: 12px; border: 1px solid #f1f5f9; }
    .timeline-body .row { margin: 0 !important; }
    .timeline-body .col-md-6, .timeline-body .col-12 { padding: 0.5rem !important; }

    .text-xxs { font-size: 0.65rem !important; letter-spacing: 0.05em; margin-bottom: 2px; }
    
    .cert-link-premium { display: inline-flex; align-items: center; gap: 8px; padding: 0.6rem 1rem; background: #f0f9ff; color: #0369a1; border-radius: 10px; font-weight: 700; font-size: 0.8rem; text-decoration: none; border: 1px solid #bae6fd; transition: all 0.2s; margin-top: 0.75rem; }
    .cert-link-premium:hover { background: #e0f2fe; transform: translateX(5px); }

    .italic-text { font-style: italic; line-height: 1.4; display: block; }
</style>
{% endblock %}
