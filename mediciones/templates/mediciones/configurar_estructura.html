{% extends 'mediciones/index.html' %}
{% load static %}

{% block title %}Configurar Estructura{% endblock %}

{% block content %}
{{ existing_data|json_script:"existing-data-json" }}
<div class="premium-page-container">
    <form id="estructuraForm">
        {% csrf_token %}
        <div class="row g-4">
            <!-- Left Panel: Sidebar Configurator (The "Builder") -->
            <div class="col-lg-4 col-xl-3">
                <div class="premium-panel-side">
                    <!-- Top Title Section -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center gap-2 mb-2">
                             <a href="javascript:history.back()" class="btn-back-simple">
                                <i class="ri-arrow-left-line"></i> Volver
                            </a>
                        </div>
                        <h1 class="side-title-main">{{ titulo }}</h1>
                        <p class="side-subtitle-main">Arme la jerarquía de procesos y controles para el proyecto.</p>
                    </div>

                    <!-- Cliente -->
                    <div class="config-card mb-3">
                        <div class="config-card-header text-primary">
                            <i class="ri-user-heart-line"></i>
                            <span>CLIENTE</span>
                        </div>
                        <div class="config-card-body">
                            <div class="d-flex gap-2">
                                <select id="header_cliente" class="form-select input-clean" required>
                                    <option value="">Seleccione Cliente...</option>
                                    {% for c in clientes %}
                                    <option value="{{ c.id }}">{{ c.nombre }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn-add-mini" onclick="openQuickAdd('cliente')">
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Proyecto -->
                    <div class="config-card mb-3">
                        <div class="config-card-header text-primary">
                            <i class="ri-layout-grid-line"></i>
                            <span>PROYECTO</span>
                        </div>
                        <div class="config-card-body">
                            <input type="text" id="header_proyecto" class="form-control input-clean" placeholder="Ej: 25-092" required 
                                   value="{{ existing_data.proyecto|default:'' }}">
                        </div>
                    </div>

                    <!-- OP Section -->
                    <div class="config-card mb-3">
                        <div class="config-card-header text-primary">
                            <i class="ri-file-list-3-line"></i>
                            <span>NÚMERO DE OP</span>
                        </div>
                        <div class="config-card-body">
                            <input type="number" id="header_num_op" class="form-control input-clean" placeholder="Ej: 4526"
                                   value="{{ existing_data.num_op|default:'' }}">
                        </div>
                    </div>

                    <!-- Añadir Proceso Section -->
                    <div class="config-card mb-4 border-success-soft">
                        <div class="config-card-header text-success">
                            <i class="ri-checkbox-circle-line"></i>
                            <span>PROCESO</span>
                        </div>
                        <div class="config-card-body">
                            <div class="d-flex gap-2 mb-3">
                                <select id="sidebar_process_select" class="form-select input-clean">
                                    <option value="">Seleccione Proceso...</option>
                                    {% for p in procesos_list %}
                                    <option value="{{ p.id }}">{{ p.nombre }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn-add-mini" onclick="openQuickAdd('proceso')">
                                </button>
                            </div>

                            <div class="config-card-header text-success" style="padding-left: 0; padding-top: 0.5rem;">
                                <i class="ri-puzzle-line"></i>
                                <span>ELEMENTO</span>
                            </div>
                            <div class="d-flex gap-2 mb-3">
                                <select id="sidebar_element_select" class="form-select input-clean">
                                    <option value="">Seleccione Elemento...</option>
                                    {% for e in elementos_list %}
                                    <option value="{{ e.id }}">{{ e.nombre }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn-add-mini" onclick="openQuickAdd('elemento')">
                                </button>
                            </div>

                            <button type="button" class="btn btn-primary w-100" style="font-weight: 700; border-radius: 10px;" onclick="addProcessFromSidebar()">
                                <i class="ri-add-circle-line"></i> Agregar
                            </button>
                        </div>
                    </div>

                    <!-- Save Action -->
                    <div class="action-panel-dark" style="padding: 1rem;">
                        <button type="submit" class="btn-guardar-estructura w-100" style="margin-top: 0 !important;">
                            <i class="ri-check-line"></i> Guardar Estructura
                        </button>
                    </div>

                    <input type="hidden" id="header_articulo" value="">
                </div>
            </div>

            <!-- Right Panel: Main Hierarchy Display -->
            <div class="col-lg-8 col-xl-9">
                <div class="main-canvas-premium">
                    <div class="canvas-header">
                        <div class="d-flex align-items-center gap-2">
                            <div class="blue-line-indicator"></div>
                            <h3 class="canvas-title">JERARQUÍA DE CONTROLES</h3>
                        </div>
                    </div>

                    <div id="processes-container" class="mt-4">
                        <!-- Empty State -->
                        <div id="empty-state" class="empty-state-placeholder">
                            <i class="ri-list-settings-line"></i>
                            <p>No hay procesos definidos en la estructura actual.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    :root {
        --primary-blue: #2563eb;
        --success-green: #10b981;
        --dark-bg: #0f172a;
        --border-color: #e2e8f0;
        --text-muted: #64748b;
    }

    .premium-page-container { padding: 1.5rem; max-width: 1700px; margin: 0 auto; }

    /* Left Sidebar Styling */
    .premium-panel-side { position: sticky; top: 1.5rem; }
    
    .btn-back-simple { color: #64748b; font-size: 0.85rem; font-weight: 600; text-decoration: none; display: flex; align-items: center; gap: 0.4rem; padding: 0.4rem 0.8rem; background: #f1f5f9; border-radius: 8px; transition: 0.2s; border: 1px solid #e2e8f0; width: fit-content; }
    .btn-back-simple:hover { background: #e2e8f0; color: #1e293b; }

    .side-title-main { font-size: 1.7rem; font-weight: 800; color: #0f172a; margin-top: 1rem; letter-spacing: -0.02em; }
    .side-subtitle-main { color: #64748b; font-size: 0.9rem; margin-bottom: 2rem; }

    .config-card { background: white; border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .config-card-header { padding: 0.85rem 1rem 0.5rem; display: flex; align-items: center; gap: 0.6rem; font-weight: 800; font-size: 0.75rem; letter-spacing: 0.05em; border-bottom: none; }
    .config-card-body { padding: 0.5rem 1rem 1rem; }
    
    .border-success-soft { border: 2px solid #10b981 !important; }

    .input-clean { border-radius: 8px !important; border: 1px solid #cbd5e1 !important; padding: 0.6rem 0.75rem !important; font-size: 0.9rem !important; font-weight: 500 !important; color: #334155 !important; }
    .input-clean:focus { border-color: var(--primary-blue) !important; box-shadow: 0 0 0 3px rgba(37,99,235,0.1) !important; }

    .btn-add-mini { background: #eff6ff; border: 1px solid #dbeafe; border-radius: 8px; width: 38px; height: 38px; flex-shrink: 0; position: relative; }
    .btn-add-mini::after { content: ''; width: 20px; height: 20px; background: #2563eb; mask: url('https://api.iconify.design/ri:add-line.svg') no-repeat center; -webkit-mask: url('https://api.iconify.design/ri:add-line.svg') no-repeat center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .btn-add-mini:hover { background: #2563eb; }
    .btn-add-mini:hover::after { background: white; }

    .btn-configurar-proceso { background: #e0e7ff; color: #4338ca; border: 1px solid #c7d2fe; border-radius: 10px; padding: 0.75rem; font-weight: 800; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: 0.2s; }
    .btn-configurar-proceso:hover { background: #4338ca; color: white; transform: translateY(-1px); }

    .action-panel-dark { background: #161e2e; border-radius: 12px; padding: 1.5rem; color: white; margin-top: 1rem; }
    .action-header { display: flex; align-items: center; gap: 0.6rem; font-weight: 800; font-size: 0.75rem; letter-spacing: 0.05em; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.5rem; }
    .btn-guardar-estructura { background: white; color: #161e2e; border: none; border-radius: 10px; padding: 0.85rem; font-weight: 800; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 0.6rem; transition: 0.2s; }
    .btn-guardar-estructura:hover { background: #f8fafc; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

    /* Right Canvas Styling */
    .main-canvas-premium { background: white; border-radius: 16px; border: 1px solid var(--border-color); padding: 2rem; min-height: 800px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03); }
    .canvas-header { margin-bottom: 2rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 1rem; }
    .blue-line-indicator { width: 4px; height: 20px; background: var(--primary-blue); border-radius: 4px; }
    .canvas-title { font-size: 1rem; font-weight: 800; color: #1e293b; margin: 0; letter-spacing: 0.02em; }

    /* Dynamic Process Block */
    .process-card-item { background: #f8fafc; border-radius: 16px; border: 1px solid #e2e8f0; padding: 1.5rem; margin-bottom: 2rem; }
    .process-badge-modern { background: #e0e7ff; color: #3730a3; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 800; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 0.6rem; margin-bottom: 1.5rem; text-transform: uppercase; }
    
    /* Control Row Grid (Shrinked columns) */
    .control-row-compact { 
        display: grid; 
        grid-template-columns: 2fr auto 100px 100px 100px auto; 
        gap: 1rem; 
        background: white; 
        border: 1px solid #f1f5f9; 
        padding: 1rem; 
        border-radius: 12px; 
        margin-bottom: 0.75rem; 
        align-items: flex-end;
    }
    
    .control-label-mini { font-size: 0.6rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.4rem; display: block; letter-spacing: 0.05em; }
    .input-compact { padding: 0.5rem !important; font-size: 0.85rem !important; border-radius: 6px !important; text-align: center; }

    .btn-add-ctrl-soft { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 700; color: #64748b; margin-top: 0.5rem; transition: 0.2s; }
    .btn-add-ctrl-soft:hover { border-color: var(--primary-blue); color: var(--primary-blue); background: #eff6ff; }

    .btn-remove-soft { color: #fca5a5; background: none; border: none; padding: 0.4rem; display: flex; align-items: center; justify-content: center; border-radius: 6px; }
    .btn-remove-soft:hover { background: #fef2f2; color: #ef4444; }

    .empty-state-placeholder { text-align: center; padding: 8rem 2rem; color: #cbd5e1; }
    .empty-state-placeholder i { font-size: 3.5rem; margin-bottom: 1rem; display: block; }
    .empty-state-placeholder p { font-weight: 600; font-size: 0.95rem; }

    .text-xxs { font-size: 0.65rem; }

</style>

<!-- Quick Add Modal -->
<div id="quickAddModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px); z-index: 9999; justify-content: center; align-items: center;">
    <div class="card" style="width: 380px; padding: 2rem; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.15);">
        <h4 id="modalTitle" class="mb-3" style="font-weight: 800; color: #0f172a;">Agregar Nuevo</h4>
        <input type="text" id="newItemName" class="form-control mb-4" placeholder="Nombre..." style="border-radius: 10px; padding: 0.75rem;">
        <input type="hidden" id="currentModelType">
        <div class="d-flex justify-content-end gap-2">
            <button type="button" onclick="closeQuickAdd()" class="btn btn-light" style="border-radius: 8px; font-weight: 600;">Cerrar</button>
            <button type="button" onclick="saveNewItem()" class="btn btn-primary" style="border-radius: 8px; font-weight: 700;">Guardar</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Global Datalist for Searchable Controls -->
    <datalist id="controles-datalist">
        {% for c in controles_list %}
        <option value="{{ c.nombre }}" data-id="{{ c.id }}">
        {% endfor %}
    </datalist>

    <script>
        // JS Map for name -> id resolution
        const controlMap = {
            {% for c in controles_list %}"{{ c.nombre|escapejs }}": "{{ c.id }}",{% endfor %}
        };

        let processCounter = 0;

        function addProcessFromSidebar(skipControlRow = false) {
            const selectProc = document.getElementById('sidebar_process_select');
            const selectElem = document.getElementById('sidebar_element_select');
            
            const pId = selectProc.value;
            const eId = selectElem.value;
            
            if(!pId || !eId) {
                Swal.fire({ 
                    toast: true, 
                    position: 'top', 
                    icon: 'info', 
                    title: 'Seleccione Proceso y Elemento', 
                    showConfirmButton: false, 
                    timer: 2000,
                    customClass: {
                        popup: 'premium-swal-popup',
                        title: 'premium-swal-title'
                    }
                });
                return false;
            }
            const pName = selectProc.options[selectProc.selectedIndex].text;
            const eName = selectElem.options[selectElem.selectedIndex].text;
            
            const empty = document.getElementById('empty-state');
            if(empty) empty.remove();

            processCounter++;
            const container = document.getElementById('processes-container');
            const div = document.createElement('div');
            div.className = 'process-card-item animate__animated animate__fadeInUp';
            div.id = `proc-block-${processCounter}`;
            div.setAttribute('data-proceso-id', pId);
            div.setAttribute('data-elemento-id', eId);
            
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="d-flex gap-2">
                        <div class="process-badge-modern" style="margin-bottom: 0;">
                            <i class="ri-archive-line"></i> ${pName}
                        </div>
                        <div class="process-badge-modern" style="margin-bottom: 0; background-color: #f1f5f9; color: #475569;">
                            <i class="ri-puzzle-line"></i> ${eName}
                        </div>
                    </div>
                    <button type="button" class="btn-remove-soft" onclick="removeElement('proc-block-${processCounter}')">
                        <i class="ri-delete-bin-line" style="font-size: 1.2rem;"></i>
                    </button>
                </div>
                
                <div id="ctrl-list-${processCounter}"></div>
                <button type="button" class="btn-add-ctrl-soft" onclick="addControlRow(${processCounter})">
                    <i class="ri-add-line"></i> Añadir Control
                </button>
            `;
            container.appendChild(div);
            
            // Only add control row if not skipping (normal user flow)
            if(!skipControlRow) {
                addControlRow(processCounter);
            }
            
            // Reset selection for next add (only if not called from save handler)
            if(!skipControlRow) {
                selectProc.value = "";
                selectElem.value = "";
            }
            
            return true;
        }

        function formatCompactValue(el) {
            if (el.value === '' || isNaN(el.value)) return;
            el.value = parseFloat(el.value).toFixed(2);
        }

        function addControlRow(pIdx) {
            const container = document.getElementById(`ctrl-list-${pIdx}`);
            const cRowId = Date.now() + Math.random();
            const row = document.createElement('div');
            row.className = 'control-row-compact animate__animated animate__fadeInLeft';
            row.id = `cr-${cRowId}`;
            row.innerHTML = `
                <div style="position: relative;">
                    <label class="control-label-mini">CONTROL</label>
                    <input type="text" class="form-control input-clean py-1 ctrl-search-input" 
                           placeholder="Busque control..." 
                           list="controles-datalist"
                           onkeydown="handleKeyNavigation(event, 'min', ${pIdx}, '${cRowId}')">
                </div>
                <div>
                     <button type="button" class="btn-add-mini" style="width: 32px; height: 32px;" onclick="openQuickAdd('control', '${cRowId}')"></button>
                </div>
                <div>
                    <label class="control-label-mini">TOL. MÍN</label>
                    <input type="number" step="0.01" class="form-control input-compact col-min" placeholder="0.00"
                           onblur="formatCompactValue(this)"
                           onkeydown="handleKeyNavigation(event, 'nom', ${pIdx}, '${cRowId}')">
                </div>
                <div>
                    <label class="control-label-mini">REFERENCIAL</label>
                    <input type="number" step="0.01" class="form-control input-compact col-nom" placeholder="15.00"
                           onblur="formatCompactValue(this)"
                           onkeydown="handleKeyNavigation(event, 'max', ${pIdx}, '${cRowId}')">
                </div>
                <div>
                    <label class="control-label-mini">TOL. MÁX</label>
                    <input type="number" step="0.01" class="form-control input-compact col-max" placeholder="0.00"
                           onblur="formatCompactValue(this)"
                           onkeydown="handleKeyNavigation(event, 'new', ${pIdx}, '${cRowId}')">
                </div>
                <button type="button" class="btn-remove-soft" onclick="removeElement('cr-${cRowId}')">
                    <i class="ri-close-line" style="font-size: 1.3rem;"></i>
                </button>
            `;
            container.appendChild(row);

            // Focus the search input of the new row
            setTimeout(() => {
                row.querySelector('.ctrl-search-input').focus();
            }, 50);
        }

        function handleKeyNavigation(event, target, pIdx, cRowId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const currentRow = document.getElementById(`cr-${cRowId}`);
                
                if (target === 'min') {
                    currentRow.querySelector('.col-min').focus();
                } else if (target === 'nom') {
                    formatCompactValue(currentRow.querySelector('.col-min'));
                    currentRow.querySelector('.col-nom').focus();
                } else if (target === 'max') {
                    formatCompactValue(currentRow.querySelector('.col-nom'));
                    currentRow.querySelector('.col-max').focus();
                } else if (target === 'new') {
                    formatCompactValue(currentRow.querySelector('.col-max'));
                    // Auto-add new row in the same process
                    addControlRow(pIdx);
                }
            }
        }

        function removeElement(id) {
            const el = document.getElementById(id);
            if(el) {
                el.classList.add('animate__fadeOut');
                setTimeout(() => {
                    el.remove();
                    if(document.querySelectorAll('.process-card-item').length === 0) showPlaceholder();
                }, 300);
            }
        }

        function showPlaceholder() {
            const container = document.getElementById('processes-container');
            container.innerHTML = `<div id="empty-state" class="empty-state-placeholder"><i class="ri-list-settings-line"></i><p>No hay procesos definidos en la estructura actual.</p></div>`;
        }

        // Quick Add Modal Logic
        let activeSelectRef = null;
        function openQuickAdd(type, refId = null) {
            activeSelectRef = refId;
            document.getElementById('currentModelType').value = type;
            const typeNames = { 'cliente': 'Cliente', 'proceso': 'Proceso', 'control': 'Control' };
            document.getElementById('modalTitle').innerText = 'Nuevo ' + typeNames[type];
            document.getElementById('newItemName').value = '';
            document.getElementById('quickAddModal').style.display = 'flex';
            document.getElementById('newItemName').focus();
        }

        function closeQuickAdd() { document.getElementById('quickAddModal').style.display = 'none'; }

        function saveNewItem() {
            const type = document.getElementById('currentModelType').value;
            const name = document.getElementById('newItemName').value;
            if(!name) return;
            
            const formData = new FormData();
            formData.append('nombre', name);
            fetch(`/api/create/${type}/`, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'}, body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    if(type === 'cliente') {
                        const sel = document.getElementById('header_cliente');
                        sel.add(new Option(data.nombre, data.id));
                        sel.value = data.id;
                    } else if(type === 'proceso') {
                        const sel = document.getElementById('sidebar_process_select');
                        sel.add(new Option(data.nombre, data.id));
                        sel.value = data.id;
                    } else if(type === 'elemento') {
                        const sel = document.getElementById('sidebar_element_select');
                        sel.add(new Option(data.nombre, data.id));
                        sel.value = data.id;
                    } else if(type === 'control') {
                        // Add to map and datalist
                        controlMap[data.nombre] = data.id;
                        const dl = document.getElementById('controles-datalist');
                        const opt = document.createElement('option');
                        opt.value = data.nombre;
                        dl.appendChild(opt);
                        
                        if(activeSelectRef) {
                            const target = document.querySelector(`#cr-${activeSelectRef} .ctrl-search-input`);
                            if(target) {
                                target.value = data.nombre;
                                target.focus();
                            }
                        }
                    }
                    closeQuickAdd();
                }
            });
        }

        document.getElementById('estructuraForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 1. Initial Header Validation
            const clienteInput = document.getElementById('header_cliente');
            const proyectoInput = document.getElementById('header_proyecto');
            const numOpInput = document.getElementById('header_num_op');
            
            const cliente = clienteInput.value;
            const proyecto = proyectoInput.value;
            const num_op = numOpInput.value;

            let missing = [];
            if(!cliente) missing.push("Cliente");
            if(!proyecto) missing.push("Proyecto");
            if(!num_op) missing.push("Número de OP");

            // Reset visual errors
            [clienteInput, proyectoInput, numOpInput].forEach(el => el.classList.remove('is-invalid'));

            if(missing.length > 0) {
                if(!cliente) clienteInput.classList.add('is-invalid');
                if(!proyecto) proyectoInput.classList.add('is-invalid');
                if(!num_op) numOpInput.classList.add('is-invalid');

                Swal.fire({
                    icon: 'warning',
                    title: 'Datos Faltantes',
                    html: `Por favor complete los siguientes campos obligatorios:<br><b>${missing.join(', ')}</b>`,
                    confirmButtonColor: '#3085d6',
                });
                return;
            }

            const structure = {
                cliente: cliente,
                proyecto: proyecto,
                num_op: num_op,
                procesos: []
            };

            // WARN IF USER FORGOT TO CLICK 'ADD' FOR SIDEBAR ITEMS
            const sideProc = document.getElementById('sidebar_process_select').value;
            const sideElem = document.getElementById('sidebar_element_select').value;
            
            const hasPendingSidebar = (sideProc && sideProc !== "") || (sideElem && sideElem !== "");
            
            if(document.querySelectorAll('.process-card-item').length === 0) {
                if(hasPendingSidebar) {
                    const result = await Swal.fire({
                        title: 'Ítem sin agregar',
                        text: "Tiene un proceso seleccionado en el panel lateral que no ha sido añadido a la lista.",
                        icon: 'question',
                        showDenyButton: true,
                        showCancelButton: true,
                        confirmButtonText: 'Agregar y Guardar',
                        denyButtonText: 'Guardar Vacío',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#10b981',
                        denyButtonColor: '#f59e0b',
                        cancelButtonColor: '#64748b'
                    });

                    if (result.isConfirmed) {
                        // Add the process WITHOUT auto-adding control row and WITHOUT clearing selects
                        const added = addProcessFromSidebar(true);
                        if(!added) {
                            Swal.fire('Error', 'No se pudo agregar el proceso', 'error');
                            return;
                        }
                        // Wait for DOM to update
                        await new Promise(resolve => setTimeout(resolve, 150));
                    } else if (result.isDenied) {
                        // Proceed empty
                    } else {
                        return;
                    }
                } else {
                     // Empty List Warning (No sidebar item selected)
                     const result = await Swal.fire({
                        title: '¿Guardar sin procesos?',
                        text: "No ha definido ningún proceso para esta estructura. Se guardarán solo los datos de cabecera.",
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonText: 'Guardar',
                        cancelButtonText: 'Cancelar'
                    });
                    if(!result.isConfirmed) return;
                }
            }

            // 3. Capture Process Blocks (Re-query to ensure we get any just-added items)
            const procBlocks = document.querySelectorAll('.process-card-item');
            
            console.log('=== DEBUG: Capturando bloques de proceso ===');
            console.log('Número de bloques encontrados:', procBlocks.length);
            
            procBlocks.forEach((block, index) => {
                const pId = block.getAttribute('data-proceso-id');
                const eId = block.getAttribute('data-elemento-id');
                
                console.log(`Bloque ${index}:`, {
                    proceso_id: pId,
                    elemento_id: eId
                });
                
                const pData = { id: pId, elemento_id: eId, controles: [] };

                block.querySelectorAll('.control-row-compact').forEach(row => {
                    const cName = row.querySelector('.ctrl-search-input').value;
                    const cId = controlMap[cName];
                    
                    if(!cId) return;
                    pData.controles.push({
                        id: cId,
                        min: row.querySelector('.col-min').value,
                        nom: row.querySelector('.col-nom').value,
                        max: row.querySelector('.col-max').value
                    });
                });

                console.log(`Datos del proceso ${index}:`, pData);
                structure.procesos.push(pData);
            });
            
            console.log('=== Estructura completa a enviar ===');
            console.log(JSON.stringify(structure, null, 2));

            // 4. Submit
            Swal.fire({ 
                title: 'Guardando...', 
                allowOutsideClick: false,
                html: 'Por favor espere',
                didOpen: () => {
                    Swal.showLoading();
                },
                customClass: {
                    popup: 'premium-swal',
                    title: 'premium-title',
                    htmlContainer: 'premium-text'
                }
            });

            const fd = new FormData();
            fd.append('estructura_data', JSON.stringify(structure));

            fetch('{% url "configurar_estructura" %}', { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'}, body: fd })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    Swal.fire({
                        title: '¡Éxito!',
                        text: data.message,
                        icon: 'success',
                        confirmButtonText: 'Aceptar'
                    }).then(() => {
                        window.location.href = data.redirect_url || "{% url 'lista_estructuras' %}";
                    });
                } else { 
                    Swal.fire('Error', data.message, 'error'); 
                }
            })
            .catch(error => {
                Swal.fire('Error', 'Error de conexión: ' + error, 'error');
            });
        });

        // Initialization Logic for Edit Mode
        window.addEventListener('DOMContentLoaded', (event) => {
            const container = document.getElementById('processes-container');
            if(!container) return;

            // Header loading
            const existingHeader = JSON.parse(document.getElementById('existing-data-json').textContent);
            if(existingHeader) {
                if(existingHeader.cliente_id) {
                     const cSel = document.getElementById('header_cliente');
                     cSel.value = existingHeader.cliente_id;
                     // Robust fallback if direct assignment failed (e.g. type mismatch)
                     if(!cSel.value) {
                         for(let i=0; i<cSel.options.length; i++) {
                             if(cSel.options[i].value == existingHeader.cliente_id) {
                                 cSel.selectedIndex = i;
                                 break;
                             }
                         }
                     }
                }
                if(existingHeader.proyecto) document.getElementById('header_proyecto').value = existingHeader.proyecto;
                if(existingHeader.num_op) document.getElementById('header_num_op').value = existingHeader.num_op;
                
                // Process loading
                if(existingHeader.procesos && existingHeader.procesos.length > 0) {
                     const empty = document.getElementById('empty-state');
                     if(empty) empty.remove();

                     existingHeader.procesos.forEach(p => {
                        processCounter++;
                        const currentPIdx = processCounter;
                        
                        const div = document.createElement('div');
                        div.className = 'process-card-item animate__animated animate__fadeInUp';
                        div.id = `proc-block-${currentPIdx}`;
                        div.setAttribute('data-proceso-id', p.id);
                        div.setAttribute('data-elemento-id', p.elemento_id || '');
                        
                        // Sanitize items for display
                        const pNameDisplay = p.nombre || 'Sin Proceso';
                        const eNameDisplay = p.elemento_nombre || '';

                        div.innerHTML = `
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="d-flex gap-2">
                                    <div class="process-badge-modern" style="margin-bottom: 0;">
                                        <i class="ri-archive-line"></i> ${pNameDisplay}
                                    </div>
                                    <div class="process-badge-modern" style="margin-bottom: 0; background-color: #f1f5f9; color: #475569;">
                                        <i class="ri-puzzle-line"></i> ${eNameDisplay}
                                    </div>
                                </div>
                                <button type="button" class="btn-remove-soft" onclick="removeElement('proc-block-${currentPIdx}')">
                                    <i class="ri-delete-bin-line" style="font-size: 1.2rem;"></i>
                                </button>
                            </div>
                            
                            <div id="ctrl-list-${currentPIdx}"></div>
                            <button type="button" class="btn-add-ctrl-soft" onclick="addControlRow(${currentPIdx})">
                                <i class="ri-add-line"></i> Añadir Control
                            </button>
                        `;
                        container.appendChild(div);
                        
                        const ctrlContainer = document.getElementById(`ctrl-list-${currentPIdx}`);
                        
                        if(p.controles && p.controles.length > 0) {
                            p.controles.forEach(c => {
                                const cRowId = Date.now() + Math.random();
                                const row = document.createElement('div');
                                row.className = 'control-row-compact';
                                row.id = `cr-${cRowId}`;
                                
                                const cValMin = (c.min !== null && c.min !== undefined && c.min !== '') ? parseFloat(c.min).toFixed(2) : '';
                                const cValNom = (c.nom !== null && c.nom !== undefined && c.nom !== '') ? parseFloat(c.nom).toFixed(2) : '';
                                const cValMax = (c.max !== null && c.max !== undefined && c.max !== '') ? parseFloat(c.max).toFixed(2) : '';
                                const cName = c.nombre || '';

                                row.innerHTML = `
                                    <div style="position: relative;">
                                        <label class="control-label-mini">CONTROL</label>
                                        <input type="text" class="form-control input-clean py-1 ctrl-search-input" 
                                               placeholder="Busque control..." 
                                               list="controles-datalist"
                                               value="${cName}"
                                               onkeydown="handleKeyNavigation(event, 'min', ${currentPIdx}, '${cRowId}')">
                                    </div>
                                    <div>
                                         <button type="button" class="btn-add-mini" style="width: 32px; height: 32px;" onclick="openQuickAdd('control', '${cRowId}')"></button>
                                    </div>
                                    <div>
                                        <label class="control-label-mini">TOL. MÍN</label>
                                        <input type="number" step="0.01" class="form-control input-compact col-min" placeholder="0.00"
                                               value="${cValMin}"
                                               onblur="formatCompactValue(this)"
                                               onkeydown="handleKeyNavigation(event, 'nom', ${currentPIdx}, '${cRowId}')">
                                    </div>
                                    <div>
                                        <label class="control-label-mini">REFERENCIAL</label>
                                        <input type="number" step="0.01" class="form-control input-compact col-nom" placeholder="15.00"
                                               value="${cValNom}"
                                               onblur="formatCompactValue(this)"
                                               onkeydown="handleKeyNavigation(event, 'max', ${currentPIdx}, '${cRowId}')">
                                    </div>
                                    <div>
                                        <label class="control-label-mini">TOL. MÁX</label>
                                        <input type="number" step="0.01" class="form-control input-compact col-max" placeholder="0.00"
                                               value="${cValMax}"
                                               onblur="formatCompactValue(this)"
                                               onkeydown="handleKeyNavigation(event, 'new', ${currentPIdx}, '${cRowId}')">
                                    </div>
                                    <button type="button" class="btn-remove-soft" onclick="removeElement('cr-${cRowId}')">
                                        <i class="ri-close-line" style="font-size: 1.3rem;"></i>
                                    </button>
                                `;
                                ctrlContainer.appendChild(row);
                            });
                        }
                     });
                }
            }
        });
    </script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
{% endblock %}
