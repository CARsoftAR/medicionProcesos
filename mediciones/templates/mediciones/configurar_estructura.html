{% extends 'mediciones/base.html' %}
{% load static %}

{% block title %}Configurar Estructura{% endblock %}

{% block topbar %}{% endblock %}

{% block content %}
{{ existing_data|json_script:"existing-data-json" }}
<div class="premium-page-container">
    <form id="estructuraForm">
        {% csrf_token %}
        <div class="row g-5">
            <!-- Left Panel: Sidebar Configurator (The "Builder") -->
            <div class="col-4">
                <div class="premium-panel-side">
                    <!-- Top Title Section -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center gap-3">
                            <a href="{% url 'lista_estructuras' %}" class="btn-back-simple">
                                <i class="ri-arrow-left-line"></i>
                            </a>
                            <div style="line-height: 1.2;">
                                <h1 class="side-title-main m-0" style="font-size: 1.3rem; color: var(--text-primary); font-weight: 800;">{{ titulo }}</h1>
                                <p class="side-subtitle-main m-0" style="font-size: 0.75rem; color: var(--text-muted);">Configure procesos y controles.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Datos Generales -->
                    <div class="config-card mb-4" style="border-top: 3px solid var(--primary);">
                        <div class="config-card-header text-primary py-2 px-3">
                            <i class="ri-settings-3-line"></i>
                            <span style="color: var(--primary);">DATOS GENERALES</span>
                        </div>
                        <div class="config-card-body p-4 pt-3">
                            <!-- Cliente -->
                            <div class="mb-4">
                                <label class="text-xxs fw-bold mb-2 d-block text-primary" style="letter-spacing: 0.05em; font-size: 0.65rem; color: var(--primary) !important;">CLIENTE</label>
                                <div class="d-flex gap-2">
                                    <select id="header_cliente" class="form-select input-clean form-select-sm" required>
                                        <option value="">Seleccione Cliente...</option>
                                        {% for c in clientes %}
                                        <option value="{{ c.id }}">{{ c.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn-add-mini" onclick="openQuickAdd('cliente')"></button>
                                </div>
                            </div>

                            <!-- Artículo -->
                            <div class="mb-4">
                                <label class="text-xxs fw-bold mb-2 d-block text-primary" style="letter-spacing: 0.05em; font-size: 0.65rem; color: var(--primary) !important;">ARTÍCULO</label>
                                <div class="d-flex gap-2">
                                    <select id="header_articulo" class="form-select input-clean form-select-sm">
                                        <option value="">Seleccione Artículo...</option>
                                        {% for a in articulos %}
                                        <option value="{{ a.id }}">{{ a.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn-add-mini" onclick="openQuickAdd('articulo')"></button>
                                </div>
                            </div>

                            <!-- Proyecto y OP -->
                            <div class="d-flex gap-4" style="margin-top: 2rem;">
                                <div style="flex: 1;">
                                    <label class="text-xxs fw-bold mb-2 d-block text-primary" style="letter-spacing: 0.05em; font-size: 0.65rem; color: var(--primary) !important;">PROYECTO</label>
                                    <input type="text" id="header_proyecto" class="form-control input-clean" placeholder="25-092" required 
                                           value="{{ existing_data.proyecto|default:'' }}">
                                </div>
                                <div style="flex: 1;">
                                    <label class="text-xxs fw-bold mb-2 d-block text-primary" style="letter-spacing: 0.05em; font-size: 0.65rem; color: var(--primary) !important;">NÚMERO OP</label>
                                    <input type="number" id="header_num_op" class="form-control input-clean" placeholder="4526" required
                                           value="{{ existing_data.num_op|default:'' }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Agregar Proceso Section -->
                    <div class="config-card mb-4 border-success-soft">
                        <div class="config-card-header text-success py-2 px-3">
                            <i class="ri-add-box-line"></i>
                            <span style="color: var(--success);">CONFIGURAR PROCESO</span>
                        </div>
                        <div class="config-card-body p-4 pt-3">
                            <div class="mb-3">
                                <label class="text-xxs fw-bold mb-2 d-block text-success" style="letter-spacing: 0.05em; font-size: 0.65rem; color: var(--success) !important;">PROCESO</label>
                                <div class="d-flex gap-2">
                                    <select id="sidebar_process_select" class="form-select input-clean form-select-sm">
                                        <option value="">Seleccione Proceso...</option>
                                        {% for p in procesos_list %}
                                        <option value="{{ p.id }}">{{ p.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn-add-mini" onclick="openQuickAdd('proceso')"></button>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="text-xxs fw-bold mb-2 d-block text-success" style="letter-spacing: 0.05em; font-size: 0.65rem; color: var(--success) !important;">ELEMENTO</label>
                                <div class="d-flex gap-2">
                                    <select id="sidebar_element_select" class="form-select input-clean form-select-sm">
                                        <option value="">Seleccione Elemento...</option>
                                        {% for e in elementos_list %}
                                        <option value="{{ e.id }}">{{ e.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn-add-mini" onclick="openQuickAdd('elemento')"></button>
                                </div>
                            </div>

                            <button type="button" class="btn btn-success w-100 py-3 shadow-sm d-flex align-items-center justify-content-center gap-2" style="font-weight: 800; border-radius: 12px; font-size: 0.9rem; background: var(--success); border: none; color: white;" onclick="addProcessFromSidebar()">
                                <i class="ri-add-circle-fill" style="font-size: 1.2rem;"></i> AGREGAR A LISTA
                            </button>
                        </div>
                    </div>

                    <!-- Save Action -->
                    <div class="action-panel-dark">
                        <button type="submit" class="btn-guardar-estructura w-100" style="margin-top: 0 !important; background: var(--primary); color: white;">
                            <i class="ri-check-line"></i> Guardar Estructura
                        </button>
                    </div>

                </div>
            </div>

            <!-- Right Panel: Main Hierarchy Display -->
            <div class="col-8">
                <div class="main-canvas-premium">
                    <div class="canvas-header">
                        <div class="d-flex align-items-center gap-2">
                            <div class="blue-line-indicator" style="background: var(--primary);"></div>
                            <h3 class="canvas-title">JERARQUÍA DE CONTROLES</h3>
                        </div>
                    </div>

                    <div id="processes-container" class="mt-4">
                        <!-- Empty State -->
                        <div id="empty-state" class="empty-state-placeholder">
                            <i class="ri-list-settings-line"></i>
                            <p>No hay procesos definidos en la estructura actual.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    :root {
        --primary-blue: #2563eb;
        --success-green: #10b981;
        --light-bg: #ffffff;
        --border-color: #e2e8f0;
        --text-muted: #64748b;
        --primary: var(--primary-blue);
        --success: var(--success-green);
        --bg-card: #ffffff;
        --text-primary: #0f172a;
        --text-secondary: #475569;
        --danger: #dc2626;
        --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }

    /* Force global container to fill screen and hide its scrollbar */
    .content-wrapper { height: 100vh !important; overflow: hidden !important; padding: 1.5rem !important; background-color: var(--light-bg); }
    .premium-page-container { padding: 0; width: 100%; max-width: 100%; margin: 0; }

    /* Left Sidebar Styling */
    .premium-panel-side { position: sticky; top: 0; display: flex; flex-direction: column; gap: 1rem; padding-right: 5px; }
    .premium-panel-side::-webkit-scrollbar { display: none; }
    
    .btn-back-simple { color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; text-decoration: none; display: flex; align-items: center; gap: 0.4rem; padding: 0.4rem 0.8rem; background: #f8fafc; border-radius: 8px; transition: 0.2s; border: 1px solid var(--border-color); width: fit-content; }
    .btn-back-simple:hover { background: #f1f5f9; color: var(--text-primary); }

    .side-title-main { font-size: 1.5rem; font-weight: 800; color: var(--text-primary); margin-top: 0.5rem; letter-spacing: -0.02em; }
    .side-subtitle-main { color: var(--text-muted); font-size: 0.8rem; margin-bottom: 1rem; }

    .config-card { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border-color); overflow: hidden; box-shadow: var(--card-shadow); }
    .config-card-header { padding: 1.25rem 1.5rem 0.75rem; display: flex; align-items: center; gap: 0.75rem; font-weight: 800; font-size: 0.8rem; letter-spacing: 0.05em; border-bottom: 1px solid #f1f5f9; background: #fcfdfe; }
    .config-card-body { padding: 1.5rem !important; }
    
    .border-success-soft { border: 1px solid rgba(16, 185, 129, 0.2) !important; border-top: 3px solid var(--success) !important; }

    .input-clean { background-color: #ffffff !important; border-radius: 10px !important; border: 1px solid var(--border-color) !important; padding: 0.4rem 0.75rem !important; font-size: 0.85rem !important; font-weight: 600 !important; color: var(--text-primary) !important; height: auto !important; }
    .input-clean:focus { background-color: #ffffff !important; border-color: var(--primary) !important; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1) !important; outline: none; }

    .btn-add-mini { background: #eff6ff; border: 1px solid #dbeafe; border-radius: 8px; width: 40px; height: 40px; flex-shrink: 0; position: relative; transition: all 0.2s; }
    .btn-add-mini::after { content: ''; width: 22px; height: 22px; background: var(--primary); mask: url('https://api.iconify.design/ri:add-line.svg') no-repeat center; -webkit-mask: url('https://api.iconify.design/ri:add-line.svg') no-repeat center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .btn-add-mini:hover { background: var(--primary); border-color: var(--primary); }
    .btn-add-mini:hover::after { background: white; }

    .btn-configurar-proceso { background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; border-radius: 10px; padding: 0.75rem; font-weight: 800; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: 0.2s; }
    .btn-configurar-proceso:hover { background: #2563eb; color: white; transform: translateY(-1px); }

    .action-panel-dark { background: #f8fafc; border-radius: 16px; padding: 1.5rem; color: var(--text-primary); margin-top: 1rem; border: 1px solid var(--border-color); }
    .btn-guardar-estructura { background: var(--primary); color: white; border: none; border-radius: 12px; padding: 1rem; font-weight: 800; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 0.6rem; transition: 0.3s; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2); }
    .btn-guardar-estructura:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(37, 99, 235, 0.3); }

    /* Right Canvas Styling */
    .main-canvas-premium { background: #f8fafc; border-radius: 20px; border: 1px solid var(--border-color); padding: 2.5rem; height: calc(100vh - 3rem); overflow-y: auto; box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.02); position: relative; }
    .main-canvas-premium::-webkit-scrollbar { width: 6px; }
    .main-canvas-premium::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .main-canvas-premium::-webkit-scrollbar-track { background: transparent; }
    .canvas-header { margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
    .blue-line-indicator { width: 4px; height: 20px; background: var(--primary-blue); border-radius: 4px; }
    .canvas-title { font-size: 1.1rem; font-weight: 800; color: var(--text-primary); margin: 0; letter-spacing: 0.02em; }

    /* Dynamic Process Block */
    .process-card-item { background: #ffffff; border-radius: 18px; border: 1px solid var(--border-color); padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
    .process-badge-modern { background: #eff6ff; color: #2563eb; padding: 0.5rem 1rem; border-radius: 10px; font-weight: 800; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 0.5rem; margin-bottom: 0; text-transform: uppercase; border: 1px solid #dbeafe; }
    
    /* Control Row Grid (Shrinked columns) */
    .control-row-compact { 
        display: grid; 
        grid-template-columns: 2fr auto 100px 100px 100px auto; 
        gap: 1rem; 
        background: #fcfdfe; 
        border: 1px solid #e2e8f0; 
        padding: 1rem; 
        border-radius: 12px; 
        margin-bottom: 0.75rem; 
        align-items: flex-end;
        transition: border-color 0.2s;
    }
    .control-row-compact:hover { border-color: #cbd5e1; }
    
    .control-label-mini { font-size: 0.65rem; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; display: block; letter-spacing: 0.1em; }
    .input-compact { background: #ffffff !important; border: 1px solid #e2e8f0 !important; color: #0f172a !important; padding: 0.5rem !important; font-size: 0.85rem !important; border-radius: 8px !important; text-align: center; font-weight: 600; }
    .input-compact:focus { background: #ffffff !important; border-color: var(--primary) !important; outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.05); }

    .btn-add-ctrl-soft { background: #ffffff; border: 1px dashed #cbd5e1; border-radius: 12px; padding: 0.85rem 1.5rem; font-size: 0.8rem; font-weight: 700; color: #64748b; margin-top: 1rem; transition: 0.2s; width: 100%; }
    .btn-add-ctrl-soft:hover { border-style: solid; border-color: var(--primary); color: var(--primary); background: #eff6ff; }

    .btn-remove-soft { color: #94a3b8; background: none; border: none; padding: 0.5rem; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: 0.2s; }
    .btn-remove-soft:hover { background: #fee2e2; color: #ef4444; }

    .empty-state-placeholder { text-align: center; padding: 8rem 2rem; color: #94a3b8; }
    .empty-state-placeholder i { font-size: 4rem; opacity: 0.2; margin-bottom: 1.5rem; display: block; }
    .empty-state-placeholder p { font-weight: 600; font-size: 1.1rem; opacity: 0.7; }

    .text-xxs { font-size: 0.65rem; }

    /* Quick Add Modal Overrides */
    #quickAddModal .card { background-color: #ffffff !important; border: 1px solid #e2e8f0 !important; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15) !important; }
    #quickAddModal h4 { color: #0f172a !important; }
    #quickAddModal input { background: #ffffff !important; border: 1px solid #e2e8f0 !important; color: #0f172a !important; font-weight: 600; }
    #quickAddModal .btn-light { background: #f1f5f9 !important; color: #475569 !important; border: 1px solid #e2e8f0 !important; }
    #quickAddModal .btn-light:hover { background: #e2e8f0 !important; }
    #quickAddModal .btn-primary { background: var(--primary) !important; border: none !important; }
    #quickAddModal .btn-primary:hover { transform: translateY(-1px); }

</style>

<!-- Quick Add Modal -->
<div id="quickAddModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px); z-index: 9999; justify-content: center; align-items: center;">
    <div class="card" style="width: 380px; padding: 2rem; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.15);">
        <h4 id="modalTitle" class="mb-3" style="font-weight: 800; color: #0f172a;">Agregar Nuevo</h4>
        <input type="text" id="newItemName" class="form-control mb-4" placeholder="Nombre..." style="border-radius: 10px; padding: 0.75rem;">
        <input type="hidden" id="currentModelType">
        <div class="d-flex justify-content-end gap-2">
            <button type="button" onclick="closeQuickAdd()" class="btn btn-light" style="border-radius: 8px; font-weight: 600;">Cerrar</button>
            <button type="button" onclick="saveNewItem()" class="btn btn-primary" style="border-radius: 8px; font-weight: 700;">Guardar</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <datalist id="controles-datalist">
        {% for c in controles_list %}<option value="{{ c.nombre }}" data-id="{{ c.id }}">{% endfor %}
    </datalist>

    <script>
        const controlMap = { {% for c in controles_list %}"{{ c.nombre|escapejs }}": "{{ c.id }}",{% endfor %} };
        let processCounter = 0;

        function addProcessFromSidebar(skipControlRow = false) {
            const selectProc = document.getElementById('sidebar_process_select');
            const selectElem = document.getElementById('sidebar_element_select');
            const pId = selectProc.value;
            const eId = selectElem.value;
            if(!pId || !eId) {
                Swal.fire({ toast: true, position: 'top', icon: 'info', title: 'Seleccione Proceso y Elemento', showConfirmButton: false, timer: 2000 });
                return false;
            }
            const pName = selectProc.options[selectProc.selectedIndex].text;
            const eName = selectElem.options[selectElem.selectedIndex].text;
            document.getElementById('empty-state')?.remove();
            processCounter++;
            const container = document.getElementById('processes-container');
            const div = document.createElement('div');
            div.className = 'process-card-item animate__animated animate__fadeInUp';
            div.id = `proc-block-${processCounter}`;
            div.setAttribute('data-proceso-id', pId);
            div.setAttribute('data-elemento-id', eId);
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="d-flex gap-2">
                        <div class="process-badge-modern"><i class="ri-archive-line"></i> ${pName}</div>
                        <div class="process-badge-modern" style="background-color: #f1f5f9; color: var(--text-secondary); border: 1px solid #e2e8f0;"><i class="ri-puzzle-line"></i> ${eName}</div>
                    </div>
                    <button type="button" class="btn-remove-soft" onclick="removeElement('proc-block-${processCounter}')"><i class="ri-delete-bin-line" style="font-size: 1.2rem;"></i></button>
                </div>
                <div id="ctrl-list-${processCounter}"></div>
                <button type="button" class="btn-add-ctrl-soft" onclick="addControlRow(${processCounter})"><i class="ri-add-line"></i> Añadir Control</button>
            `;
            container.appendChild(div);
            if(!skipControlRow) addControlRow(processCounter);
            if(!skipControlRow) { selectProc.value = ""; selectElem.value = ""; }
            return true;
        }



        function addControlRow(pIdx) {
            const container = document.getElementById(`ctrl-list-${pIdx}`);
            const cRowId = Date.now() + Math.random();
            const row = document.createElement('div');
            row.className = 'control-row-compact animate__animated animate__fadeInLeft';
            row.id = `cr-${cRowId}`;
            row.innerHTML = `
                <div style="position: relative;"><label class="control-label-mini">CONTROL</label><input type="text" class="form-control input-clean py-1 ctrl-search-input" list="controles-datalist" onkeydown="handleKeyNavigation(event, 'min', ${pIdx}, '${cRowId}')"></div>
                <div><button type="button" class="btn-add-mini" style="width: 32px; height: 32px;" onclick="openQuickAdd('control', '${cRowId}')"></button></div>
                <div><label class="control-label-mini">TOL. MÍN</label><input type="number" step="0.001" class="form-control input-compact col-min" onkeydown="handleKeyNavigation(event, 'nom', ${pIdx}, '${cRowId}')"></div>
                <div><label class="control-label-mini">REFERENCIAL</label><input type="number" step="0.001" class="form-control input-compact col-nom" onkeydown="handleKeyNavigation(event, 'max', ${pIdx}, '${cRowId}')"></div>
                <div><label class="control-label-mini">TOL. MÁX</label><input type="number" step="0.001" class="form-control input-compact col-max" onkeydown="handleKeyNavigation(event, 'new', ${pIdx}, '${cRowId}')"></div>
                <button type="button" class="btn-remove-soft" onclick="removeElement('cr-${cRowId}')"><i class="ri-close-line" style="font-size: 1.3rem;"></i></button>
            `;
            container.appendChild(row);
            setTimeout(() => row.querySelector('.ctrl-search-input').focus(), 50);
        }

        function handleKeyNavigation(event, target, pIdx, cRowId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const cur = document.getElementById(`cr-${cRowId}`);
                if (target === 'min') cur.querySelector('.col-min').focus();
                else if (target === 'nom') { cur.querySelector('.col-nom').focus(); }
                else if (target === 'max') { cur.querySelector('.col-max').focus(); }
                else if (target === 'new') { addControlRow(pIdx); }
            }
        }

        function removeElement(id) {
            const el = document.getElementById(id);
            if(el) { el.classList.add('animate__fadeOut'); setTimeout(() => { el.remove(); if(document.querySelectorAll('.process-card-item').length === 0) showPlaceholder(); }, 300); }
        }

        function showPlaceholder() {
            document.getElementById('processes-container').innerHTML = `<div id="empty-state" class="empty-state-placeholder"><i class="ri-list-settings-line"></i><p>No hay procesos definidos en la estructura actual.</p></div>`;
        }

        let activeSelectRef = null;
        function openQuickAdd(type, refId = null) {
            activeSelectRef = refId;
            document.getElementById('currentModelType').value = type;
            const typeNames = { 'cliente': 'Cliente', 'proceso': 'Proceso', 'control': 'Control', 'articulo': 'Artículo' };
            document.getElementById('modalTitle').innerText = 'Nuevo ' + typeNames[type];
            document.getElementById('newItemName').value = '';
            document.getElementById('quickAddModal').style.display = 'flex';
            document.getElementById('newItemName').focus();
        }

        function closeQuickAdd() { document.getElementById('quickAddModal').style.display = 'none'; }

        function saveNewItem() {
            const type = document.getElementById('currentModelType').value;
            const name = document.getElementById('newItemName').value;
            if(!name) return;
            const formData = new FormData(); formData.append('nombre', name);
            fetch(`/api/create/${type}/`, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'}, body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    if(type === 'cliente') { const sel = document.getElementById('header_cliente'); sel.add(new Option(data.nombre, data.id)); sel.value = data.id; }
                    else if(type === 'proceso') { const sel = document.getElementById('sidebar_process_select'); sel.add(new Option(data.nombre, data.id)); sel.value = data.id; }
                    else if(type === 'elemento') { const sel = document.getElementById('sidebar_element_select'); sel.add(new Option(data.nombre, data.id)); sel.value = data.id; }
                    else if(type === 'control') { 
                        controlMap[data.nombre] = data.id; 
                        const dl = document.getElementById('controles-datalist'); 
                        const opt = document.createElement('option'); 
                        opt.value = data.nombre; 
                        dl.appendChild(opt); 
                        if(activeSelectRef) { 
                            const row = document.getElementById(`cr-${activeSelectRef}`);
                            if(row) {
                                const target = row.querySelector('.ctrl-search-input');
                                if(target) { target.value = data.nombre; target.focus(); } 
                            }
                        } 
                    }
                    else if(type === 'articulo') { const sel = document.getElementById('header_articulo'); sel.add(new Option(data.nombre, data.id)); sel.value = data.id; }
                    closeQuickAdd();
                    Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Guardado correctamente', showConfirmButton: false, timer: 1500 });
                } else {
                    Swal.fire({ icon: 'error', title: 'Error', text: data.message || 'No se pudo guardar el registro' });
                }
            }).catch(err => {
                Swal.fire({ icon: 'error', title: 'Error de Red', text: 'No se pudo conectar con el servidor' });
            });
        }

        document.getElementById('estructuraForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const cliente = document.getElementById('header_cliente').value;
            const proyecto = document.getElementById('header_proyecto').value;
            const articulo = document.getElementById('header_articulo').value;
            const num_op = document.getElementById('header_num_op').value;
            if(!cliente || !proyecto || !num_op) { Swal.fire({ icon: 'warning', title: 'Datos Faltantes', text: 'Complete los campos obligatorios.' }); return; }
            const structure = { cliente, proyecto, articulo, num_op, procesos: [] };
            const procBlocks = document.querySelectorAll('.process-card-item');
            procBlocks.forEach(block => {
                const pData = { id: block.getAttribute('data-proceso-id'), elemento_id: block.getAttribute('data-elemento-id'), controles: [] };
                block.querySelectorAll('.control-row-compact').forEach(row => {
                    const cId = controlMap[row.querySelector('.ctrl-search-input').value];
                    if(cId) pData.controles.push({ id: cId, min: row.querySelector('.col-min').value, nom: row.querySelector('.col-nom').value, max: row.querySelector('.col-max').value });
                });
                structure.procesos.push(pData);
            });
            Swal.fire({ title: 'Guardando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            const fd = new FormData(); fd.append('estructura_data', JSON.stringify(structure));
            fetch('{% url "configurar_estructura" %}', { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'}, body: fd })
            .then(res => res.json()).then(data => { if(data.status === 'success') window.location.href = "{% url 'lista_estructuras' %}"; else Swal.fire('Error', data.message, 'error'); });
        });

        window.addEventListener('DOMContentLoaded', () => {
            const data = JSON.parse(document.getElementById('existing-data-json').textContent);
            if(data) {
                if(data.cliente_id) document.getElementById('header_cliente').value = data.cliente_id;
                if(data.proyecto) document.getElementById('header_proyecto').value = data.proyecto;
                if(data.articulo_id) document.getElementById('header_articulo').value = data.articulo_id;
                if(data.num_op) document.getElementById('header_num_op').value = data.num_op;
                data.procesos?.forEach(p => {
                    processCounter++; const currentIdx = processCounter;
                    const container = document.getElementById('processes-container');
                    document.getElementById('empty-state')?.remove();
                    const div = document.createElement('div');
                    div.className = 'process-card-item'; div.id = `proc-block-${currentIdx}`;
                    div.setAttribute('data-proceso-id', p.id); div.setAttribute('data-elemento-id', p.elemento_id || '');
                    div.innerHTML = `
                        <div class="d-flex justify-content-between mb-3"><div class="d-flex gap-2">
                            <div class="process-badge-modern"><i class="ri-archive-line"></i> ${p.nombre || 'Sin Proceso'}</div>
                            <div class="process-badge-modern" style="background-color: #f1f5f9; color: var(--text-secondary); border: 1px solid #e2e8f0;"><i class="ri-puzzle-line"></i> ${p.elemento_nombre || ''}</div>
                        </div><button type="button" class="btn-remove-soft" onclick="removeElement('proc-block-${currentIdx}')"><i class="ri-delete-bin-line"></i></button></div>
                        <div id="ctrl-list-${currentIdx}"></div>
                        <button type="button" class="btn-add-ctrl-soft" onclick="addControlRow(${currentIdx})"><i class="ri-add-line"></i> Añadir Control</button>
                    `;
                    container.appendChild(div);
                    p.controles?.forEach(c => {
                        const rowId = Date.now() + Math.random();
                        const row = document.createElement('div'); row.className = 'control-row-compact'; row.id = `cr-${rowId}`;
                        row.innerHTML = `
                            <div style="position: relative;"><label class="control-label-mini">CONTROL</label><input type="text" class="form-control input-clean py-1 ctrl-search-input" list="controles-datalist" value="${c.nombre || ''}" onkeydown="handleKeyNavigation(event, 'min', ${currentIdx}, '${rowId}')"></div>
                            <div><button type="button" class="btn-add-mini" style="width: 32px; height: 32px;" onclick="openQuickAdd('control', '${rowId}')"></button></div>
                            <div><label class="control-label-mini">TOL. MÍN</label><input type="number" step="0.001" class="form-control input-compact col-min" value="${(c.min !== null && c.min !== '') ? parseFloat(c.min).toFixed(3) : ''}" onkeydown="handleKeyNavigation(event, 'nom', ${currentIdx}, '${rowId}')"></div>
                            <div><label class="control-label-mini">REFERENCIAL</label><input type="number" step="0.001" class="form-control input-compact col-nom" value="${(c.nom !== null && c.nom !== '') ? parseFloat(c.nom).toFixed(3) : ''}" onkeydown="handleKeyNavigation(event, 'max', ${currentIdx}, '${rowId}')"></div>
                            <div><label class="control-label-mini">TOL. MÁX</label><input type="number" step="0.001" class="form-control input-compact col-max" value="${(c.max !== null && c.max !== '') ? parseFloat(c.max).toFixed(3) : ''}" onkeydown="handleKeyNavigation(event, 'new', ${currentIdx}, '${rowId}')"></div>
                            <button type="button" class="btn-remove-soft" onclick="removeElement('cr-${rowId}')"><i class="ri-close-line"></i></button>
                        `;
                        document.getElementById(`ctrl-list-${currentIdx}`).appendChild(row);
                    });
                });
            }
        });
    </script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
{% endblock %}
